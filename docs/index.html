<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BO Inteligente - Tr√°fico de Drogas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Anima√ß√µes suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Scrollbar customizada */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        /* Bot√µes de feedback */
        .feedback-btn {
            min-width: 40px;
            min-height: 40px;
            font-size: 18px;
            padding: 6px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feedback-btn:hover {
            transform: scale(1.1);
            border-color: #3b82f6;
        }
        
        .feedback-btn:active {
            transform: scale(0.95);
        }
        
        .feedback-btn.clicked {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Mobile: Sidebar colaps√°vel */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease;
            }

            #sidebar.open {
                left: 0;
            }

            #sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            #sidebar-overlay.open {
                display: block;
            }

            .feedback-btn {
                min-width: 56px;
                min-height: 56px;
                font-size: 24px;
            }

            /* Container de textos gerados: sections collapsed por padr√£o em mobile */
            #generated-sections-container details {
                margin-bottom: 0.5rem;
            }

            #generated-sections-container details[open] summary {
                border-bottom: 1px solid #e5e7eb;
            }
        }

        /* Modal de rascunho */
        .draft-modal {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Badges de step em mobile - font menor */
        @media (max-width: 768px) {
            #questions-list [id^="icon-"] {
                font-size: 0.65rem;
                width: 2rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-900 text-white p-4 shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">üìã BO Inteligente v0.12.8</h1>
                    <p class="text-blue-200 text-sm">Se√ß√£o 1 - Contexto da Ocorr√™ncia</p>
                </div>
                <!-- Bot√£o mobile para abrir sidebar -->
                <button id="sidebar-toggle" class="md:hidden bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                    üìù Progresso
                </button>
            </div>
        </header>

        <!-- Overlay para mobile -->
        <div id="sidebar-overlay"></div>

        <!-- Modal de Rascunho Encontrado -->
        <div id="draft-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="draft-modal bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">üìÑ</div>
                    <h2 class="text-xl font-bold text-gray-800">Rascunho Encontrado!</h2>
                    <p class="text-gray-600 mt-2">Voc√™ tem um BO em andamento. Deseja continuar de onde parou?</p>
                </div>
                
                <div id="draft-preview" class="bg-gray-50 rounded-lg p-3 mb-4 text-sm text-gray-600">
                    <!-- Preview do rascunho ser√° inserido aqui -->
                </div>
                
                <div class="flex gap-3">
                    <button id="draft-continue" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        ‚úÖ Continuar
                    </button>
                    <button id="draft-discard" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-semibold transition-colors">
                        üóëÔ∏è Come√ßar Novo
                    </button>
                </div>
                
                <p class="text-xs text-gray-400 text-center mt-3">
                    O rascunho √© salvo automaticamente a cada resposta
                </p>
            </div>
        </div>

        <!-- Main Content com Sidebar -->
        <main class="flex-1 max-w-7xl w-full mx-auto p-4 flex gap-4">
            <!-- Sidebar - Hist√≥rico de Perguntas -->
            <aside id="sidebar" class="w-80 bg-white rounded-lg shadow-lg p-4 flex-shrink-0 md:block">
                <div class="mb-4 pb-4 border-b border-gray-200">
                    <h2 class="font-bold text-lg text-gray-800 mb-2">üìù Se√ß√£o 1 - Contexto da Ocorr√™ncia</h2>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Progresso</span>
                        <span id="sidebar-progress-text" class="font-semibold text-blue-600">0/6</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="sidebar-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Lista de Perguntas -->
                <div id="questions-list" class="space-y-3">
                    <!-- Perguntas ser√£o inseridas aqui via JS -->
                </div>

                <!-- Indicador de salvamento autom√°tico -->
                <div id="autosave-indicator" class="mt-4 text-xs text-gray-400 text-center hidden">
                    üíæ Rascunho salvo automaticamente
                </div>

                <!-- Bot√£o fechar (apenas mobile) -->
                <button id="sidebar-close" class="md:hidden mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition-colors">
                    ‚úï Fechar
                </button>
            </aside>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col min-w-0">
                <!-- Chat Messages -->
                <div id="chat-container" class="flex-1 bg-white rounded-lg shadow overflow-y-auto p-4 mb-4 space-y-4" style="min-height: 400px; max-height: 500px;">
                    <!-- Mensagens aparecer√£o aqui -->
                </div>

                <!-- Input Area -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="user-input" 
                            placeholder="Digite sua resposta aqui..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            disabled
                        >
                        <button 
                            id="send-button"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                            disabled
                        >
                            Enviar
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Pressione Enter para enviar
                    </div>
                </div>

                <!-- Container Persistente de Textos Gerados (Todas Se√ß√µes) -->
                <div id="generated-sections-container" class="mt-4 hidden">
                    <h3 class="font-bold text-gray-700 mb-3">üìÑ Textos Gerados do BO</h3>

                    <!-- Se√ß√£o 1 - Contexto da Ocorr√™ncia -->
                    <details id="section1-card" class="mb-2 border border-green-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-green-50 p-3 font-semibold text-green-900 rounded-t-lg hover:bg-green-100 transition-colors">
                            üìù Se√ß√£o 1 - Contexto da Ocorr√™ncia
                        </summary>
                        <div class="bg-white p-4 border-t border-green-200">
                            <pre id="section1-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(1)"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 1
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 2 - Abordagem a Ve√≠culo -->
                    <details id="section2-card" class="mb-2 border border-blue-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-blue-50 p-3 font-semibold text-blue-900 rounded-t-lg hover:bg-blue-100 transition-colors">
                            üöó Se√ß√£o 2 - Abordagem a Ve√≠culo
                        </summary>
                        <div class="bg-white p-4 border-t border-blue-200">
                            <pre id="section2-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(2)"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 2
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 3 - Campana (Vigil√¢ncia Velada) -->
                    <details id="section3-card" class="mb-2 border border-purple-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-purple-50 p-3 font-semibold text-purple-900 rounded-t-lg hover:bg-purple-100 transition-colors">
                            üëÅÔ∏è Se√ß√£o 3 - Campana
                        </summary>
                        <div class="bg-white p-4 border-t border-purple-200">
                            <pre id="section3-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(3)"
                                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 3
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 4 - Entrada em Domic√≠lio -->
                    <details id="section4-card" class="mb-2 border border-orange-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-orange-50 p-3 font-semibold text-orange-900 rounded-t-lg hover:bg-orange-100 transition-colors">
                            üè† Se√ß√£o 4 - Entrada em Domic√≠lio
                        </summary>
                        <div class="bg-white p-4 border-t border-orange-200">
                            <pre id="section4-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(4)"
                                class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 4
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 5 - Fundada Suspeita -->
                    <details id="section5-card" class="mb-2 border border-pink-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-pink-50 p-3 font-semibold text-pink-900 rounded-t-lg hover:bg-pink-100 transition-colors">
                            üéØ Se√ß√£o 5 - Fundada Suspeita
                        </summary>
                        <div class="bg-white p-4 border-t border-pink-200">
                            <pre id="section5-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(5)"
                                class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 5
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa -->
                    <details id="section6-card" class="mb-2 border border-teal-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-teal-50 p-3 font-semibold text-teal-900 rounded-t-lg hover:bg-teal-100 transition-colors">
                            üí™ Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa
                        </summary>
                        <div class="bg-white p-4 border-t border-teal-200">
                            <pre id="section6-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(6)"
                                class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 6
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia -->
                    <details id="section7-card" class="mb-2 border border-amber-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-amber-50 p-3 font-semibold text-amber-900 rounded-t-lg hover:bg-amber-100 transition-colors">
                            üì¶ Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia
                        </summary>
                        <div class="bg-white p-4 border-t border-amber-200">
                            <pre id="section7-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(7)"
                                class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 7
                            </button>
                        </div>
                    </details>

                    <!-- Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL) -->
                    <details id="section8-card" class="mb-2 border border-indigo-200 rounded-lg hidden" open>
                        <summary class="cursor-pointer bg-indigo-50 p-3 font-semibold text-indigo-900 rounded-t-lg hover:bg-indigo-100 transition-colors">
                            ‚öñÔ∏è Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL)
                        </summary>
                        <div class="bg-white p-4 border-t border-indigo-200">
                            <pre id="section8-text" class="whitespace-pre-wrap text-sm text-gray-800 mb-3"></pre>
                            <button
                                onclick="copySection(8)"
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                üìã Copiar Se√ß√£o 8
                            </button>
                        </div>
                    </details>

                    <!-- Bot√£o para copiar BO completo -->
                    <button
                        onclick="copyAllSections()"
                        id="copy-all-button"
                        class="w-full mt-2 py-2 bg-gray-800 hover:bg-gray-900 text-white font-semibold rounded-lg transition-colors hidden">
                        üìë Copiar BO Completo (Todas Se√ß√µes)
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 border-t border-gray-200 p-4 text-center text-sm text-gray-600">
            <p>BO Inteligente v0.12.8 | üíæ Rascunho salvo automaticamente</p>
        </footer>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8000'
            : 'https://bo-assistant-backend.onrender.com';
        
        // Chave do localStorage
        const DRAFT_STORAGE_KEY = 'bo_inteligente_draft';
        
        // Perguntas da Se√ß√£o 1
        const SECTION1_QUESTIONS = {
            '1.1': 'Dia, data e hora do acionamento.',
            '1.2': 'Composi√ß√£o da guarni√ß√£o e prefixo.',
            '1.3': 'Natureza do empenho.',
            '1.4': 'O que constava na ordem de servi√ßo, informa√ß√µes do COPOM, DDU.',
            '1.5': 'Local exato da ocorr√™ncia (logradouro, n√∫mero, bairro).',
            '1.6': 'O local √© ponto de tr√°fico? Quais evid√™ncias anteriores? H√° fac√ß√£o?',
            '1.7': 'O local √© pr√≥ximo a escola, hospital ou transporte p√∫blico? Qual estabelecimento e a que dist√¢ncia aproximada?'
        };

        // Perguntas da Se√ß√£o 2 (Abordagem a Ve√≠culo)
        const SECTION2_QUESTIONS = {
            '2.1': 'Havia ve√≠culo envolvido na ocorr√™ncia?',
            '2.2': 'Qual a marca, modelo, cor e placa do ve√≠culo?',
            '2.3': 'Onde e em que contexto o ve√≠culo foi visto? (local + situa√ß√£o)',
            '2.4': 'Qual policial percebeu primeiro? De onde viu e o que exatamente observou? (gradua√ß√£o + nome)',
            '2.5': 'Como foi dada a ordem de parada? (sirene, megafone, sinal manual)',
            '2.6': 'O ve√≠culo parou imediatamente ou houve persegui√ß√£o? Se houve, descreva o trajeto.',
            '2.7': 'Como foi realizada a abordagem dos ocupantes? (quem abordou, quantos ocupantes, posicionamento)',
            '2.8': 'Quem realizou a busca pessoal nos ocupantes? (gradua√ß√£o + nome)',
            '2.9': 'Quem realizou a busca no ve√≠culo e em quais partes? (gradua√ß√£o + nome + locais vistoriados)',
            '2.10': 'O que foi localizado, com quem estava e em qual parte do ve√≠culo?',
            '2.11': 'O ve√≠culo apresentava irregularidades? (furto, roubo, clonagem, adultera√ß√£o)'
        };

        // Perguntas da Se√ß√£o 3 (Campana - Vigil√¢ncia Velada)
        const SECTION3_QUESTIONS = {
            '3.1': 'A equipe realizou campana (vigil√¢ncia velada)?',
            '3.2': 'Local exato da campana, ponto de observa√ß√£o e dist√¢ncia aproximada at√© o alvo.',
            '3.3': 'Quem tinha vis√£o direta e o que cada um conseguia ver? (gradua√ß√£o + nome)',
            '3.4': 'O que motivou a campana? (den√∫ncia, intelig√™ncia, hist√≥rico do local)',
            '3.5': 'Qual foi a dura√ß√£o da campana? (tempo aproximado e se foi cont√≠nua ou alternada)',
            '3.6': 'O que foi visto durante a campana? (entregas, usu√°rios, esconderijos)',
            '3.7': 'Houve abordagem de usu√°rio? O que portava? O que disse?',
            '3.8': 'Houve fuga? Como ocorreu?'
        };

        // Perguntas da Se√ß√£o 4 (Entrada em Domic√≠lio)
        const SECTION4_QUESTIONS = {
            '4.1': 'Houve entrada em domic√≠lio?',
            '4.2': 'O que foi visto/ouvido ANTES do ingresso?',
            '4.3': 'Quem viu e o qu√™? (gradua√ß√£o + nome)',
            '4.4': 'Como ocorreu o ingresso? (autoriza√ß√£o, persegui√ß√£o, droga √† vista)',
            '4.5': 'Quais policiais entraram? Quem fez o qu√™?'
        };

        const SECTION5_QUESTIONS = {
            '5.1': 'O que a equipe viu ao chegar no local?',
            '5.2': 'Quem viu, de onde, e o que exatamente?',
            '5.3': 'Descrever apar√™ncia e a√ß√µes dos abordados.'
        };

        const SECTION6_QUESTIONS = {
            '6.1': 'Houve amea√ßa ou uso de arma? Contra quem e como?',
            '6.2': 'Houve resist√™ncia durante a abordagem?',
            '6.3': 'Descreva a resist√™ncia com fatos concretos (ex.: empurr√£o, fuga, soco)',
            '6.4': 'Qual t√©cnica foi aplicada e qual foi o resultado?',
            '6.5': 'Por que foi necess√°rio algemar? (risco de fuga, agressividade)',
            '6.6': 'Houve ferimentos? Descreva: quem, tipo, local de atendimento.'
        };

        const SECTION7_QUESTIONS = {
            '7.1': 'Houve apreens√£o de drogas?',
            '7.2': 'Descreva as subst√¢ncias apreendidas: tipo, quantidade exata, embalagem, local onde foi encontrado e quem encontrou (gradua√ß√£o + nome)',
            '7.3': 'Quais objetos ligados ao tr√°fico foram apreendidos? (dinheiro, celulares, balan√ßa, armas, cadernos)',
            '7.4': 'Como foi o acondicionamento e guarda? (como lacrou, quem ficou respons√°vel e destino do material)'
        };

        const SECTION8_QUESTIONS = {
            '8.1': 'Quem deu voz de pris√£o e por qual crime? (gradua√ß√£o + nome + artigo)',
            '8.2': 'Onde e como o preso foi transportado at√© a delegacia?',
            '8.3': 'O preso declarou algo? (transcri√ß√£o literal ou "permaneceu em sil√™ncio")',
            '8.4': 'Qual era a fun√ß√£o do preso no tr√°fico? (vapor, gerente, olheiro, etc.)',
            '8.5': 'O preso possui passagens anteriores? (informar REDS se houver)',
            '8.6': 'H√° sinais de dedica√ß√£o ao crime? O que mostra isso?',
            '8.7': 'O preso tem papel relevante na fac√ß√£o? Atua√ß√£o ocasional ou cont√≠nua?',
            '8.8': 'Houve tentativa de destruir ou ocultar provas, ou intimidar algu√©m?',
            '8.9': 'Havia menor de idade envolvido na ocorr√™ncia? Se sim, idade e participa√ß√£o?',
            '8.10': 'Quem informou as garantias constitucionais ao preso? (gradua√ß√£o + nome)',
            '8.11': 'Qual o destino dos presos e dos materiais apreendidos? (delegacia, CEFLAN, etc.)'
        };

        // Manter compatibilidade com c√≥digo existente (Se√ß√£o 1)
        const QUESTIONS = SECTION1_QUESTIONS;

        // Estado da aplica√ß√£o
        let sessionId = null;
        let currentBoId = null;
        let isWaitingResponse = false;
        let currentQuestionStep = '1.1';
        let currentSection = 1; // Nova vari√°vel para controlar se√ß√£o atual
        let answersState = {}; // Para armazenar respostas localmente
        let boCompleted = false; // Flag para indicar se BO foi completado

        // Elementos DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const generatedSectionsContainer = document.getElementById('generated-sections-container');
        
        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const questionsList = document.getElementById('questions-list');
        const sidebarProgressBar = document.getElementById('sidebar-progress-bar');
        const sidebarProgressText = document.getElementById('sidebar-progress-text');
        const autosaveIndicator = document.getElementById('autosave-indicator');
        
        // Draft modal elements
        const draftModal = document.getElementById('draft-modal');
        const draftPreview = document.getElementById('draft-preview');
        const draftContinueBtn = document.getElementById('draft-continue');
        const draftDiscardBtn = document.getElementById('draft-discard');

        // ================================================================
        // FUN√á√ïES DE RASCUNHO (localStorage)
        // ================================================================

        function migrateOldDraftIDs(answers) {
            /**
             * Migra IDs antigos (2.0-2.7) para novos (2.1-2.8)
             * Garante compatibilidade com rascunhos v0.6.3
             */
            const migrated = {};
            const migrationMap = {
                '2.0': '2.1',
                '2.1': '2.2',
                '2.2': '2.3',
                '2.3': '2.4',
                '2.4': '2.5',
                '2.5': '2.6',
                '2.6': '2.7',
                '2.7': '2.8'
            };

            for (const [step, answer] of Object.entries(answers)) {
                const newStep = migrationMap[step] || step;
                migrated[newStep] = answer;
            }

            return migrated;
        }

        function saveDraft() {
            /**
             * Salva o estado atual no localStorage
             * v0.9.0: Agora salva chatHistory + generatedTexts + sectionStatuses + suporte a 5 se√ß√µes
             */
            // Capturar chatHistory completo
            const chatMessages = [];
            const messageContainers = chatContainer.querySelectorAll('.message-container');

            messageContainers.forEach(msgDiv => {
                const isBot = msgDiv.classList.contains('justify-start');
                const step = msgDiv.dataset.step || null;
                const eventId = msgDiv.dataset.eventId || null;
                const text = msgDiv.dataset.currentText || msgDiv.querySelector('span')?.textContent || '';

                chatMessages.push({
                    text: text,
                    isBot: isBot,
                    step: step,
                    eventId: eventId,
                    timestamp: new Date().toISOString()
                });
            });

            // Capturar textos gerados
            const generatedTexts = {};
            if (document.getElementById('section1-text')?.textContent) {
                generatedTexts['section1'] = document.getElementById('section1-text').textContent;
            }
            if (document.getElementById('section2-text')?.textContent) {
                generatedTexts['section2'] = document.getElementById('section2-text').textContent;
            }
            if (document.getElementById('section3-text')?.textContent) {
                generatedTexts['section3'] = document.getElementById('section3-text').textContent;
            }
            if (document.getElementById('section4-text')?.textContent) {
                generatedTexts['section4'] = document.getElementById('section4-text').textContent;
            }
            if (document.getElementById('section5-text')?.textContent) {
                generatedTexts['section5'] = document.getElementById('section5-text').textContent;
            }
            if (document.getElementById('section6-text')?.textContent) {
                generatedTexts['section6'] = document.getElementById('section6-text').textContent;
            }
            if (document.getElementById('section7-text')?.textContent) {
                generatedTexts['section7'] = document.getElementById('section7-text').textContent;
            }
            if (document.getElementById('section8-text')?.textContent) {
                generatedTexts['section8'] = document.getElementById('section8-text').textContent;
            }

            // Capturar status das se√ß√µes
            const sectionStatuses = {
                1: currentSection > 1 ? 'COMPLETED' : 'IN_PROGRESS',
                2: currentSection > 2 ? 'COMPLETED' : (currentSection === 2 ? 'IN_PROGRESS' : 'PENDING'),
                3: currentSection > 3 ? 'COMPLETED' : (currentSection === 3 ? 'IN_PROGRESS' : 'PENDING'),
                4: currentSection === 4 ? 'IN_PROGRESS' : 'PENDING'
            };

            const draft = {
                sessionId: sessionId,
                boId: currentBoId,
                currentStep: currentQuestionStep,
                currentSection: currentSection,
                answers: answersState,
                chatHistory: chatMessages,
                generatedTexts: generatedTexts,
                sectionStatuses: sectionStatuses,
                savedAt: new Date().toISOString(),
                version: '0.9.0'
            };

            try {
                localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draft));
                showAutosaveIndicator();
                console.log('[Draft] Rascunho salvo:', draft);
            } catch (e) {
                console.error('[Draft] Erro ao salvar:', e);
            }
        }

        function loadDraft() {
            /**
             * Carrega rascunho do localStorage
             * Returns: draft object ou null
             */
            try {
                const draftJson = localStorage.getItem(DRAFT_STORAGE_KEY);
                if (!draftJson) return null;
                
                const draft = JSON.parse(draftJson);
                
                // Verificar se tem dados v√°lidos
                if (!draft.answers || Object.keys(draft.answers).length === 0) {
                    return null;
                }
                
                // Verificar se n√£o √© muito antigo (7 dias)
                const savedAt = new Date(draft.savedAt);
                const now = new Date();
                const diffDays = (now - savedAt) / (1000 * 60 * 60 * 24);
                
                if (diffDays > 7) {
                    console.log('[Draft] Rascunho expirado (> 7 dias)');
                    clearDraft();
                    return null;
                }
                
                return draft;
            } catch (e) {
                console.error('[Draft] Erro ao carregar:', e);
                return null;
            }
        }

        function clearDraft() {
            /**
             * Remove rascunho do localStorage
             */
            try {
                localStorage.removeItem(DRAFT_STORAGE_KEY);
                console.log('[Draft] Rascunho removido');
            } catch (e) {
                console.error('[Draft] Erro ao remover:', e);
            }
        }

        function showAutosaveIndicator() {
            /**
             * Mostra indicador de salvamento por 2 segundos
             */
            autosaveIndicator.classList.remove('hidden');
            autosaveIndicator.textContent = 'üíæ Rascunho salvo!';
            
            setTimeout(() => {
                autosaveIndicator.textContent = 'üíæ Rascunho salvo automaticamente';
            }, 1500);
        }

        function formatDraftPreview(draft) {
            /**
             * Formata preview do rascunho para o modal
             * Formato: Status por se√ß√£o + timestamp + lista de respostas
             */
            const savedDate = new Date(draft.savedAt);
            const formattedDate = savedDate.toLocaleDateString('pt-BR') + ' √†s ' +
                                  savedDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            // Contar respostas por se√ß√£o
            const section1Answers = Object.keys(draft.answers).filter(s => s.startsWith('1.')).length;
            const section2Answers = Object.keys(draft.answers).filter(s => s.startsWith('2.')).length;
            const section3Answers = Object.keys(draft.answers).filter(s => s.startsWith('3.')).length;

            let preview = '';

            // Status da Se√ß√£o 1
            if (section1Answers === 7) {
                preview += `<div class="mb-1 text-sm">Se√ß√£o 1: ‚úÖ Completa</div>`;
            } else if (section1Answers > 0) {
                preview += `<div class="mb-1 text-sm">Se√ß√£o 1: ${section1Answers}/7 perguntas respondidas</div>`;
            }

            // Status da Se√ß√£o 2 (se iniciada)
            if (section2Answers > 0) {
                if (section2Answers === 8) {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 2: ‚úÖ Completa</div>`;
                } else {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 2: ${section2Answers}/8 perguntas respondidas</div>`;
                }
            }

            // Status da Se√ß√£o 3 (se iniciada)
            if (section3Answers > 0) {
                if (section3Answers === 8) {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 3: ‚úÖ Completa</div>`;
                } else {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 3: ${section3Answers}/8 perguntas respondidas</div>`;
                }
            }

            // Linha em branco + timestamp
            preview += `<div class="text-xs text-gray-500 mt-3 mb-2">Salvo em: ${formattedDate}</div>`;

            // Container de respostas
            preview += `<div class="border-t pt-2 mt-2 max-h-32 overflow-y-auto">`;

            // Mostrar respostas salvas (truncadas), ordenadas
            const sortedEntries = Object.entries(draft.answers).sort((a, b) => {
                const [sectionA, stepA] = a[0].split('.').map(Number);
                const [sectionB, stepB] = b[0].split('.').map(Number);
                if (sectionA !== sectionB) return sectionA - sectionB;
                return stepA - stepB;
            });

            for (const [step, answer] of sortedEntries) {
                const truncated = answer.length > 50 ? answer.substring(0, 50) + '...' : answer;
                let sectionLabel = 'üìù';
                if (step.startsWith('2.')) sectionLabel = 'üöó';
                if (step.startsWith('3.')) sectionLabel = 'üëÅÔ∏è';
                preview += `<div class="text-xs mb-1"><span class="text-gray-500">${sectionLabel} ${step}:</span> ${truncated}</div>`;
            }

            preview += `</div>`;
            return preview;
        }

        function showDraftModal(draft) {
            /**
             * Exibe modal perguntando se quer continuar rascunho
             */
            draftPreview.innerHTML = formatDraftPreview(draft);
            draftModal.classList.remove('hidden');
        }

        function hideDraftModal() {
            draftModal.classList.add('hidden');
        }

        async function restoreFromDraft(draft) {
            /**
             * Restaura sess√£o a partir do rascunho
             * v0.9.0: Usa sincroniza√ß√£o em bloco via /sync_session + migra√ß√£o de IDs antigos + suporte a 5 se√ß√µes
             */
            console.log('[Draft] Restaurando rascunho...');

            try {
                // Migrar IDs antigos se necess√°rio (v0.6.3 ‚Üí v0.9.0)
                if (draft.version === '0.6.3' || !draft.version) {
                    console.log('[Draft] Detectado rascunho v0.6.3. Migrando IDs...');
                    answersState = migrateOldDraftIDs(draft.answers);
                } else {
                    answersState = draft.answers;
                }

                currentSection = draft.currentSection || 1;

                // 1. Iniciar nova sess√£o no backend
                const response = await fetch(`${API_URL}/new_session`, { method: 'POST' });
                if (!response.ok) throw new Error('Erro ao iniciar sess√£o');

                const data = await response.json();
                sessionId = data.session_id;
                currentBoId = data.bo_id;

                // 2. Mensagem inicial
                addMessage('Ol√°! Restaurei seu rascunho. Vou continuar de onde voc√™ parou.', true, false, null, 'welcome_restored');

                // 3. Restaurar chatHistory (ou reconstruir se n√£o existir)
                if (draft.chatHistory && draft.chatHistory.length > 0) {
                    // Restaurar mensagens salvas
                    draft.chatHistory.forEach(msg => {
                        addMessage(msg.text, msg.isBot, false, msg.step, msg.eventId);
                    });
                } else {
                    // Fallback: reconstruir a partir de answers (compatibilidade v0.6.3)
                    const sortedSteps = Object.keys(answersState).sort((a, b) => {
                        const [sectionA, stepA] = a.split('.').map(Number);
                        const [sectionB, stepB] = b.split('.').map(Number);
                        if (sectionA !== sectionB) return sectionA - sectionB;
                        return stepA - stepB;
                    });

                    for (const step of sortedSteps) {
                        const answer = answersState[step];
                        let question;
                        if (step.startsWith('1.')) {
                            question = SECTION1_QUESTIONS[step];
                        } else if (step.startsWith('2.')) {
                            question = SECTION2_QUESTIONS[step];
                        } else if (step.startsWith('3.')) {
                            question = SECTION3_QUESTIONS[step];
                        } else if (step.startsWith('4.')) {
                            question = SECTION4_QUESTIONS[step];
                        } else if (step.startsWith('5.')) {
                            question = SECTION5_QUESTIONS[step];
                        } else if (step.startsWith('6.')) {
                            question = SECTION6_QUESTIONS[step];
                        } else if (step.startsWith('7.')) {
                            question = SECTION7_QUESTIONS[step];
                        } else if (step.startsWith('8.')) {
                            question = SECTION8_QUESTIONS[step];
                        }

                        if (question) {
                            addMessage(question, true, false, step, `evt_restored_q_${step}`);
                            addMessage(answer, false, false, step);
                        }
                    }
                }

                // 4. Restaurar textos gerados
                if (draft.generatedTexts) {
                    if (draft.generatedTexts.section1) {
                        addGeneratedSectionText(1, draft.generatedTexts.section1);
                    }
                    if (draft.generatedTexts.section2) {
                        addGeneratedSectionText(2, draft.generatedTexts.section2);
                    }
                    if (draft.generatedTexts.section3) {
                        addGeneratedSectionText(3, draft.generatedTexts.section3);
                    }
                    if (draft.generatedTexts.section4) {
                        addGeneratedSectionText(4, draft.generatedTexts.section4);
                    }
                    if (draft.generatedTexts.section5) {
                        addGeneratedSectionText(5, draft.generatedTexts.section5);
                    }
                    if (draft.generatedTexts.section6) {
                        addGeneratedSectionText(6, draft.generatedTexts.section6);
                    }
                    if (draft.generatedTexts.section7) {
                        addGeneratedSectionText(7, draft.generatedTexts.section7);
                    }
                    if (draft.generatedTexts.section8) {
                        addGeneratedSectionText(8, draft.generatedTexts.section8);
                    }
                }

                // 5. Atualizar sidebar se estiver na Se√ß√£o 2, 3, 4, 5, 6, 7 ou 8
                if (currentSection === 2) {
                    updateSidebarForSection2();
                } else if (currentSection === 3) {
                    updateSidebarForSection3();
                } else if (currentSection === 4) {
                    updateSidebarForSection4();
                } else if (currentSection === 5) {
                    updateSidebarForSection5();
                } else if (currentSection === 6) {
                    updateSidebarForSection6();
                } else if (currentSection === 7) {
                    updateSidebarForSection7();
                } else if (currentSection === 8) {
                    updateSidebarForSection8();
                }

                // 6. SINCRONIZA√á√ÉO EM BLOCO (1 requisi√ß√£o √∫nica)
                console.log('[Draft] Sincronizando respostas em bloco...');

                const syncResponse = await fetch(`${API_URL}/sync_session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answers: answersState,
                        llm_provider: 'groq'
                    })
                });

                if (!syncResponse.ok) {
                    throw new Error('Erro na sincroniza√ß√£o em bloco');
                }

                const syncData = await syncResponse.json();

                // CR√çTICO: Atualizar estado com resposta do backend
                currentQuestionStep = syncData.current_step;
                currentSection = syncData.current_section;

                console.log(`[Draft] Sincroniza√ß√£o completa. Pr√≥ximo: ${currentQuestionStep}`);

                // 7. Atualizar sidebar (apenas uma vez, no final)
                const section1Count = Object.keys(answersState).filter(s => s.startsWith('1.')).length;
                const section2Count = Object.keys(answersState).filter(s => s.startsWith('2.')).length;
                const section3Count = Object.keys(answersState).filter(s => s.startsWith('3.')).length;
                const section4Count = Object.keys(answersState).filter(s => s.startsWith('4.')).length;
                const section5Count = Object.keys(answersState).filter(s => s.startsWith('5.')).length;
                const section6Count = Object.keys(answersState).filter(s => s.startsWith('6.')).length;
                const section7Count = Object.keys(answersState).filter(s => s.startsWith('7.')).length;
                const section8Count = Object.keys(answersState).filter(s => s.startsWith('8.')).length;

                Object.keys(answersState).forEach(step => {
                    updateSidebarAnswer(step, answersState[step]);
                    updateSidebarStatus(step, 'answered');
                });

                // Atualizar progresso
                if (currentSection === 8) {
                    updateSidebarProgress(section8Count, 6);
                } else if (currentSection === 7) {
                    updateSidebarProgress(section7Count, 4);
                } else if (currentSection === 6) {
                    updateSidebarProgress(section6Count, 5);
                } else if (currentSection === 5) {
                    updateSidebarProgress(section5Count, 4);
                } else if (currentSection === 4) {
                    updateSidebarProgress(section4Count, 5);
                } else if (currentSection === 3) {
                    updateSidebarProgress(section3Count, 8);
                } else if (currentSection === 2) {
                    updateSidebarProgress(section2Count, 8);
                } else {
                    updateSidebarProgress(section1Count, 7);
                }

                // 8. Mostrar pr√≥xima pergunta OU desabilitar se completo
                if (!currentQuestionStep.includes('complete')) {
                    let nextQuestion;
                    if (currentSection === 1) {
                        nextQuestion = SECTION1_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 2) {
                        nextQuestion = SECTION2_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 3) {
                        nextQuestion = SECTION3_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 4) {
                        nextQuestion = SECTION4_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 5) {
                        nextQuestion = SECTION5_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 6) {
                        nextQuestion = SECTION6_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 7) {
                        nextQuestion = SECTION7_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 8) {
                        nextQuestion = SECTION8_QUESTIONS[currentQuestionStep];
                    }

                    if (nextQuestion) {
                        updateSidebarStatus(currentQuestionStep, 'current');

                        // ‚ö†Ô∏è Verificar se pergunta j√° est√° no chat (evitar duplica√ß√£o)
                        const lastBotMessage = Array.from(chatContainer.querySelectorAll('.message-container.justify-start'))
                            .pop()?.dataset.step;

                        if (lastBotMessage !== currentQuestionStep) {
                            // Pergunta ainda n√£o foi mostrada, adicionar agora
                            setTimeout(() => {
                                addMessage(nextQuestion, true, false, currentQuestionStep, `evt_next_${currentQuestionStep}`);
                                enableInput();
                            }, 500);
                        } else {
                            // Pergunta j√° est√° no chat, apenas habilitar input
                            enableInput();
                        }
                    }
                } else {
                    // Se√ß√£o completa

                    // ‚ö†Ô∏è Se Se√ß√£o 1 completa e ainda n√£o iniciou Se√ß√£o 2, mostrar bot√£o
                    if (currentSection === 1 && !document.getElementById('btn-start-section2')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 2
                        const section2ButtonDiv = document.createElement('div');
                        section2ButtonDiv.id = 'section2-button-container';
                        section2ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl text-center';
                        section2ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-blue-900 mb-2">üöó Se√ß√£o 2: Abordagem a Ve√≠culo</h3>
                            <p class="text-gray-700 mb-4">
                                Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section2"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o havia ve√≠culo
                                </button>
                                <button
                                    id="btn-start-section2"
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, havia ve√≠culo
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section2ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section2').addEventListener('click', startSection2);
                        document.getElementById('btn-skip-section2').addEventListener('click', () => skipSection(2));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 1 completa.');
                    } else if (currentSection === 2 && !document.getElementById('btn-start-section3')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 3
                        const section3ButtonDiv = document.createElement('div');
                        section3ButtonDiv.id = 'section3-button-container';
                        section3ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl text-center';
                        section3ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-purple-900 mb-2">üëÅÔ∏è Se√ß√£o 3: Campana</h3>
                            <p class="text-gray-700 mb-4">
                                A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section3"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve campana
                                </button>
                                <button
                                    id="btn-start-section3"
                                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve campana
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section3ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section3').addEventListener('click', startSection3);
                        document.getElementById('btn-skip-section3').addEventListener('click', () => skipSection(3));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 2 completa.');
                    } else if (currentSection === 3 && !document.getElementById('btn-start-section4')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 4
                        const section4ButtonDiv = document.createElement('div');
                        section4ButtonDiv.id = 'section4-button-container';
                        section4ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl text-center';
                        section4ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-orange-900 mb-2">üè† Se√ß√£o 4: Entrada em Domic√≠lio</h3>
                            <p class="text-gray-700 mb-4">
                                Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section4"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve entrada em domic√≠lio
                                </button>
                                <button
                                    id="btn-start-section4"
                                    class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve entrada em domic√≠lio
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section4ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section4').addEventListener('click', startSection4);
                        document.getElementById('btn-skip-section4').addEventListener('click', () => skipSection(4));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 3 completa.');
                    } else if (currentSection === 4 && !document.getElementById('btn-start-section5')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 5
                        const section5ButtonDiv = document.createElement('div');
                        section5ButtonDiv.id = 'section5-button-container';
                        section5ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-pink-50 to-pink-100 border-2 border-pink-200 rounded-xl text-center';
                        section5ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-pink-900 mb-2">üéØ Se√ß√£o 5: Fundada Suspeita</h3>
                            <p class="text-gray-700 mb-4">
                                Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section5"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve fundada suspeita
                                </button>
                                <button
                                    id="btn-start-section5"
                                    class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve fundada suspeita
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section5ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section5').addEventListener('click', startSection5);
                        document.getElementById('btn-skip-section5').addEventListener('click', () => skipSection(5));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 4 completa.');
                    } else if (currentSection === 5 && !document.getElementById('btn-start-section6')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 6
                        const section6ButtonDiv = document.createElement('div');
                        section6ButtonDiv.id = 'section6-button-container';
                        section6ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-200 rounded-xl text-center';
                        section6ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-teal-900 mb-2">üí™ Se√ß√£o 6: Rea√ß√£o e Uso da For√ßa</h3>
                            <p class="text-gray-700 mb-4">
                                Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section6"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve resist√™ncia
                                </button>
                                <button
                                    id="btn-start-section6"
                                    class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve resist√™ncia
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section6ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section6').addEventListener('click', startSection6);
                        document.getElementById('btn-skip-section6').addEventListener('click', () => skipSection(6));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 5 completa.');
                    } else if (currentSection === 6 && !document.getElementById('btn-start-section7')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 7
                        const section7ButtonDiv = document.createElement('div');
                        section7ButtonDiv.id = 'section7-button-container';
                        section7ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-amber-50 to-amber-100 border-2 border-amber-200 rounded-xl text-center';
                        section7ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-amber-900 mb-2">üì¶ Se√ß√£o 7: Apreens√µes e Cadeia de Cust√≥dia</h3>
                            <p class="text-gray-700 mb-4">
                                Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section7"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve apreens√£o
                                </button>
                                <button
                                    id="btn-start-section7"
                                    class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve apreens√£o
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section7ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section7').addEventListener('click', startSection7);
                        document.getElementById('btn-skip-section7').addEventListener('click', () => skipSection(7));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 6 completa.');
                    } else if (currentSection === 7 && !document.getElementById('btn-start-section8')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 8
                        const section8ButtonDiv = document.createElement('div');
                        section8ButtonDiv.id = 'section8-button-container';
                        section8ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-indigo-50 to-indigo-100 border-2 border-indigo-200 rounded-xl text-center';
                        section8ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-indigo-900 mb-2">‚öñÔ∏è Se√ß√£o 8: Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL)</h3>
                            <p class="text-gray-700 mb-4">
                                √öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.
                            </p>
                            <button
                                id="btn-start-section8"
                                class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar Se√ß√£o 8 (FINAL)
                            </button>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section8ButtonDiv);

                        // Event listener para o bot√£o
                        document.getElementById('btn-start-section8').addEventListener('click', startSection8);

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 7 completa.');
                    } else if (currentSection === 8) {
                        disableInput();
                        // Se√ß√£o 8 √© a √öLTIMA - BO completo
                        showToast('‚úÖ Rascunho restaurado! BO completo.');
                        boCompleted = true;
                        console.log('[BO] BO marcado como completo (restaurado)');
                    } else {
                        // Outras se√ß√µes completas
                        disableInput();
                        showToast('‚úÖ Rascunho restaurado! Esta se√ß√£o j√° est√° completa.');
                    }
                }

                showToast('‚úÖ Rascunho restaurado com sucesso!');

            } catch (error) {
                console.error('[Draft] Erro ao restaurar:', error);
                showToast('‚ùå Erro ao restaurar rascunho. Iniciando novo BO.');
                clearDraft();
                startSession();
            }
        }

        // ================================================================
        // FUN√á√ïES DE GERENCIAMENTO DE TEXTOS GERADOS (M√öLTIPLAS SE√á√ïES)
        // ================================================================

        function addSkippedSectionText(sectionNumber, skipReason) {
            /**
             * Adiciona texto de se√ß√£o pulada (n√£o aplic√°vel) no card correto
             * @param {number} sectionNumber - N√∫mero da se√ß√£o (1, 2, 3...)
             * @param {string} skipReason - Motivo do skip (fornecido pelo backend)
             */
            try {
                const textElement = document.getElementById(`section${sectionNumber}-text`);
                const cardElement = document.getElementById(`section${sectionNumber}-card`);
                const containerElement = document.getElementById('generated-sections-container');
                const copyAllButton = document.getElementById('copy-all-button');

                console.log(`[Skip] Tentando adicionar se√ß√£o ${sectionNumber} - textElement:`, !!textElement, 'cardElement:', !!cardElement);

                if (!textElement || !cardElement) {
                    console.error(`[Skip] Elementos n√£o encontrados para se√ß√£o ${sectionNumber}`);
                    return;
                }

                // Criar HTML especial para se√ß√£o pulada com estilo bonito (sem bot√£o de copiar)
                const section = ALL_SECTIONS[sectionNumber];

                // Apenas mostrar o motivo da se√ß√£o pulada, sem t√≠tulo extras
                textElement.textContent = skipReason;
                textElement.classList.add('italic', 'text-gray-500'); // Cinza mais claro para parecer "desconsiderado"
                textElement.style.fontSize = '0.95rem'; // Ligeiramente menor

                // Atualizar summary com badge ao lado do t√≠tulo e apar√™ncia de "p√°lido"
                const summary = cardElement.querySelector('summary');
                if (summary) {
                    // Modificar o HTML do summary para ter badge inline
                    summary.innerHTML = `${section.emoji} <span class="text-gray-500">Se√ß√£o ${sectionNumber} - ${section.name}</span> <span class="inline-block bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs font-semibold ml-2">Pulada</span>`;
                    summary.classList.add('opacity-80'); // Reduzir opacidade
                }

                // Adicionar fundo cinza claro ao card (summary) para indicar que foi pulada
                if (summary) {
                    summary.classList.add('bg-gray-100');
                }

                // Adicionar fundo cinza mais forte ao conte√∫do
                const cardDiv = cardElement.querySelector('.bg-white');
                if (cardDiv) {
                    cardDiv.classList.remove('bg-white');
                    cardDiv.classList.add('bg-gray-100'); // Fundo cinza mais destacado
                }

                // Esconder bot√£o de copiar para se√ß√µes puladas
                const copyButton = cardElement.querySelector('button');
                if (copyButton) {
                    copyButton.classList.add('hidden');
                    copyButton.style.display = 'none';
                }

                // Remover classe hidden tanto do classList quanto com estilo inline para garantir visibilidade
                cardElement.classList.remove('hidden');
                cardElement.style.display = '';
                containerElement.classList.remove('hidden');
                containerElement.style.display = '';

                // Mostrar bot√£o "Copiar BO Completo" se houver 2+ se√ß√µes
                const visibleSections = document.querySelectorAll('#generated-sections-container details:not(.hidden)');
                if (visibleSections.length >= 2) {
                    copyAllButton.classList.remove('hidden');
                    copyAllButton.style.display = '';
                }

                console.log(`[Skip] Se√ß√£o ${sectionNumber} pulada (adicionada ao container). Se√ß√µes vis√≠veis: ${visibleSections.length}`);
            } catch (error) {
                console.error(`[Skip] Erro ao adicionar se√ß√£o ${sectionNumber}:`, error);
            }
        }

        function addGeneratedSectionText(sectionNumber, text) {
            /**
             * Adiciona ou atualiza texto de uma se√ß√£o no container persistente
             * @param {number} sectionNumber - N√∫mero da se√ß√£o (1, 2, 3...)
             * @param {string} text - Texto gerado pelo LLM
             */
            if (!text || !text.trim()) return;

            const textElement = document.getElementById(`section${sectionNumber}-text`);
            const cardElement = document.getElementById(`section${sectionNumber}-card`);
            const containerElement = document.getElementById('generated-sections-container');
            const copyAllButton = document.getElementById('copy-all-button');

            if (textElement && cardElement) {
                textElement.textContent = text;
                textElement.classList.remove('italic', 'text-gray-500'); // Remover estilos de skip se houver

                // Remover classe hidden tanto do classList quanto com estilo inline para garantir visibilidade
                cardElement.classList.remove('hidden');
                cardElement.style.display = '';
                containerElement.classList.remove('hidden');
                containerElement.style.display = '';

                // Mostrar bot√£o "Copiar BO Completo" se houver 2+ se√ß√µes
                const visibleSections = document.querySelectorAll('#generated-sections-container details:not(.hidden)');
                if (visibleSections.length >= 2) {
                    copyAllButton.classList.remove('hidden');
                    copyAllButton.style.display = '';
                }

                console.log(`[Texto] Se√ß√£o ${sectionNumber} adicionada ao container persistente`);
            }
        }

        function copySection(sectionNumber) {
            /**
             * Copia texto de uma se√ß√£o espec√≠fica para a √°rea de transfer√™ncia
             * @param {number} sectionNumber - N√∫mero da se√ß√£o a copiar
             */
            const textElement = document.getElementById(`section${sectionNumber}-text`);

            if (!textElement || !textElement.textContent) {
                showToast('‚ùå Texto da se√ß√£o n√£o encontrado');
                return;
            }

            const text = textElement.textContent;

            navigator.clipboard.writeText(text)
                .then(() => {
                    showToast(`‚úÖ Se√ß√£o ${sectionNumber} copiada!`);
                })
                .catch(err => {
                    console.error('[Copy] Erro ao copiar:', err);
                    showToast('‚ùå Erro ao copiar texto');
                });
        }

        function copyAllSections() {
            /**
             * Copia TODAS as se√ß√µes geradas em um √∫nico texto formatado
             */
            let fullBO = "";

            // Se√ß√£o 1
            const section1Text = document.getElementById('section1-text');
            if (section1Text && section1Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 1 - CONTEXTO DA OCORR√äNCIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section1Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 2
            const section2Text = document.getElementById('section2-text');
            if (section2Text && section2Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 2 - ABORDAGEM A VE√çCULO\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section2Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 3
            const section3Text = document.getElementById('section3-text');
            if (section3Text && section3Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 3 - CAMPANA (VIGIL√ÇNCIA VELADA)\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section3Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 4
            const section4Text = document.getElementById('section4-text');
            if (section4Text && section4Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 4 - ENTRADA EM DOMIC√çLIO\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section4Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 5
            const section5Text = document.getElementById('section5-text');
            if (section5Text && section5Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 5 - FUNDADA SUSPEITA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section5Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 6
            const section6Text = document.getElementById('section6-text');
            if (section6Text && section6Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 6 - REA√á√ÉO E USO DA FOR√áA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section6Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 7
            const section7Text = document.getElementById('section7-text');
            if (section7Text && section7Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 7 - APREENS√ïES E CADEIA DE CUST√ìDIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section7Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 8
            const section8Text = document.getElementById('section8-text');
            if (section8Text && section8Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 8 - CONDU√á√ÉO E P√ìS-OCORR√äNCIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section8Text.textContent.trim() + "\n\n\n";
            }

            if (!fullBO) {
                showToast('‚ùå Nenhum texto gerado para copiar');
                return;
            }

            // Adicionar footer
            fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            fullBO += "Gerado por: BO Inteligente v0.12.8\n";
            fullBO += "Data: " + new Date().toLocaleDateString('pt-BR') + "\n";
            fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

            navigator.clipboard.writeText(fullBO)
                .then(() => {
                    showToast('üìë BO completo copiado! (Todas se√ß√µes)');
                })
                .catch(err => {
                    console.error('[Copy] Erro ao copiar BO completo:', err);
                    showToast('‚ùå Erro ao copiar BO completo');
                });
        }

        // ================================================================
        // FUN√á√ïES DA SIDEBAR
        // ================================================================

        // Mapa de todas as se√ß√µes futuras (2-8)
        const ALL_SECTIONS = {
            1: { emoji: 'üìù', name: 'Contexto da Ocorr√™ncia', questions: QUESTIONS },
            2: { emoji: 'üöó', name: 'Abordagem a Ve√≠culo', questions: SECTION2_QUESTIONS },
            3: { emoji: 'üëÅÔ∏è', name: 'Campana', questions: SECTION3_QUESTIONS },
            4: { emoji: 'üè†', name: 'Entrada em Domic√≠lio', questions: SECTION4_QUESTIONS },
            5: { emoji: 'üéØ', name: 'Fundada Suspeita', questions: SECTION5_QUESTIONS },
            6: { emoji: 'üí™', name: 'Rea√ß√£o e Uso da For√ßa', questions: SECTION6_QUESTIONS },
            7: { emoji: 'üì¶', name: 'Apreens√µes e Cadeia de Cust√≥dia', questions: SECTION7_QUESTIONS },
            8: { emoji: '‚öñÔ∏è', name: 'Condu√ß√£o e P√≥s-Ocorr√™ncia', questions: SECTION8_QUESTIONS }
        };

        // Inicializar sidebar
        function initializeSidebar() {
            questionsList.innerHTML = ''; // Limpar

            // Adicionar perguntas da Se√ß√£o 1 (sem header, pois j√° est√° no topo da sidebar)
            Object.entries(QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (2-8) - Apenas preview
            for (let i = 2; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            updateSidebarStatus('1.1', 'current');
        }

        // Atualizar status visual na sidebar
        function updateSidebarStatus(step, status) {
            const questionItem = document.getElementById(`question-item-${step}`);
            const icon = document.getElementById(`icon-${step}`);

            if (!questionItem || !icon) return;

            questionItem.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-gray-200');
            icon.classList.remove('bg-blue-500', 'text-white', 'bg-green-500', 'bg-gray-200', 'text-gray-600');

            if (status === 'current') {
                questionItem.classList.add('border-blue-500', 'bg-blue-50');
                icon.classList.add('bg-blue-500', 'text-white');
                icon.textContent = step; // Manter ID do step
            } else if (status === 'answered') {
                questionItem.classList.add('border-green-500', 'bg-green-50');
                icon.classList.add('bg-green-500', 'text-white');
                icon.textContent = '‚úì';
            } else {
                questionItem.classList.add('border-gray-200');
                icon.classList.add('bg-gray-200', 'text-gray-600');
                icon.textContent = step; // Manter ID do step
            }
        }

        // Atualizar resposta na sidebar
        function updateSidebarAnswer(step, answer) {
            const answerElement = document.getElementById(`answer-${step}`);
            if (answerElement && answer) {
                const truncated = answer.length > 60 ? answer.substring(0, 60) + '...' : answer;
                answerElement.innerHTML = `<span class="text-gray-700">${truncated}</span>`;
                answersState[step] = answer;
            }
        }

        // Expandir/colapsar pergunta
        function toggleQuestionExpand(step) {
            const answerElement = document.getElementById(`answer-${step}`);
            const answer = answersState[step];
            
            if (!answer || !answerElement) return;
            
            const isExpanded = answerElement.dataset.expanded === 'true';
            
            if (isExpanded) {
                const truncated = answer.length > 60 ? answer.substring(0, 60) + '...' : answer;
                answerElement.innerHTML = `<span class="text-gray-700">${truncated}</span>`;
                answerElement.dataset.expanded = 'false';
            } else {
                answerElement.innerHTML = `<span class="text-gray-700">${answer}</span>`;
                answerElement.dataset.expanded = 'true';
            }
        }

        // Atualizar progresso na sidebar
        function updateSidebarProgress(answered, total) {
            const percentage = (answered / total) * 100;
            sidebarProgressBar.style.width = `${percentage}%`;
            sidebarProgressText.textContent = `${answered}/${total}`;
        }

        // Atualizar sidebar para Se√ß√£o 2
        function updateSidebarForSection2() {
            // Inserir card de Se√ß√£o 1 completada ANTES do header
            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Verificar se j√° existe card de se√ß√£o completada
            const existingCompletedCard = sidebar.querySelector('.section-completed-card');
            if (!existingCompletedCard && sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-4';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-3">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto da Ocorr√™ncia</span>
                    </div>
                `;
                // Inserir ANTES do header com t√≠tulo e barra de progresso
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 2
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üöó Se√ß√£o 2 - Abordagem a Ve√≠culo';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 2 (sem header duplicado)
            Object.entries(SECTION2_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (3-8) - Apenas preview
            for (let i = 3; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 2 (8 perguntas: 2.1 a 2.8)
            updateSidebarProgress(0, 8);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('2.1', 'answered');
            updateSidebarAnswer('2.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('2.2', 'current');
        }

        // Atualizar sidebar para Se√ß√£o 3
        function updateSidebarForSection3() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1 e 2 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-4';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1 primeiro, depois 2)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 3
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üëÅÔ∏è Se√ß√£o 3 - Campana';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 3
            Object.entries(SECTION3_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (4-8) - Apenas preview
            for (let i = 4; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 3 (8 perguntas: 3.1 a 3.8)
            updateSidebarProgress(0, 8);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('3.1', 'answered');
            updateSidebarAnswer('3.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('3.2', 'current');
        }

        function updateSidebarForSection4() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2 e 3 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-4';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 4
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üè† Se√ß√£o 4 - Entrada em Domic√≠lio';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 4
            Object.entries(SECTION4_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (5-8) - Apenas preview
            for (let i = 5; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 4 (5 perguntas: 4.1 a 4.5)
            updateSidebarProgress(0, 5);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('4.1', 'answered');
            updateSidebarAnswer('4.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('4.2', 'current');
        }

        function updateSidebarForSection5() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2, 3 e 4 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-4';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3, 4)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 5
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üéØ Se√ß√£o 5 - Fundada Suspeita';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 5
            Object.entries(SECTION5_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (6-8) - Apenas preview
            for (let i = 6; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 5 (4 perguntas: 5.1 a 5.4)
            updateSidebarProgress(0, 4);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('5.1', 'answered');
            updateSidebarAnswer('5.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('5.2', 'current');
        }

        function updateSidebarForSection6() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2, 3, 4 e 5 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-4';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3, 4, 5)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 6
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üí™ Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 6
            Object.entries(SECTION6_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-teal-100 text-teal-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (7-8) - Apenas preview
            for (let i = 7; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 6 (5 perguntas: 6.1 a 6.5)
            updateSidebarProgress(0, 5);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('6.1', 'answered');
            updateSidebarAnswer('6.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('6.2', 'current');
        }

        function updateSidebarForSection7() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√µes 1 a 6 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-2';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                const section6Completed = document.createElement('div');
                section6Completed.className = 'section-completed-card mb-4';
                section6Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-teal-50 border border-teal-200 rounded-lg p-2">
                        <span class="text-teal-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-teal-800">üí™ Se√ß√£o 6 - Rea√ß√£o</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem correta: 1,2,3,4,5,6)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section6Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 7
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üì¶ Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 7
            Object.entries(SECTION7_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-amber-100 text-amber-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√£o futura (8) - Apenas preview
            const section = ALL_SECTIONS[8];
            const sectionPreview = document.createElement('div');
            sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
            sectionPreview.id = 'section-preview-8';
            sectionPreview.innerHTML = `
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <span>${section.emoji}</span>
                    <span class="font-medium">Se√ß√£o 8 - ${section.name}</span>
                    <span class="ml-auto text-xs">üîí</span>
                </div>
            `;
            questionsList.appendChild(sectionPreview);

            // Resetar progresso para Se√ß√£o 7 (4 perguntas: 7.1 a 7.4)
            updateSidebarProgress(0, 4);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('7.1', 'answered');
            updateSidebarAnswer('7.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('7.2', 'current');
        }

        function updateSidebarForSection8() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√µes 1 a 7 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-2';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                const section6Completed = document.createElement('div');
                section6Completed.className = 'section-completed-card mb-2';
                section6Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-teal-50 border border-teal-200 rounded-lg p-2">
                        <span class="text-teal-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-teal-800">üí™ Se√ß√£o 6 - Rea√ß√£o</span>
                    </div>
                `;

                const section7Completed = document.createElement('div');
                section7Completed.className = 'section-completed-card mb-4';
                section7Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-amber-50 border border-amber-200 rounded-lg p-2">
                        <span class="text-amber-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-amber-800">üì¶ Se√ß√£o 7 - Apreens√µes</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem correta: 1,2,3,4,5,6,7)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section6Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section7Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 8
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = '‚öñÔ∏è Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 8
            Object.entries(SECTION8_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-indigo-100 text-indigo-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Resetar progresso para Se√ß√£o 8 (6 perguntas: 8.1 a 8.6)
            updateSidebarProgress(0, 6);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('8.1', 'answered');
            updateSidebarAnswer('8.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('8.2', 'current');
        }

        // Toggle sidebar mobile
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('open');
        });

        sidebarClose.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        // ================================================================
        // FUN√á√ïES DE FEEDBACK
        // ================================================================

        function sendFeedback(eventId, feedbackType, buttonElement) {
            const boId = currentBoId || 'BO-TEMP-' + sessionId;
			
			// ‚úÖ BLOQUEAR DUPLO CLIQUE
			if (buttonElement.disabled) {
				return; // J√° est√° processando
			}
			
			// ‚úÖ CAPTURAR TEXTO DA MENSAGEM
			const messageDiv = buttonElement.closest('.message-container');
			const messageText = messageDiv ? messageDiv.dataset.currentText : '';
			const step = messageDiv ? messageDiv.dataset.step : null;
			
            if (!boId) {
                console.error('BO ID n√£o dispon√≠vel');
                showToast('‚ùå Aguarde inicializa√ß√£o...');
                return;
            }
            
            if (buttonElement) {
                buttonElement.classList.add('clicked');
                buttonElement.disabled = true;
            }
            
            fetch(`${API_URL}/feedback`, {
                    method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						bo_id: boId,
						event_id: eventId,
						feedback_type: feedbackType,
						context: {  // ‚úÖ ADICIONAR CONTEXT
							step: step,
							message: messageText
						},
                    metadata: {
                        screen_resolution: `${screen.width}x${screen.height}`,
                        viewport: `${window.innerWidth}x${window.innerHeight}`,
                        platform: navigator.platform,
                        language: navigator.language,
                        user_agent: navigator.userAgent
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    showToast(feedbackType === 'positive' ? '‚úÖ Obrigado pelo feedback!' : 'üëç Feedback enviado!');
                } else {
                    throw new Error('Erro ao enviar feedback');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('‚ùå Erro ao enviar feedback');
                if (buttonElement) {
                    buttonElement.classList.remove('clicked');
                    buttonElement.disabled = false;
                }
            });
        }

        function openFeedbackModal(eventId, messageText, step, buttonElement) {
            const messageDiv = buttonElement.closest('.message-container');
            const currentText = messageDiv ? (messageDiv.dataset.currentText || messageText) : messageText;
            
            const message = prompt(`üí¨ Feedback sobre: "${currentText}"\n\nO que aconteceu? (Descreva o problema ou sugest√£o)`);
            
            if (message && message.trim()) {
                sendDetailedFeedback(eventId, message, step, currentText, buttonElement);
            }
        }

        function sendDetailedFeedback(eventId, userMessage, step, contextMessage, buttonElement) {
            const boId = currentBoId || 'BO-TEMP-' + sessionId;
            
            if (!boId) {
                showToast('‚ùå BO ID n√£o dispon√≠vel');
                return;
            }
            
            if (buttonElement) {
                buttonElement.classList.add('clicked');
                buttonElement.disabled = true;
            }
            
            fetch(`${API_URL}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bo_id: boId,
                    event_id: eventId,
                    feedback_type: 'negative',
                    category: 'bug',
                    user_message: userMessage,
                    context: {
                        step: step,
                        message: contextMessage
                    },
                    metadata: {
                        screen_resolution: `${screen.width}x${screen.height}`,
                        viewport: `${window.innerWidth}x${window.innerHeight}`,
                        platform: navigator.platform,
                        language: navigator.language,
                        user_agent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ Feedback detalhado enviado! Obrigado!');
                } else {
                    throw new Error('Erro ao enviar feedback');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('‚ùå Erro ao enviar feedback');
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            toast.style.opacity = '0';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.opacity = '1', 10);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ================================================================
        // FUN√á√ïES DO CHAT
        // ================================================================

        function addMessage(text, isBot = true, isError = false, step = null, eventId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'} message-container fade-in`;
            messageDiv.dataset.step = step;
            messageDiv.dataset.currentText = text;
            if (eventId) messageDiv.dataset.eventId = eventId;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `max-w-[80%] p-3 rounded-lg ${
                isError
                    ? 'bg-red-100 text-red-800 border border-red-300'
                    : isBot 
                        ? 'bg-blue-100 text-gray-800' 
                        : 'bg-blue-600 text-white'
            }`;
            
            if (isError) {
                bubbleDiv.style.whiteSpace = 'pre-wrap';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-start gap-2';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            textSpan.className = 'flex-1';
            contentDiv.appendChild(textSpan);
            
            // Bot√£o editar
            if (!isBot && !isError && step) {
                const editButton = document.createElement('button');
                editButton.innerHTML = '‚úèÔ∏è Editar';
                editButton.className = 'text-xs bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded transition-colors whitespace-nowrap';
                editButton.onclick = () => editAnswer(step, textSpan.textContent, messageDiv, bubbleDiv);
                contentDiv.appendChild(editButton);
            }
            
            bubbleDiv.appendChild(contentDiv);
            
            // Bot√µes de feedback
            if (eventId) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons flex gap-2 mt-2 justify-end';
                
                const thumbsUp = document.createElement('button');
                thumbsUp.innerHTML = 'üëç';
                thumbsUp.className = 'feedback-btn';
                thumbsUp.title = 'Feedback positivo';
                thumbsUp.onclick = function() {
                    sendFeedback(eventId, 'positive', this);
                };
                
                const thumbsDown = document.createElement('button');
                thumbsDown.innerHTML = 'üëé';
                thumbsDown.className = 'feedback-btn';
                thumbsDown.title = 'Reportar problema';
                thumbsDown.onclick = function() {
                    openFeedbackModal(eventId, text, step, this);
                };
                
                feedbackDiv.appendChild(thumbsUp);
                feedbackDiv.appendChild(thumbsDown);
                bubbleDiv.appendChild(feedbackDiv);
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function editAnswer(step, currentText, messageDiv, bubbleDiv) {
            const contentDiv = bubbleDiv.querySelector('div');
            const textSpan = contentDiv.querySelector('span');
            const editButton = contentDiv.querySelector('button');
            
            editButton.style.display = 'none';
            
            const inputContainer = document.createElement('div');
            inputContainer.className = 'flex-1 flex flex-col gap-1';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'px-2 py-1 bg-white bg-opacity-90 text-gray-900 rounded';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-sm text-red-200 hidden';
            errorDiv.style.whiteSpace = 'pre-wrap';
            
            inputContainer.appendChild(input);
            inputContainer.appendChild(errorDiv);
            
            const saveButton = document.createElement('button');
            saveButton.innerHTML = 'üíæ Salvar';
            saveButton.className = 'text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition-colors';
            
            const cancelButton = document.createElement('button');
            cancelButton.innerHTML = '‚ùå Cancelar';
            cancelButton.className = 'text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors ml-1';
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(inputContainer);
            contentDiv.appendChild(saveButton);
            contentDiv.appendChild(cancelButton);
            
            input.focus();
            
            const cancel = () => {
                contentDiv.innerHTML = '';
                contentDiv.appendChild(textSpan);
                contentDiv.appendChild(editButton);
                editButton.style.display = 'block';
            };
            
            const save = async () => {
                const newText = input.value.trim();
                
                if (!newText) {
                    errorDiv.textContent = '‚ö†Ô∏è Resposta n√£o pode estar vazia';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                saveButton.disabled = true;
                cancelButton.disabled = true;
                saveButton.textContent = '‚è≥ Salvando...';
                
                try {
                    const response = await fetch(`${API_URL}/chat/${sessionId}/answer/${step}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: newText, llm_provider: 'groq' })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        errorDiv.textContent = '‚ö†Ô∏è ' + (data.detail || 'Erro ao atualizar resposta');
                        errorDiv.classList.remove('hidden');
                        saveButton.disabled = false;
                        cancelButton.disabled = false;
                        saveButton.textContent = 'üíæ Salvar';
                        input.focus();
                        return;
                    }
                    
                    errorDiv.classList.add('hidden');
                    textSpan.textContent = newText;
                    messageDiv.dataset.currentText = newText;
                    
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(textSpan);
                    contentDiv.appendChild(editButton);
                    editButton.style.display = 'block';
                    
                    // Atualizar sidebar com nova resposta E marcar como answered
                    updateSidebarAnswer(step, newText);
                    updateSidebarStatus(step, 'answered');
                    
                    // ‚úÖ SALVAR RASCUNHO ap√≥s edi√ß√£o
                    saveDraft();
                    
                    const successDiv = document.createElement('div');
                    successDiv.className = 'text-sm text-green-300 mt-1';
                    successDiv.textContent = '‚úÖ Salvo!';
                    bubbleDiv.appendChild(successDiv);
                    
                    setTimeout(() => successDiv.remove(), 2000);
                    
                    // Bug #2 fix: Remover erro e mostrar pr√≥xima pergunta
                    let nextElement = messageDiv.nextElementSibling;
                    let hadError = false;
                    
                    while (nextElement) {
                        const errorDiv = nextElement.querySelector('.bg-red-100');
                        if (errorDiv) {
                            nextElement.remove();
                            hadError = true;
                            break;
                        }
                        nextElement = nextElement.nextElementSibling;
                    }
                    
                    if (hadError) {
                        const stepNum = parseInt(step.split('.')[1]);
                        
                        if (stepNum < 6) {
                            const nextStep = `1.${stepNum + 1}`;
                            const nextQuestion = QUESTIONS[nextStep];
                            
                            if (nextQuestion) {
                                // CR√çTICO: Atualizar currentQuestionStep ANTES de mostrar pergunta
                                currentQuestionStep = nextStep;
                                
                                // Atualizar sidebar
                                updateSidebarStatus(nextStep, 'current');
                                updateSidebarProgress(stepNum, 6);
                                
                                // Mostrar pr√≥xima pergunta
                                addMessage(nextQuestion, true, false, nextStep, `evt_${nextStep}_after_edit`);
                                
                                // Habilitar input
                                enableInput();
                            }
                        }
                    }
                    
                } catch (error) {
                    errorDiv.textContent = '‚ö†Ô∏è Erro: ' + error.message;
                    errorDiv.classList.remove('hidden');
                    saveButton.disabled = false;
                    cancelButton.disabled = false;
                    saveButton.textContent = 'üíæ Salvar';
                }
            };
            
            cancelButton.onclick = cancel;
            saveButton.onclick = save;
            input.onkeypress = (e) => {
                if (e.key === 'Enter') save();
                if (e.key === 'Escape') cancel();
            };
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="bg-gray-200 text-gray-600 p-3 rounded-lg"><span class="animate-pulse">Processando...</span></div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        function disableInput() {
            userInput.disabled = true;
            sendButton.disabled = true;
            isWaitingResponse = true;
        }

        function enableInput() {
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            isWaitingResponse = false;
            
            // Sugerir data/hora atual para pergunta 1.1
            if (currentQuestionStep === '1.1' && userInput.value === '') {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                
                userInput.value = `${day}/${month}/${year}, ${hour}h${minute}`;
                userInput.select(); // Seleciona o texto para facilitar edi√ß√£o
            }
        }

        async function startSession() {
            try {
                const response = await fetch(`${API_URL}/new_session`, { method: 'POST' });
                if (!response.ok) throw new Error('Erro ao iniciar sess√£o');

                const data = await response.json();
                sessionId = data.session_id;
                currentBoId = data.bo_id;
                currentQuestionStep = '1.1';
                currentSection = 1;
                answersState = {}; // Resetar respostas
                boCompleted = false; // Resetar flag de BO completo

                console.log('Sess√£o iniciada:', { sessionId, currentBoId });

                addMessage('Ol√°! Vou te ajudar a fazer o BO de tr√°fico de drogas, simples, t√©cnico e dentro da lei. Vou perguntar uma coisa por vez. Responda com o que voc√™ viu, sem arredondar. Se algo n√£o se aplicar, escreva "N√ÉO".', true, false, null, 'welcome');

                setTimeout(() => {
                    addMessage(data.first_question, true, false, '1.1', 'evt_first_question');
                    enableInput();
                    updateSidebarProgress(0, 7);
                }, 500);

            } catch (error) {
                addMessage('‚ùå Erro ao conectar com o servidor. Verifique se o backend est√° rodando.');
                console.error(error);
            }
        }

        function updateHeaderSection() {
            const headerSubtitle = document.querySelector('header p');
            if (headerSubtitle) {
                if (currentSection === 1) {
                    headerSubtitle.textContent = 'Se√ß√£o 1 - Contexto da Ocorr√™ncia';
                } else if (currentSection === 2) {
                    headerSubtitle.textContent = 'Se√ß√£o 2 - Abordagem a Ve√≠culo';
                } else if (currentSection === 3) {
                    headerSubtitle.textContent = 'Se√ß√£o 3 - Campana';
                } else if (currentSection === 4) {
                    headerSubtitle.textContent = 'Se√ß√£o 4 - Entrada em Domic√≠lio';
                } else if (currentSection === 5) {
                    headerSubtitle.textContent = 'Se√ß√£o 5 - Fundada Suspeita';
                } else if (currentSection === 6) {
                    headerSubtitle.textContent = 'Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa';
                } else if (currentSection === 7) {
                    headerSubtitle.textContent = 'Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia';
                } else if (currentSection === 8) {
                    headerSubtitle.textContent = 'Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL)';
                }
            }
        }

        async function startSection2() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section2');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 2');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 2;
                currentQuestionStep = data.current_step;
                // N√ÉO resetar answersState! Ele deve manter todas as respostas (Se√ß√£o 1 + 2)

                console.log('Se√ß√£o 2 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 2 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section2-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section2-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 2
                addMessage('üìã Iniciando Se√ß√£o 2 - Abordagem a Ve√≠culo', true, false, null, 'evt_section2_start');

                // Adicionar primeira pergunta da Se√ß√£o 2
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section2_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 2
                    updateSidebarForSection2();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 2:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 2. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section2');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, havia ve√≠culo';
                }
            }
        }

        async function startSection3() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section3');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/3`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 3');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 3;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 3 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 3 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section3-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section3-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 3
                addMessage('üìã Iniciando Se√ß√£o 3 - Campana (Vigil√¢ncia Velada)', true, false, null, 'evt_section3_start');

                // Adicionar primeira pergunta da Se√ß√£o 3
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section3_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 3
                    updateSidebarForSection3();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 3:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 3. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section3');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve campana';
                }
            }
        }

        async function startSection4() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section4');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/4`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 4');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 4;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 4 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 4 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section4-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section4-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 4
                addMessage('üè† Iniciando Se√ß√£o 4 - Entrada em Domic√≠lio', true, false, null, 'evt_section4_start');

                // Adicionar primeira pergunta da Se√ß√£o 4
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section4_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 4
                    updateSidebarForSection4();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 4:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 4. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section4');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve entrada em domic√≠lio';
                }
            }
        }

        async function startSection5() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section5');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/5`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 5');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 5;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 5 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 5 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section5-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section5-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 5
                addMessage('üéØ Iniciando Se√ß√£o 5 - Fundada Suspeita', true, false, null, 'evt_section5_start');

                // Adicionar primeira pergunta da Se√ß√£o 5
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section5_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 5
                    updateSidebarForSection5();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 5:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 5. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section5');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve fundada suspeita';
                }
            }
        }

        async function startSection6() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section6');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/6`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 6');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 6;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 6 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 6 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section6-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section6-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 6
                addMessage('üí™ Iniciando Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa', true, false, null, 'evt_section6_start');

                // Adicionar primeira pergunta da Se√ß√£o 6
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section6_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 6
                    updateSidebarForSection6();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 6:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 6. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section6');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve resist√™ncia';
                }
            }
        }

        async function startSection7() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section7');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/7`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 7');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 7;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 7 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 7
                const transitionCard = document.getElementById('section7-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section7-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 7
                addMessage('üì¶ Iniciando Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia', true, false, null, 'evt_section7_start');

                // Adicionar primeira pergunta da Se√ß√£o 7
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section7_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 7
                    updateSidebarForSection7();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 7:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 7. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section7');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve apreens√£o';
                }
            }
        }

        async function startSection8() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section8');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/8`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 8');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 8;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 8 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 8
                const transitionCard = document.getElementById('section8-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section8-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 8
                addMessage('‚öñÔ∏è Iniciando Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (√öLTIMA SE√á√ÉO)', true, false, null, 'evt_section8_start');

                // Adicionar primeira pergunta da Se√ß√£o 8
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section8_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 8
                    updateSidebarForSection8();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 8:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 8. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section8');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚ñ∂Ô∏è Iniciar Se√ß√£o 8';
                }
            }
        }

        async function skipSection(sectionNumber) {
            if (!sessionId) {
                showToast('‚ùå Nenhuma sess√£o ativa');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/skip_section/${sectionNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) throw new Error('Erro ao pular se√ß√£o');

                const data = await response.json();

                // Atualizar se√ß√£o atual
                currentSection = sectionNumber;

                // Mostrar mensagem no chat
                addMessage(`‚úÖ Se√ß√£o ${sectionNumber} n√£o se aplica.`, true);

                // Atualizar card da se√ß√£o como "Pulada"
                addSkippedSectionText(sectionNumber, data.generated_text);

                // Remover AMBOS os poss√≠veis containers do bot√£o atual
                const buttonContainer = document.getElementById(`section${sectionNumber}-button-container`);
                if (buttonContainer) buttonContainer.remove();
                const transitionCard = document.getElementById(`section${sectionNumber}-transition-card`);
                if (transitionCard) transitionCard.remove();

                // Desabilitar input
                disableInput();

                // üìç Scroll at√© o final para ver o card de se√ß√£o pulada
                setTimeout(() => {
                    window.scrollTo({
                        top: document.documentElement.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 300);

                // Mostrar mensagem de orienta√ß√£o
                if (sectionNumber < 8) {
                    addMessage('‚¨áÔ∏è Role para baixo para ver o bot√£o da pr√≥xima se√ß√£o.', true, false, null, 'evt_scroll_guidance');

                    // Criar bot√£o da pr√≥xima se√ß√£o
                    setTimeout(() => {
                        const nextSectionNum = sectionNumber + 1;
                        const nextSection = ALL_SECTIONS[nextSectionNum];
                        const nextSectionButtonDiv = document.createElement('div');
                        nextSectionButtonDiv.id = `section${nextSectionNum}-button-container`;

                        // Definir cores por se√ß√£o
                        const sectionColors = {
                            2: { bg: 'from-blue-50 to-indigo-50', border: 'border-blue-200', text: 'text-blue-900', btn: 'bg-blue-600 hover:bg-blue-700' },
                            3: { bg: 'from-purple-50 to-indigo-50', border: 'border-purple-200', text: 'text-purple-900', btn: 'bg-purple-600 hover:bg-purple-700' },
                            4: { bg: 'from-orange-50 to-orange-100', border: 'border-orange-200', text: 'text-orange-900', btn: 'bg-orange-600 hover:bg-orange-700' },
                            5: { bg: 'from-pink-50 to-pink-100', border: 'border-pink-200', text: 'text-pink-900', btn: 'bg-pink-600 hover:bg-pink-700' },
                            6: { bg: 'from-teal-50 to-cyan-50', border: 'border-teal-200', text: 'text-teal-900', btn: 'bg-teal-600 hover:bg-teal-700' },
                            7: { bg: 'from-amber-50 to-amber-100', border: 'border-amber-200', text: 'text-amber-900', btn: 'bg-amber-600 hover:bg-amber-700' },
                            8: { bg: 'from-indigo-50 to-indigo-100', border: 'border-indigo-200', text: 'text-indigo-900', btn: 'bg-indigo-600 hover:bg-indigo-700' }
                        };

                        const colors = sectionColors[nextSectionNum];
                        nextSectionButtonDiv.className = `mt-6 p-6 bg-gradient-to-r ${colors.bg} border-2 ${colors.border} rounded-xl text-center`;

                        // Textos contextuais
                        const sectionTexts = {
                            2: 'Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.',
                            3: 'A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.',
                            4: 'Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.',
                            5: 'Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.',
                            6: 'Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.',
                            7: 'Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.',
                            8: '√öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.'
                        };

                        const startTexts = {
                            2: 'Sim, havia ve√≠culo',
                            3: 'Sim, houve campana',
                            4: 'Sim, houve entrada em domic√≠lio',
                            5: 'Sim, houve fundada suspeita',
                            6: 'Sim, houve resist√™ncia',
                            7: 'Sim, houve apreens√£o'
                        };

                        const skipTexts = {
                            2: 'N√£o havia ve√≠culo',
                            3: 'N√£o houve campana',
                            4: 'N√£o houve entrada em domic√≠lio',
                            5: 'N√£o houve fundada suspeita',
                            6: 'N√£o houve resist√™ncia',
                            7: 'N√£o houve apreens√£o'
                        };

                        let buttonsHTML = '';
                        if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                            buttonsHTML = `
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button id="btn-skip-section${nextSectionNum}" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è ${skipTexts[nextSectionNum]}
                                    </button>
                                    <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 ${colors.btn} text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ ${startTexts[nextSectionNum]}
                                    </button>
                                </div>
                            `;
                        } else {
                            buttonsHTML = `
                                <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 ${colors.btn} text-white font-semibold rounded-lg transition-colors">
                                    ‚ñ∂Ô∏è Iniciar Se√ß√£o ${nextSectionNum}${nextSectionNum === 8 ? ' (FINAL)' : ''}
                                </button>
                            `;
                        }

                        nextSectionButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold ${colors.text} mb-2">${nextSection.emoji} Se√ß√£o ${nextSectionNum}: ${nextSection.name}</h3>
                            <p class="text-gray-700 mb-4">
                                ${sectionTexts[nextSectionNum]}
                            </p>
                            ${buttonsHTML}
                        `;

                        generatedSectionsContainer.parentElement.appendChild(nextSectionButtonDiv);

                        // Event listeners
                        const startFunctionName = `startSection${nextSectionNum}`;
                        if (window[startFunctionName]) {
                            document.getElementById(`btn-start-section${nextSectionNum}`).addEventListener('click', window[startFunctionName]);
                        }
                        if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                            document.getElementById(`btn-skip-section${nextSectionNum}`).addEventListener('click', () => skipSection(nextSectionNum));
                        }
                    }, 500);
                }

                // Salvar rascunho
                saveDraft();

            } catch (error) {
                console.error('[Skip] Erro:', error);
                showToast('‚ùå Erro ao pular se√ß√£o');
            }
        }

        async function sendMessage() {
			const message = userInput.value.trim();
			if (!message || isWaitingResponse) return;

			// Capturar step ANTES de enviar
			const displayStep = currentQuestionStep;

			// ‚úÖ ADICIONAR AQUI (depois da linha 774, antes do addMessage):
			// Auto-completar ano se faltando (step 1.1)
			let finalMessage = message;
			if (displayStep === '1.1' && !/20\d{2}/.test(message)) {
				finalMessage = message + ` de ${new Date().getFullYear()}`;
			}

			addMessage(finalMessage, false, false, displayStep);  // ‚Üê USAR finalMessage
			userInput.value = '';

			disableInput();
			showLoading();

			try {
				const response = await fetch(`${API_URL}/chat`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						session_id: sessionId,
						message: finalMessage,  // ‚Üê USAR finalMessage AQUI TAMB√âM
						current_section: currentSection,  // ‚úÖ NOVO: Enviar se√ß√£o atual
						llm_provider: 'groq'
					})
				});
                
                if (!response.ok) throw new Error('Erro ao processar resposta');
                
                const data = await response.json();
                removeLoading();
                
                if (data.bo_id) {
                    currentBoId = data.bo_id;
                }
                
                // CR√çTICO: Usar step do BACKEND, n√£o da vari√°vel local
                // Isso garante que ap√≥s edi√ß√£o, usamos o step correto
                const actualStep = data.validation_error ? displayStep : (data.current_step || displayStep);
                
                // Atualizar sidebar com resposta (usar displayStep que foi enviado)
                updateSidebarAnswer(displayStep, message);
                
                // Anexar event_id
                if (data.event_id) {
                    const lastUserMessage = chatContainer.querySelector('.message-container:last-of-type');
                    if (lastUserMessage) {
                        lastUserMessage.dataset.eventId = data.event_id;
                        
                        const bubbleDiv = lastUserMessage.querySelector('.bg-blue-600');
                        if (bubbleDiv && !bubbleDiv.querySelector('.feedback-buttons')) {
                            const feedbackDiv = document.createElement('div');
                            feedbackDiv.className = 'feedback-buttons flex gap-2 mt-2 justify-end';
                            
                            const thumbsUp = document.createElement('button');
                            thumbsUp.innerHTML = 'üëç';
                            thumbsUp.className = 'feedback-btn';
                            thumbsUp.onclick = function() {
                                sendFeedback(data.event_id, 'positive', this);
                            };
                            
                            const thumbsDown = document.createElement('button');
                            thumbsDown.innerHTML = 'üëé';
                            thumbsDown.className = 'feedback-btn';
                            thumbsDown.onclick = function() {
                                openFeedbackModal(data.event_id, message, displayStep, this);
                            };
                            
                            feedbackDiv.appendChild(thumbsUp);
                            feedbackDiv.appendChild(thumbsDown);
                            bubbleDiv.appendChild(feedbackDiv);
                        }
                    }
                }
                
                // Atualizar currentQuestionStep com valor do backend
                if (!data.is_section_complete && data.current_step) {
                    currentQuestionStep = data.current_step;
                }
                
                if (data.validation_error) {
                    addMessage('‚ö†Ô∏è ' + data.validation_error, true, true, null, data.event_id || 'evt_validation_error');
                    enableInput();
                    return;
                }

                // Calcular progresso baseado na se√ß√£o atual
                let progress, totalQuestions;
                if (currentSection === 1) {
                    progress = data.current_step === 'complete' ? 6 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 6;
                } else if (currentSection === 2) {
                    progress = data.current_step === 'complete' ? 8 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 8;
                } else if (currentSection === 3) {
                    progress = data.current_step === 'complete' ? 8 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 8;
                } else if (currentSection === 4) {
                    progress = data.current_step === 'complete' ? 5 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 5;
                } else if (currentSection === 5) {
                    progress = data.current_step === 'complete' ? 4 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 4;
                } else if (currentSection === 6) {
                    progress = data.current_step === 'complete' ? 5 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 5;
                } else if (currentSection === 7) {
                    progress = data.current_step === 'complete' ? 4 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 4;
                } else if (currentSection === 8) {
                    progress = data.current_step === 'complete' ? 6 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 6;
                }

                // Atualizar sidebar com step que FOI VALIDADO (displayStep)
                updateSidebarStatus(displayStep, 'answered');
                updateSidebarProgress(progress, totalQuestions);

                if (data.is_section_complete) {
                    // ‚úÖ LIMPAR RASCUNHO ao completar (ANTES de qualquer outra a√ß√£o)
                    clearDraft();

                    // ‚ö†Ô∏è VERIFICAR SE SE√á√ÉO FOI PULADA (v0.9.0)
                    if (data.section_skipped) {
                        const section = ALL_SECTIONS[currentSection];
                        addMessage(`‚úÖ Se√ß√£o ${currentSection} n√£o se aplica.`, true, false, null, 'evt_section_skipped');

                        // Adicionar texto de se√ß√£o pulada no card correto (mantendo ordem)
                        addSkippedSectionText(currentSection, data.generated_text);

                        // Desabilitar inputs e preparar para pr√≥xima se√ß√£o
                        disableInput();

                        // Mostrar mensagem de orienta√ß√£o ou conclus√£o
                        if (currentSection < 8) {
                            addMessage('‚¨áÔ∏è Role para baixo para ver o texto gerado e clique no bot√£o para continuar para a pr√≥xima se√ß√£o.', true, false, null, 'evt_scroll_guidance');
                        } else {
                            addMessage('üéâ Parab√©ns! Voc√™ chegou ao final do BO! Todas as se√ß√µes foram processadas.', true, false, null, 'evt_completion');
                        }

                        // Mostrar bot√£o para pr√≥xima se√ß√£o (se n√£o for a √∫ltima)
                        if (currentSection < 8) {
                            setTimeout(() => {
                                const nextSectionNum = currentSection + 1;
                                const nextSection = ALL_SECTIONS[nextSectionNum];
                                const nextSectionButtonDiv = document.createElement('div');
                                nextSectionButtonDiv.id = `section${nextSectionNum}-transition-card`;
                                nextSectionButtonDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center fade-in';

                                // Criar o HTML com base na pr√≥xima se√ß√£o (reusando a l√≥gica existente)
                                let buttonHTML = `
                                    <h3 class="font-bold text-blue-900 mb-2">${nextSection.emoji} Se√ß√£o ${nextSectionNum} - ${nextSection.name}</h3>
                                    <p class="text-sm text-blue-700 mb-3">`;

                                // Adicionar textos contextuais para cada se√ß√£o
                                switch(nextSectionNum) {
                                    case 3:
                                        buttonHTML += 'A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 4:
                                        buttonHTML += 'Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 5:
                                        buttonHTML += 'Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 6:
                                        buttonHTML += 'Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 7:
                                        buttonHTML += 'Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 8:
                                        buttonHTML += '√öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.';
                                        break;
                                }

                                buttonHTML += `
                                    </p>`;

                                // Adicionar bot√µes (com skip apenas para se√ß√µes 2-7)
                                if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                                    const startTexts = {
                                        2: 'Sim, havia ve√≠culo',
                                        3: 'Sim, houve campana',
                                        4: 'Sim, houve entrada em domic√≠lio',
                                        5: 'Sim, houve fundada suspeita',
                                        6: 'Sim, houve resist√™ncia',
                                        7: 'Sim, houve apreens√£o'
                                    };
                                    const skipTexts = {
                                        2: 'N√£o havia ve√≠culo',
                                        3: 'N√£o houve campana',
                                        4: 'N√£o houve entrada em domic√≠lio',
                                        5: 'N√£o houve fundada suspeita',
                                        6: 'N√£o houve resist√™ncia',
                                        7: 'N√£o houve apreens√£o'
                                    };
                                    buttonHTML += `
                                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                            <button id="btn-skip-section${nextSectionNum}" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                                ‚è≠Ô∏è ${skipTexts[nextSectionNum]}
                                            </button>
                                            <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                                ‚úÖ ${startTexts[nextSectionNum]}
                                            </button>
                                        </div>
                                    `;
                                } else {
                                    buttonHTML += `
                                        <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                            ‚ñ∂Ô∏è Iniciar Se√ß√£o ${nextSectionNum}
                                        </button>
                                    `;
                                }

                                nextSectionButtonDiv.innerHTML = buttonHTML;
                                generatedSectionsContainer.parentElement.appendChild(nextSectionButtonDiv);

                                // Adicionar event listeners din√¢micos
                                const startFunctionName = `startSection${nextSectionNum}`;
                                if (window[startFunctionName]) {
                                    document.getElementById(`btn-start-section${nextSectionNum}`).addEventListener('click', window[startFunctionName]);
                                }
                                if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                                    document.getElementById(`btn-skip-section${nextSectionNum}`).addEventListener('click', () => skipSection(nextSectionNum));
                                }
                            }, 500);
                        }

                        return;
                    }

                    let completionMessage;
                    if (currentSection === 1) {
                        completionMessage = '‚úÖ Se√ß√£o 1 completa! Gerando texto...';
                    } else if (currentSection === 2) {
                        completionMessage = '‚úÖ Se√ß√£o 2 completa! Gerando texto...';
                    } else if (currentSection === 3) {
                        completionMessage = '‚úÖ Se√ß√£o 3 completa! Gerando texto...';
                    } else if (currentSection === 4) {
                        completionMessage = '‚úÖ Se√ß√£o 4 completa! Gerando texto...';
                    } else if (currentSection === 5) {
                        completionMessage = '‚úÖ Se√ß√£o 5 completa! Gerando texto...';
                    } else if (currentSection === 6) {
                        completionMessage = '‚úÖ Se√ß√£o 6 completa! Gerando texto...';
                    } else if (currentSection === 7) {
                        completionMessage = '‚úÖ Se√ß√£o 7 completa! Gerando texto...';
                        // N√ÉO marcar boCompleted aqui - Se√ß√£o 8 ainda vir√°
                    } else if (currentSection === 8) {
                        completionMessage = '‚úÖ Se√ß√£o 8 completa! Gerando texto final...';
                        // CR√çTICO: Se√ß√£o 8 √© a √öLTIMA - marcar BO como completo
                        boCompleted = true;
                        console.log('[BO] BO marcado como COMPLETO!');
                    }

                    addMessage(completionMessage, true, false, null, 'evt_generating');
                    setTimeout(() => {
                        // ‚úÖ NOVO: Adicionar texto ao container persistente
                        addGeneratedSectionText(currentSection, data.generated_text);

                        // ‚úÖ Adicionar mensagem de confirma√ß√£o que o texto foi gerado
                        if (currentSection === 8 && boCompleted) {
                            addMessage('üìã Texto da Se√ß√£o 8 foi gerado abaixo! Todas as se√ß√µes foram finalizadas. Copie o BO completo usando o bot√£o abaixo.', true, false, null, 'evt_text_generated');
                        } else {
                            addMessage(`üìù Texto da Se√ß√£o ${currentSection} foi gerado abaixo. Voc√™ pode copiar o texto e clicar no bot√£o para continuar para a pr√≥xima se√ß√£o.`, true, false, null, 'evt_text_generated');
                        }

                        // ‚úÖ Bot√µes para iniciar pr√≥xima se√ß√£o (SOMENTE se BO n√£o est√° completo)
                        if (currentSection === 1 && !boCompleted) {
                            const section2ButtonDiv = document.createElement('div');
                            section2ButtonDiv.id = 'section2-transition-card';
                            section2ButtonDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center fade-in';
                            section2ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-blue-900 mb-2">üöó Se√ß√£o 2 - Abordagem a Ve√≠culo</h3>
                                <p class="text-sm text-blue-700 mb-3">
                                    Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section2"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o havia ve√≠culo
                                    </button>
                                    <button
                                        id="btn-start-section2"
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, havia ve√≠culo
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section2ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section2').addEventListener('click', startSection2);
                            document.getElementById('btn-skip-section2').addEventListener('click', () => skipSection(2));
                        } else if (currentSection === 2 && !boCompleted) {
                            const section3ButtonDiv = document.createElement('div');
                            section3ButtonDiv.id = 'section3-transition-card';
                            section3ButtonDiv.className = 'mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg text-center fade-in';
                            section3ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-purple-900 mb-2">üëÅÔ∏è Se√ß√£o 3 - Campana</h3>
                                <p class="text-sm text-purple-700 mb-3">
                                    A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section3"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve campana
                                    </button>
                                    <button
                                        id="btn-start-section3"
                                        class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve campana
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section3ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section3').addEventListener('click', startSection3);
                            document.getElementById('btn-skip-section3').addEventListener('click', () => skipSection(3));
                        } else if (currentSection === 3 && !boCompleted) {
                            const section4ButtonDiv = document.createElement('div');
                            section4ButtonDiv.id = 'section4-transition-card';
                            section4ButtonDiv.className = 'mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-center fade-in';
                            section4ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-orange-900 mb-2">üè† Se√ß√£o 4 - Entrada em Domic√≠lio</h3>
                                <p class="text-sm text-orange-700 mb-3">
                                    Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section4"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve entrada em domic√≠lio
                                    </button>
                                    <button
                                        id="btn-start-section4"
                                        class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve entrada em domic√≠lio
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section4ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section4').addEventListener('click', startSection4);
                            document.getElementById('btn-skip-section4').addEventListener('click', () => skipSection(4));
                        } else if (currentSection === 4 && !boCompleted) {
                            const section5ButtonDiv = document.createElement('div');
                            section5ButtonDiv.id = 'section5-transition-card';
                            section5ButtonDiv.className = 'mt-4 p-4 bg-pink-50 border border-pink-200 rounded-lg text-center fade-in';
                            section5ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-pink-900 mb-2">üéØ Se√ß√£o 5 - Fundada Suspeita</h3>
                                <p class="text-sm text-pink-700 mb-3">
                                    Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section5"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve fundada suspeita
                                    </button>
                                    <button
                                        id="btn-start-section5"
                                        class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve fundada suspeita
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section5ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section5').addEventListener('click', startSection5);
                            document.getElementById('btn-skip-section5').addEventListener('click', () => skipSection(5));
                        } else if (currentSection === 5 && !boCompleted) {
                            const section6ButtonDiv = document.createElement('div');
                            section6ButtonDiv.id = 'section6-transition-card';
                            section6ButtonDiv.className = 'mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg text-center fade-in';
                            section6ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-teal-900 mb-2">üí™ Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa</h3>
                                <p class="text-sm text-teal-700 mb-3">
                                    Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section6"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve resist√™ncia
                                    </button>
                                    <button
                                        id="btn-start-section6"
                                        class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve resist√™ncia
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section6ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section6').addEventListener('click', startSection6);
                            document.getElementById('btn-skip-section6').addEventListener('click', () => skipSection(6));
                        } else if (currentSection === 6 && !boCompleted) {
                            const section7ButtonDiv = document.createElement('div');
                            section7ButtonDiv.id = 'section7-transition-card';
                            section7ButtonDiv.className = 'mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-center fade-in';
                            section7ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-amber-900 mb-2">üì¶ Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia</h3>
                                <p class="text-sm text-amber-700 mb-3">
                                    Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section7"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve apreens√£o
                                    </button>
                                    <button
                                        id="btn-start-section7"
                                        class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve apreens√£o
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section7ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section7').addEventListener('click', startSection7);
                            document.getElementById('btn-skip-section7').addEventListener('click', () => skipSection(7));
                        } else if (currentSection === 7 && !boCompleted) {
                            const section8ButtonDiv = document.createElement('div');
                            section8ButtonDiv.id = 'section8-transition-card';
                            section8ButtonDiv.className = 'mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-center fade-in';
                            section8ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-indigo-900 mb-2">‚öñÔ∏è Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (√öLTIMA SE√á√ÉO)</h3>
                                <p class="text-sm text-indigo-700 mb-3">
                                    √öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.
                                </p>
                                <div class="bg-amber-50 border border-amber-300 rounded-md p-3 mb-3">
                                    <p class="text-sm font-semibold text-amber-800">üì∑ ATEN√á√ÉO: Fotografar itens apreendidos e anexar no BO</p>
                                </div>
                                <button
                                    id="btn-start-section8"
                                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚ñ∂Ô∏è Iniciar Se√ß√£o 8 (FINAL)
                                </button>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section8ButtonDiv);

                            // Event listener para o bot√£o
                            document.getElementById('btn-start-section8').addEventListener('click', startSection8);
                        } else if (currentSection === 8 && boCompleted) {
                            // CR√çTICO: Se√ß√£o 8 completa - Exibir card de conclus√£o final
                            const completionCard = document.createElement('div');
                            completionCard.id = 'bo-completion-card';
                            completionCard.className = 'mt-6 p-6 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-xl text-center fade-in';
                            completionCard.innerHTML = `
                                <div class="text-5xl mb-3">‚úÖ</div>
                                <h3 class="text-2xl font-bold text-green-900 mb-3">BO COMPLETO!</h3>
                                <p class="text-green-700 mb-4">Todas as 8 se√ß√µes foram preenchidas com sucesso.</p>
                                <div class="flex flex-col sm:flex-row justify-center gap-3">
                                    <button id="btn-copy-final" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                                        üìã Copiar BO Completo
                                    </button>
                                    <button id="btn-new-bo" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚ûï Iniciar Novo BO
                                    </button>
                                </div>
                            `;
                            generatedSectionsContainer.parentElement.appendChild(completionCard);

                            // Event listeners
                            document.getElementById('btn-copy-final').addEventListener('click', copyAllSections);
                            document.getElementById('btn-new-bo').addEventListener('click', () => {
                                clearDraft();
                                window.location.reload();
                            });
                        }

                        // üìç Scroll suave para o final da p√°gina (para ver texto gerado + bot√£o pr√≥xima se√ß√£o)
                        window.scrollTo({
                            top: document.documentElement.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 1000);
                } else {
                    // ‚úÖ SALVAR RASCUNHO ap√≥s resposta v√°lida (apenas se se√ß√£o N√ÉO est√° completa)
                    saveDraft();

                    updateSidebarStatus(currentQuestionStep, 'current');
                    addMessage(data.question, true, false, currentQuestionStep, data.event_id);
                    enableInput();
                }

            } catch (error) {
                removeLoading();
                addMessage('‚ùå Erro ao processar sua resposta. Tente novamente.');
                console.error(error);
                enableInput();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Draft modal event listeners
        draftContinueBtn.addEventListener('click', async () => {
            hideDraftModal();
            const draft = loadDraft();
            if (draft) {
                await restoreFromDraft(draft);
            } else {
                startSession();
            }
        });

        draftDiscardBtn.addEventListener('click', () => {
            hideDraftModal();
            clearDraft();
            startSession();
        });

        // ================================================================
        // INICIALIZA√á√ÉO
        // ================================================================
        
        window.addEventListener('load', () => {
            initializeSidebar();
            
            // Verificar se existe rascunho salvo
            const draft = loadDraft();
            
            if (draft) {
                // Mostrar modal perguntando se quer continuar
                showDraftModal(draft);
            } else {
                // Iniciar nova sess√£o normalmente
                startSession();
            }
        });

        // Salvar rascunho antes de fechar p√°gina
        window.addEventListener('beforeunload', () => {
            // Apenas salvar rascunho se:
            // 1. Sess√£o existe
            // 2. H√° respostas salvas
            // 3. BO N√ÉO foi marcado como completo
            if (sessionId && Object.keys(answersState).length > 0 && !boCompleted) {
                console.log('[Draft] Salvando rascunho antes de fechar...');
                saveDraft();
            } else if (boCompleted) {
                console.log('[Draft] BO completo, n√£o salvando rascunho');
            }
        });
    </script>
</body>
</html>
