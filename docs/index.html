<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BO Inteligente - Tr√°fico de Drogas</title>
    <!-- Dados das se√ß√µes -->
    <script src="js/data/sections.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Anima√ß√µes suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Scrollbar customizada */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        /* Bot√µes de feedback */
        .feedback-btn {
            min-width: 40px;
            min-height: 40px;
            display: none; /* Temporariamente ocultado - Issue #19 */
            font-size: 18px;
            padding: 6px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feedback-btn:hover {
            transform: scale(1.1);
            border-color: #3b82f6;
        }
        
        .feedback-btn:active {
            transform: scale(0.95);
        }
        
        .feedback-btn.clicked {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Mobile: Sidebar colaps√°vel */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease;
            }

            #sidebar.open {
                left: 0;
            }

            #sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            #sidebar-overlay.open {
                display: block;
            }

            .feedback-btn {
                min-width: 56px;
                min-height: 56px;
                font-size: 24px;
            }

            /* Container de textos gerados: sections collapsed por padr√£o em mobile */
            #generated-sections-container details {
                margin-bottom: 0.5rem;
            }

            #generated-sections-container details[open] summary {
                border-bottom: 1px solid #e5e7eb;
            }
        }

        /* Modal de rascunho */
        .draft-modal {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Badges de step em mobile - font menor */
        @media (max-width: 768px) {
            #questions-list [id^="icon-"] {
                font-size: 0.65rem;
                width: 2rem;
            }
        }

        /* ============================================ */
        /* BARRA DE PROGRESSO - ESTILOS */
        /* ============================================ */

        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            position: relative;
        }

        .progress-node-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .progress-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        /* Estados das bolinhas */
        .progress-node--pending {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .progress-node--in-progress {
            background-color: #3b82f6;
            color: white;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            animation: pulse-progress 2s infinite;
        }

        .progress-node--completed {
            background-color: #10b981;
            color: white;
            border-color: #059669;
        }

        .progress-node--completed:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .progress-node--skipped {
            background-color: #9ca3af;
            color: white;
            border-color: #6b7280;
        }

        .progress-node--skipped::after {
            content: '‚è≠Ô∏è';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 12px;
        }

        /* Checkmark para se√ß√µes completas */
        .progress-node--completed::before {
            content: '‚úì';
            font-size: 18px;
        }

        /* Esconder n√∫mero quando completo */
        .progress-node--completed .node-number,
        .progress-node--skipped .node-number {
            display: none;
        }

        /* Linha de conex√£o entre bolinhas */
        .progress-line-container {
            flex: 1;
            height: 6px;
            background-color: #e5e7eb;
            margin: 0 -5px;
            position: relative;
            z-index: 1;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }

        /* Anima√ß√£o de pulsa√ß√£o para se√ß√£o atual */
        @keyframes pulse-progress {
            0%, 100% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1);
            }
        }

        /* Tooltip */
        .progress-tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .progress-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .progress-tooltip .tooltip-emoji {
            margin-right: 6px;
        }

        .progress-tooltip .tooltip-status {
            margin-left: 8px;
            font-size: 11px;
            opacity: 0.8;
        }

        /* Label abaixo da bolinha (n√∫mero da se√ß√£o) */
        .progress-node-label {
            margin-top: 6px;
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-node--in-progress + .progress-node-label,
        .progress-node-wrapper:has(.progress-node--in-progress) .progress-node-label {
            color: #3b82f6;
            font-weight: 700;
        }

        /* Responsividade Mobile */
        @media (max-width: 768px) {
            .progress-bar {
                padding: 8px 10px;
            }

            .progress-node {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .progress-line-container {
                height: 4px;
            }

            .progress-node-label {
                font-size: 10px;
            }

            .progress-tooltip {
                font-size: 11px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 480px) {
            .progress-node {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            .progress-node--completed::before {
                font-size: 14px;
            }

            .progress-node--skipped::after {
                font-size: 10px;
                top: -6px;
                right: -6px;
            }
        }

        /* ============================================ */
        /* CONTAINER DE SE√á√ÉO - ESTILOS */
        /* ============================================ */

        .section-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 220px); /* Altura din√¢mica */
            min-height: 500px;
            overflow: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .section-container--hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute;
        }

        .section-container--visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Header da se√ß√£o */
        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .section-header__title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .section-header__emoji {
            font-size: 24px;
        }

        .section-header__badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .section-header__badge--in-progress {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .section-header__badge--completed {
            background-color: #d1fae5;
            color: #059669;
        }

        .section-header__badge--skipped {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        /* √Årea de chat */
        .section-chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-chat::-webkit-scrollbar {
            width: 6px;
        }

        .section-chat::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .section-chat::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .section-chat::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Mensagem do bot */
        .chat-message--bot {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 85%;
        }

        .chat-message__bubble--bot {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
            border-radius: 16px 16px 16px 4px;
            padding: 14px 18px;
            color: #1e40af;
        }

        .chat-message__text {
            font-size: 15px;
            line-height: 1.5;
        }

        .chat-message__hint {
            margin-top: 8px;
            font-size: 13px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-message__hint::before {
            content: 'üí°';
        }

        /* Mensagem do usu√°rio */
        .chat-message--user {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            max-width: 85%;
            align-self: flex-end;
        }

        .chat-message__bubble--user {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
            border-radius: 16px 16px 4px 16px;
            padding: 14px 18px;
            color: white;
        }

        /* √Årea de input */
        .section-input {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .section-input__form {
            display: flex;
            gap: 12px;
        }

        .section-input__field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .section-input__field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .section-input__field::placeholder {
            color: #9ca3af;
        }

        .section-input__button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .section-input__button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .section-input__button:active {
            transform: translateY(0);
        }

        .section-input__button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* √Årea de texto gerado */
        .section-generated {
            padding: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-top: 2px solid #86efac;
        }

        .section-generated__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-generated__title {
            font-weight: 600;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-generated__copy {
            padding: 8px 16px;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-generated__copy:hover {
            background: #15803d;
        }

        .section-generated__text {
            background: white;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.7;
            color: #374151;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        /* √Årea de transi√ß√£o (pr√≥xima se√ß√£o) */
        .section-transition {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .section-transition__preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .section-transition__preview-emoji {
            font-size: 32px;
        }

        .section-transition__preview-info {
            flex: 1;
        }

        .section-transition__preview-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-transition__preview-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .section-transition__buttons {
            display: flex;
            gap: 12px;
        }

        .section-transition__btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .section-transition__btn:hover {
            transform: translateY(-2px);
        }

        .section-transition__btn:active {
            transform: translateY(0);
        }

        .section-transition__btn--start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .section-transition__btn--start:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .section-transition__btn--skip {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .section-transition__btn--skip:hover {
            background: #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Modo leitura (se√ß√£o anterior) */
        .section-container--readonly .section-input {
            display: none;
        }

        .section-container--readonly .section-chat {
            padding-bottom: 20px;
        }

        .section-readonly-notice {
            padding: 12px 20px;
            background: #fef3c7;
            border-top: 1px solid #fcd34d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-readonly-notice__text {
            color: #92400e;
            font-size: 14px;
        }

        .section-readonly-notice__btn {
            padding: 8px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .section-readonly-notice__btn:hover {
            background: #d97706;
        }

        /* Loading state */
        .section-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .section-loading__spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .section-container {
                height: calc(100vh - 180px);
                min-height: 400px;
                border-radius: 8px;
            }

            .section-header {
                padding: 12px 16px;
            }

            .section-header__title {
                font-size: 16px;
            }

            .section-chat {
                padding: 16px;
                gap: 12px;
            }

            .chat-message--bot,
            .chat-message--user {
                max-width: 95%;
            }

            .section-input {
                padding: 12px 16px;
            }

            .section-input__form {
                flex-direction: column;
            }

            .section-input__button {
                width: 100%;
            }

            .section-transition__buttons {
                flex-direction: column;
            }

            .section-transition__btn {
                width: 100%;
            }
        }

        /* ============================================ */
        /* FIM CONTAINER DE SE√á√ÉO - ESTILOS */
        /* ============================================ */

        /* ============================================ */
        /* COMPONENTES DE INPUT - ESTILOS */
        /* ============================================ */

        /* Container gen√©rico de input */
        .input-component {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        /* -------------------------------------------- */
        /* TEXT INPUT */
        /* -------------------------------------------- */

        .text-input {
            display: flex;
            gap: 12px;
        }

        .text-input__field {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: white;
        }

        .text-input__field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .text-input__field::placeholder {
            color: #9ca3af;
        }

        .text-input__field--error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .text-input__field--error:focus {
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }

        .text-input__button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .text-input__button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .text-input__button:active:not(:disabled) {
            transform: translateY(0);
        }

        .text-input__button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .text-input__error {
            margin-top: 8px;
            padding: 8px 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .text-input__error::before {
            content: '‚ö†Ô∏è';
        }

        /* -------------------------------------------- */
        /* SINGLE CHOICE */
        /* -------------------------------------------- */

        .single-choice {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .single-choice__option {
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            padding: 16px 24px;
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .single-choice__option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .single-choice__option:active {
            transform: translateY(0);
        }

        .single-choice__option--selected {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .single-choice__option--yes {
            border-color: #10b981;
        }

        .single-choice__option--yes:hover {
            background: #d1fae5;
            border-color: #059669;
        }

        .single-choice__option--no {
            border-color: #f87171;
        }

        .single-choice__option--no:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .single-choice__option--primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: transparent;
        }

        .single-choice__option--primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .single-choice__icon {
            font-size: 20px;
        }

        /* -------------------------------------------- */
        /* MULTIPLE CHOICE */
        /* -------------------------------------------- */

        .multiple-choice {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .multiple-choice__options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .multiple-choice__option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multiple-choice__option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .multiple-choice__option--selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .multiple-choice__checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .multiple-choice__option--selected .multiple-choice__checkbox {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .multiple-choice__checkmark {
            color: white;
            font-size: 14px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }

        .multiple-choice__option--selected .multiple-choice__checkmark {
            opacity: 1;
            transform: scale(1);
        }

        .multiple-choice__label {
            font-size: 15px;
            color: #374151;
            flex: 1;
        }

        .multiple-choice__option--selected .multiple-choice__label {
            color: #1e40af;
            font-weight: 500;
        }

        .multiple-choice__confirm {
            margin-top: 12px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .multiple-choice__confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .multiple-choice__confirm:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .multiple-choice__hint {
            margin-top: 8px;
            font-size: 13px;
            color: #6b7280;
            text-align: center;
        }

        /* -------------------------------------------- */
        /* RESPONSIVIDADE */
        /* -------------------------------------------- */

        @media (max-width: 768px) {
            .input-component {
                padding: 12px 16px;
            }

            .text-input {
                flex-direction: column;
            }

            .text-input__button {
                width: 100%;
            }

            .single-choice {
                flex-direction: column;
            }

            .single-choice__option {
                max-width: none;
                width: 100%;
            }

            .multiple-choice__option {
                padding: 12px 14px;
            }

            .multiple-choice__checkbox {
                width: 22px;
                height: 22px;
            }
        }

        /* ============================================ */
        /* FIM COMPONENTES DE INPUT - ESTILOS */
        /* ============================================ */
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-900 text-white p-4 shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">üìã BO Inteligente v0.12.12</h1>
                    <p class="text-blue-200 text-sm">Se√ß√£o 1 - Contexto da Ocorr√™ncia</p>
                </div>
                <!-- Bot√£o mobile para abrir sidebar -->
                <button id="sidebar-toggle" class="md:hidden bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                    üìù Progresso
                </button>
            </div>
        </header>

        <!-- Overlay para mobile -->
        <div id="sidebar-overlay"></div>

        <!-- Modal de Rascunho Encontrado -->
        <div id="draft-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="draft-modal bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">üìÑ</div>
                    <h2 class="text-xl font-bold text-gray-800">Rascunho Encontrado!</h2>
                    <p class="text-gray-600 mt-2">Voc√™ tem um BO em andamento. Deseja continuar de onde parou?</p>
                </div>
                
                <div id="draft-preview" class="bg-gray-50 rounded-lg p-3 mb-4 text-sm text-gray-600">
                    <!-- Preview do rascunho ser√° inserido aqui -->
                </div>
                
                <div class="flex gap-3">
                    <button id="draft-continue" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                        ‚úÖ Continuar
                    </button>
                    <button id="draft-discard" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-semibold transition-colors">
                        üóëÔ∏è Come√ßar Novo
                    </button>
                </div>
                
                <p class="text-xs text-gray-400 text-center mt-3">
                    O rascunho √© salvo automaticamente a cada resposta
                </p>
            </div>
        </div>

        <!-- Main Content - Novo Layout -->
        <main class="flex-1 max-w-4xl w-full mx-auto p-4">
            <!-- ============================================ -->
            <!-- BARRA DE PROGRESSO -->
            <!-- ============================================ -->
            <div id="progress-bar-container" class="w-full bg-white rounded-lg shadow-lg p-4 mb-4">
                <div id="progress-bar" class="progress-bar">
                    <!-- Renderizado pelo ProgressBar -->
                </div>

                <!-- Tooltip -->
                <div id="progress-tooltip" class="progress-tooltip hidden">
                    <span class="tooltip-emoji"></span>
                    <span class="tooltip-name"></span>
                    <span class="tooltip-status"></span>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- CONTAINER DE SE√á√ÉO ATUAL -->
            <!-- ============================================ -->
            <div id="section-container" class="section-container section-container--visible">
                <!-- Renderizado pelo SectionContainer -->
            </div>

            <!-- ============================================ -->
            <!-- SIDEBAR ANTIGA (OCULTA - SER√Å REMOVIDA) -->
            <!-- ============================================ -->
            <aside id="sidebar" class="hidden">
                <!-- Conte√∫do antigo mantido para refer√™ncia -->
            </aside>

            <!-- Overlay para mobile (mantido para compatibilidade) -->
            <div id="sidebar-overlay" class="hidden"></div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 border-t border-gray-200 p-4 text-center text-sm text-gray-600">
            <p>BO Inteligente v0.12.12 | üíæ Rascunho salvo automaticamente</p>
        </footer>
    </div>

    <script>
        // ============================================
        // CLASSE PROGRESSBAR - BARRA DE PROGRESSO
        // ============================================

        class ProgressBar {
            /**
             * Componente de barra de progresso horizontal
             * Mostra 8 se√ß√µes com estados: pending, in_progress, completed, skipped
             */
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);
                this.tooltipEl = document.getElementById('progress-tooltip');

                // Dados das se√ß√µes (do sections.js ou passado por op√ß√µes)
                this.sections = options.sections || (window.SECTIONS_DATA ? window.SECTIONS_DATA.map(s => ({
                    id: s.id,
                    name: s.name,
                    emoji: s.emoji,
                    totalQuestions: s.questions.length + (s.skipQuestion ? 1 : 0)
                })) : []);

                // Estado de cada se√ß√£o
                this.sectionStates = {};
                this.sections.forEach(s => {
                    this.sectionStates[s.id] = {
                        status: 'pending', // pending, in_progress, completed, skipped
                        answeredCount: 0,
                        totalCount: s.totalQuestions
                    };
                });

                // Se√ß√£o atual
                this.currentSectionId = options.currentSection || 1;

                // Callback para navega√ß√£o
                this.onSectionClick = options.onSectionClick || ((sectionId) => {
                    console.log('[ProgressBar] Clicou na se√ß√£o:', sectionId);
                });

                // Renderizar
                if (this.container) {
                    this.render();
                }
            }

            /**
             * Renderiza a barra de progresso completa
             */
            render() {
                if (!this.container) return;

                this.container.innerHTML = '';

                this.sections.forEach((section, index) => {
                    // Wrapper da bolinha
                    const nodeWrapper = document.createElement('div');
                    nodeWrapper.className = 'progress-node-wrapper';

                    // Bolinha
                    const node = document.createElement('div');
                    node.className = 'progress-node';
                    node.dataset.sectionId = section.id;

                    // N√∫mero dentro da bolinha
                    const nodeNumber = document.createElement('span');
                    nodeNumber.className = 'node-number';
                    nodeNumber.textContent = section.id;
                    node.appendChild(nodeNumber);

                    // Aplicar estado visual
                    this._applyNodeState(node, section.id);

                    // Eventos
                    node.addEventListener('click', () => this._handleNodeClick(section.id));
                    node.addEventListener('mouseenter', (e) => this._showTooltip(e, section));
                    node.addEventListener('mouseleave', () => this._hideTooltip());

                    nodeWrapper.appendChild(node);

                    // Label abaixo (n√∫mero)
                    const label = document.createElement('div');
                    label.className = 'progress-node-label';
                    label.textContent = `Se√ß√£o ${section.id}`;
                    nodeWrapper.appendChild(label);

                    this.container.appendChild(nodeWrapper);

                    // Linha de conex√£o (exceto ap√≥s a √∫ltima)
                    if (index < this.sections.length - 1) {
                        const lineContainer = document.createElement('div');
                        lineContainer.className = 'progress-line-container';
                        lineContainer.dataset.lineAfter = section.id;

                        const lineFill = document.createElement('div');
                        lineFill.className = 'progress-line-fill';
                        lineFill.id = `line-fill-${section.id}`;

                        lineContainer.appendChild(lineFill);
                        this.container.appendChild(lineContainer);
                    }
                });

                // Aplicar estados iniciais
                this._updateAllLines();
            }

            /**
             * Aplica o estado visual correto √† bolinha
             */
            _applyNodeState(node, sectionId) {
                const state = this.sectionStates[sectionId];

                // Remover classes anteriores
                node.classList.remove(
                    'progress-node--pending',
                    'progress-node--in-progress',
                    'progress-node--completed',
                    'progress-node--skipped'
                );

                // Aplicar classe do estado atual
                node.classList.add(`progress-node--${state.status}`);
            }

            /**
             * Atualiza estado de uma se√ß√£o
             */
            updateSection(sectionId, status, answeredCount = null) {
                if (!this.sectionStates[sectionId]) return;

                this.sectionStates[sectionId].status = status;
                if (answeredCount !== null) {
                    this.sectionStates[sectionId].answeredCount = answeredCount;
                }

                // Atualizar visual da bolinha
                const node = this.container.querySelector(`[data-section-id="${sectionId}"]`);
                if (node) {
                    this._applyNodeState(node, sectionId);
                }

                // Atualizar linhas
                this._updateAllLines();
            }

            /**
             * Define a se√ß√£o atual (em progresso)
             */
            setCurrentSection(sectionId) {
                // Remover status in_progress da se√ß√£o anterior
                if (this.currentSectionId && this.sectionStates[this.currentSectionId]) {
                    const oldState = this.sectionStates[this.currentSectionId];
                    if (oldState.status === 'in_progress') {
                        oldState.status = 'pending';
                        const oldNode = this.container.querySelector(`[data-section-id="${this.currentSectionId}"]`);
                        if (oldNode) this._applyNodeState(oldNode, this.currentSectionId);
                    }
                }

                // Definir nova se√ß√£o atual
                this.currentSectionId = sectionId;
                this.updateSection(sectionId, 'in_progress');
            }

            /**
             * Atualiza o progresso dentro de uma se√ß√£o
             */
            updateProgress(sectionId, answeredCount, totalCount = null) {
                if (!this.sectionStates[sectionId]) return;

                const state = this.sectionStates[sectionId];
                state.answeredCount = answeredCount;
                if (totalCount !== null) {
                    state.totalCount = totalCount;
                }

                // Atualizar linha correspondente
                this._updateLineFill(sectionId);
            }

            /**
             * Marca se√ß√£o como completa
             */
            markCompleted(sectionId) {
                this.updateSection(sectionId, 'completed');
                this.sectionStates[sectionId].answeredCount = this.sectionStates[sectionId].totalCount;
                this._updateLineFill(sectionId);
            }

            /**
             * Marca se√ß√£o como pulada
             */
            markSkipped(sectionId) {
                this.updateSection(sectionId, 'skipped');
                this._updateLineFill(sectionId);
            }

            /**
             * Atualiza preenchimento de uma linha
             */
            _updateLineFill(sectionId) {
                const lineFill = document.getElementById(`line-fill-${sectionId}`);
                if (!lineFill) return;

                const state = this.sectionStates[sectionId];
                let percentage = 0;

                if (state.status === 'completed' || state.status === 'skipped') {
                    percentage = 100;
                } else if (state.status === 'in_progress' && state.totalCount > 0) {
                    percentage = (state.answeredCount / state.totalCount) * 100;
                }

                lineFill.style.width = `${percentage}%`;
            }

            /**
             * Atualiza todas as linhas
             */
            _updateAllLines() {
                this.sections.forEach(section => {
                    this._updateLineFill(section.id);
                });
            }

            /**
             * Trata clique em uma bolinha
             */
            _handleNodeClick(sectionId) {
                const state = this.sectionStates[sectionId];

                // S√≥ permite clicar em se√ß√µes j√° visitadas (completed ou skipped)
                // ou na se√ß√£o atual
                if (state.status === 'completed' || state.status === 'skipped' || sectionId === this.currentSectionId) {
                    this.onSectionClick(sectionId);
                }
            }

            /**
             * Mostra tooltip ao passar mouse
             */
            _showTooltip(event, section) {
                if (!this.tooltipEl) return;

                const state = this.sectionStates[section.id];

                // Emoji
                const emojiSpan = this.tooltipEl.querySelector('.tooltip-emoji');
                if (emojiSpan) emojiSpan.textContent = section.emoji;

                // Nome
                const nameSpan = this.tooltipEl.querySelector('.tooltip-name');
                if (nameSpan) nameSpan.textContent = section.name;

                // Status
                const statusSpan = this.tooltipEl.querySelector('.tooltip-status');
                if (statusSpan) {
                    switch (state.status) {
                        case 'completed':
                            statusSpan.textContent = '‚úì Completa';
                            break;
                        case 'skipped':
                            statusSpan.textContent = '‚è≠Ô∏è Pulada';
                            break;
                        case 'in_progress':
                            statusSpan.textContent = `${state.answeredCount}/${state.totalCount}`;
                            break;
                        default:
                            statusSpan.textContent = 'Pendente';
                    }
                }

                // Posicionar tooltip
                const rect = event.target.getBoundingClientRect();
                const containerRect = this.container.parentElement.getBoundingClientRect();

                this.tooltipEl.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
                this.tooltipEl.style.top = `${rect.top - containerRect.top - 45}px`;

                this.tooltipEl.classList.remove('hidden');
            }

            /**
             * Esconde tooltip
             */
            _hideTooltip() {
                if (this.tooltipEl) {
                    this.tooltipEl.classList.add('hidden');
                }
            }

            /**
             * Reseta a barra de progresso
             */
            reset() {
                this.sections.forEach(s => {
                    this.sectionStates[s.id] = {
                        status: 'pending',
                        answeredCount: 0,
                        totalCount: s.totalQuestions
                    };
                });
                this.currentSectionId = 1;
                this.render();
            }
        }

        // ============================================
        // FIM CLASSE PROGRESSBAR
        // ============================================

        // ============================================
        // CLASSE SECTIONCONTAINER - CONTAINER DE SE√á√ÉO
        // ============================================

        class SectionContainer {
            /**
             * Componente que gerencia uma se√ß√£o do BO
             * Inclui chat, input, texto gerado e transi√ß√£o
             */
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);

                // Dados da se√ß√£o atual
                this.sectionData = options.sectionData || null;
                this.sectionId = options.sectionId || 1;

                // Estado
                this.state = 'pending'; // pending, in_progress, completed, skipped
                this.messages = []; // Hist√≥rico de mensagens do chat
                this.answers = {}; // Respostas do usu√°rio { questionId: answer }
                this.currentQuestionIndex = 0;
                this.generatedText = null;
                this.isReadOnly = false;

                // Callbacks
                this.onAnswer = options.onAnswer || ((questionId, answer) => {});
                this.onComplete = options.onComplete || ((sectionId, answers) => {});
                this.onSkip = options.onSkip || ((sectionId) => {});
                this.onNavigateNext = options.onNavigateNext || ((nextSectionId) => {});
                this.onNavigateBack = options.onNavigateBack || (() => {});

                // Elementos internos
                this.chatEl = null;
                this.inputEl = null;
                this.inputFieldEl = null;
                this.generatedEl = null;
                this.transitionEl = null;
            }

            /**
             * Carrega dados de uma se√ß√£o
             */
            loadSection(sectionData, options = {}) {
                this.sectionData = sectionData;
                this.sectionId = sectionData.id;
                this.state = options.state || 'in_progress';
                this.messages = options.messages || [];
                this.answers = options.answers || {};
                this.currentQuestionIndex = options.currentQuestionIndex || 0;
                this.generatedText = options.generatedText || null;
                this.isReadOnly = options.isReadOnly || false;

                this.render();

                // Se n√£o for read-only e n√£o tiver mensagens, mostrar primeira pergunta
                if (!this.isReadOnly && this.messages.length === 0 && this.state === 'in_progress') {
                    this._showCurrentQuestion();
                }
            }

            /**
             * Renderiza o container completo
             */
            render() {
                if (!this.container || !this.sectionData) return;

                const section = this.sectionData;

                this.container.innerHTML = `
                    <!-- Header da Se√ß√£o -->
                    <div class="section-header">
                        <div class="section-header__title">
                            <span class="section-header__emoji">${section.emoji}</span>
                            <span>Se√ß√£o ${section.id}: ${section.name}</span>
                        </div>
                        <span class="section-header__badge section-header__badge--${this.state}">
                            ${this._getStatusLabel()}
                        </span>
                    </div>

                    <!-- Chat -->
                    <div class="section-chat" id="section-chat">
                        ${this._renderMessages()}
                    </div>

                    <!-- √Årea de Input Din√¢mica -->
                    ${!this.isReadOnly && this.state === 'in_progress' ? `
                    <div id="section-input-area">
                        <!-- Input ser√° renderizado pelo _renderInput() -->
                    </div>
                    ` : ''}

                    <!-- Texto Gerado (se completed) -->
                    ${this.state === 'completed' && this.generatedText ? `
                    <div class="section-generated" id="section-generated">
                        <div class="section-generated__header">
                            <span class="section-generated__title">
                                üìÑ Texto Gerado - Se√ß√£o ${section.id}
                            </span>
                            <button class="section-generated__copy" id="section-copy-btn">
                                üìã Copiar
                            </button>
                        </div>
                        <div class="section-generated__text">${this.generatedText}</div>
                    </div>
                    ` : ''}

                    <!-- Transi√ß√£o para pr√≥xima se√ß√£o (se completed e n√£o for √∫ltima) -->
                    ${this.state === 'completed' && this.sectionId < 8 ? this._renderTransition() : ''}

                    <!-- Aviso de modo leitura -->
                    ${this.isReadOnly ? `
                    <div class="section-readonly-notice">
                        <span class="section-readonly-notice__text">
                            üìñ Modo leitura - Esta se√ß√£o j√° foi finalizada
                        </span>
                        <button class="section-readonly-notice__btn" id="section-back-btn">
                            ‚Ü©Ô∏è Voltar para se√ß√£o atual
                        </button>
                    </div>
                    ` : ''}
                `;

                // Guardar refer√™ncias
                this.chatEl = this.container.querySelector('#section-chat');
                this.inputEl = this.container.querySelector('#section-input');
                this.inputFieldEl = this.container.querySelector('#section-input-field');
                this.generatedEl = this.container.querySelector('#section-generated');
                this.transitionEl = this.container.querySelector('.section-transition');

                // Bind eventos
                this._bindEvents();

                // Scroll para o final do chat
                this._scrollToBottom();
            }

            /**
             * Retorna label do status
             */
            _getStatusLabel() {
                switch (this.state) {
                    case 'in_progress': return `${Object.keys(this.answers).length}/${this.sectionData.questions.length} perguntas`;
                    case 'completed': return '‚úì Completa';
                    case 'skipped': return '‚è≠Ô∏è Pulada';
                    default: return 'Pendente';
                }
            }

            /**
             * Renderiza mensagens do chat
             */
            _renderMessages() {
                if (this.messages.length === 0) {
                    return '<div class="section-loading"><span class="section-loading__spinner"></span> Carregando...</div>';
                }

                return this.messages.map(msg => {
                    if (msg.type === 'bot') {
                        return `
                            <div class="chat-message chat-message--bot">
                                <div class="chat-message__bubble chat-message__bubble--bot">
                                    <div class="chat-message__text">${msg.text}</div>
                                    ${msg.hint ? `<div class="chat-message__hint">${msg.hint}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="chat-message chat-message--user">
                                <div class="chat-message__bubble chat-message__bubble--user">
                                    <div class="chat-message__text">${msg.text}</div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }

            /**
             * Renderiza √°rea de transi√ß√£o
             */
            _renderTransition() {
                const nextSection = window.SECTIONS_DATA ? window.SECTIONS_DATA.find(s => s.id === this.sectionId + 1) : null;

                if (!nextSection) return '';

                const canSkip = nextSection.skippable !== false;

                return `
                    <div class="section-transition">
                        <div class="section-transition__preview">
                            <span class="section-transition__preview-emoji">${nextSection.emoji}</span>
                            <div class="section-transition__preview-info">
                                <div class="section-transition__preview-label">Pr√≥xima se√ß√£o</div>
                                <div class="section-transition__preview-name">Se√ß√£o ${nextSection.id}: ${nextSection.name}</div>
                            </div>
                        </div>
                        <div class="section-transition__buttons">
                            <button class="section-transition__btn section-transition__btn--start" id="section-start-next">
                                ‚ñ∂Ô∏è Iniciar Se√ß√£o ${nextSection.id}
                            </button>
                            ${canSkip ? `
                            <button class="section-transition__btn section-transition__btn--skip" id="section-skip-next">
                                ‚è≠Ô∏è Pular
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            /**
             * Cria o componente de input correto baseado na pergunta
             */
            _createInputComponent(question) {
                const inputType = question.inputType || 'text';

                switch (inputType) {
                    case 'single_choice':
                        return new SingleChoice({
                            options: question.options || [
                                { value: 'sim', label: 'SIM' },
                                { value: 'nao', label: 'N√ÉO' }
                            ],
                            onSelect: (value, label, option) => {
                                this._handleInputSubmit(label, question, option);
                            }
                        });

                    case 'multiple_choice':
                        return new MultipleChoice({
                            options: question.options || [],
                            minSelections: question.validation?.minSelections || 1,
                            maxSelections: question.validation?.maxSelections || null,
                            onConfirm: (values, labels) => {
                                this._handleInputSubmit(labels.join(', '), question);
                            }
                        });

                    case 'text':
                    default:
                        return new TextInput({
                            placeholder: question.hint || 'Digite sua resposta...',
                            validation: question.validation || {},
                            onSubmit: (value) => {
                                this._handleInputSubmit(value, question);
                            }
                        });
                }
            }

            /**
             * Trata resposta do componente de input
             */
            _handleInputSubmit(answer, question, option = null) {
                // Verificar se deve pular se√ß√£o (para skipQuestion)
                if (option?.skipsSection) {
                    this._addUserMessage(answer);
                    setTimeout(() => {
                        this._skipSection();
                    }, 300);
                    return;
                }

                // Adicionar mensagem do usu√°rio
                this._addUserMessage(answer);

                // Salvar resposta
                this.answers[question.id] = answer;
                this.onAnswer(question.id, answer);

                // Verificar follow-up
                if (question.followUp && question.followUp.condition) {
                    const conditionMet = answer.toLowerCase().includes(question.followUp.condition.toLowerCase());
                    if (conditionMet && question.followUp.question) {
                        // Mostrar follow-up
                        setTimeout(() => {
                            this._showQuestion(question.followUp.question);
                        }, 500);
                        return;
                    }
                }

                // Avan√ßar para pr√≥xima pergunta
                this.currentQuestionIndex++;
                this._updateBadge();

                setTimeout(() => {
                    this._showCurrentQuestion();
                }, 500);
            }

            /**
             * Mostra uma pergunta espec√≠fica com o input correto
             */
            _showQuestion(question) {
                // Adicionar mensagem do bot
                this._addBotMessage(question.text, question.hint);

                // Renderizar input correto
                this._renderInput(question);
            }

            /**
             * Renderiza o input na √°rea de input
             */
            _renderInput(question) {
                // Remover input anterior
                const inputArea = this.container.querySelector('#section-input-area');
                if (inputArea) {
                    inputArea.innerHTML = '';

                    // Criar novo componente
                    this.currentInputComponent = this._createInputComponent(question);
                    const inputEl = this.currentInputComponent.render();
                    inputArea.appendChild(inputEl);

                    // Focar se for TextInput
                    if (this.currentInputComponent instanceof TextInput) {
                        this.currentInputComponent.focus();
                    }
                }
            }

            /**
             * Bind de eventos
             */
            _bindEvents() {
                // C√ìDIGO ANTIGO DE INPUT - COMENTADO (agora usa componentes)
                // const inputBtn = this.container.querySelector('#section-input-btn');
                // if (inputBtn) {
                //     inputBtn.addEventListener('click', () => this._handleSubmit());
                // }
                //
                // if (this.inputFieldEl) {
                //     this.inputFieldEl.addEventListener('keypress', (e) => {
                //         if (e.key === 'Enter') this._handleSubmit();
                //     });
                //     setTimeout(() => this.inputFieldEl.focus(), 100);
                // }

                // Copiar texto gerado
                const copyBtn = this.container.querySelector('#section-copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this._copyGeneratedText());
                }

                // Iniciar pr√≥xima se√ß√£o
                const startNextBtn = this.container.querySelector('#section-start-next');
                if (startNextBtn) {
                    startNextBtn.addEventListener('click', () => {
                        this.onNavigateNext(this.sectionId + 1);
                    });
                }

                // Pular pr√≥xima se√ß√£o
                const skipNextBtn = this.container.querySelector('#section-skip-next');
                if (skipNextBtn) {
                    skipNextBtn.addEventListener('click', () => {
                        this.onSkip(this.sectionId + 1);
                    });
                }

                // Voltar para se√ß√£o atual
                const backBtn = this.container.querySelector('#section-back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        this.onNavigateBack();
                    });
                }
            }

            /**
             * Mostra a pergunta atual
             */
            _showCurrentQuestion() {
                if (!this.sectionData) return;

                const questions = this.sectionData.questions;

                // Verificar se tem skipQuestion primeiro
                if (this.sectionData.skipQuestion && this.currentQuestionIndex === 0 && !this.answers[this.sectionData.skipQuestion.id]) {
                    const skipQ = this.sectionData.skipQuestion;
                    this._showQuestion(skipQ);
                    return;
                }

                // Calcular √≠ndice real (considerando skipQuestion)
                const realIndex = this.sectionData.skipQuestion ? this.currentQuestionIndex - 1 : this.currentQuestionIndex;

                if (realIndex >= 0 && realIndex < questions.length) {
                    const question = questions[realIndex];
                    this._showQuestion(question);
                } else if (realIndex >= questions.length) {
                    // Todas as perguntas respondidas
                    this._completeSection();
                }
            }

            /**
             * Adiciona mensagem do bot
             */
            _addBotMessage(text, hint = null) {
                this.messages.push({ type: 'bot', text, hint });
                this._updateChat();
            }

            /**
             * Adiciona mensagem do usu√°rio
             */
            _addUserMessage(text) {
                this.messages.push({ type: 'user', text });
                this._updateChat();
            }

            /**
             * Atualiza √°rea de chat
             */
            _updateChat() {
                if (this.chatEl) {
                    this.chatEl.innerHTML = this._renderMessages();
                    this._scrollToBottom();
                }
            }

            /**
             * Scroll para o final do chat
             */
            _scrollToBottom() {
                if (this.chatEl) {
                    this.chatEl.scrollTop = this.chatEl.scrollHeight;
                }
            }

            /**
             * M√âTODO ANTIGO _handleSubmit - COMENTADO (substitu√≠do por _handleInputSubmit)
             */
            // _handleSubmit() {
            //     if (!this.inputFieldEl) return;
            //
            //     const answer = this.inputFieldEl.value.trim();
            //     if (!answer) return;
            //
            //     // Limpar input
            //     this.inputFieldEl.value = '';
            //
            //     // Adicionar mensagem do usu√°rio
            //     this._addUserMessage(answer);
            //
            //     // Determinar qual pergunta foi respondida
            //     let questionId;
            //     if (this.sectionData.skipQuestion && this.currentQuestionIndex === 0) {
            //         questionId = this.sectionData.skipQuestion.id;
            //
            //         // Verificar se deve pular se√ß√£o
            //         const skipQ = this.sectionData.skipQuestion;
            //         const skipOption = skipQ.options?.find(o => o.skipsSection && o.label.toUpperCase() === answer.toUpperCase());
            //         if (skipOption) {
            //             this._skipSection();
            //             return;
            //         }
            //     } else {
            //         const realIndex = this.sectionData.skipQuestion ? this.currentQuestionIndex - 1 : this.currentQuestionIndex;
            //         const question = this.sectionData.questions[realIndex];
            //         questionId = question?.id;
            //     }
            //
            //     // Salvar resposta
            //     if (questionId) {
            //         this.answers[questionId] = answer;
            //         this.onAnswer(questionId, answer);
            //     }
            //
            //     // Avan√ßar para pr√≥xima pergunta
            //     this.currentQuestionIndex++;
            //
            //     // Atualizar badge
            //     this._updateBadge();
            //
            //     // Mostrar pr√≥xima pergunta ap√≥s delay
            //     setTimeout(() => {
            //         this._showCurrentQuestion();
            //     }, 500);
            // }

            /**
             * Atualiza badge de status
             */
            _updateBadge() {
                const badge = this.container.querySelector('.section-header__badge');
                if (badge) {
                    badge.textContent = this._getStatusLabel();
                }
            }

            /**
             * Completa a se√ß√£o
             */
            _completeSection() {
                this.state = 'completed';

                // Simular texto gerado (ser√° substitu√≠do pela API real na Fase 4)
                this.generatedText = `[Texto da Se√ß√£o ${this.sectionId} ser√° gerado pela API]\n\nRespostas coletadas:\n${
                    Object.entries(this.answers).map(([k, v]) => `- ${k}: ${v}`).join('\n')
                }`;

                // Callback
                this.onComplete(this.sectionId, this.answers);

                // Re-renderizar
                this.render();
            }

            /**
             * Pula a se√ß√£o
             */
            _skipSection() {
                this.state = 'skipped';
                this.onSkip(this.sectionId);
                this.render();
            }

            /**
             * Copia texto gerado
             */
            _copyGeneratedText() {
                if (!this.generatedText) return;

                navigator.clipboard.writeText(this.generatedText).then(() => {
                    const copyBtn = this.container.querySelector('#section-copy-btn');
                    if (copyBtn) {
                        copyBtn.textContent = '‚úÖ Copiado!';
                        setTimeout(() => {
                            copyBtn.textContent = 'üìã Copiar';
                        }, 2000);
                    }
                });
            }

            /**
             * Mostra transi√ß√£o com fade
             */
            fadeOut() {
                return new Promise(resolve => {
                    this.container.classList.remove('section-container--visible');
                    this.container.classList.add('section-container--hidden');
                    setTimeout(resolve, 200);
                });
            }

            /**
             * Mostra se√ß√£o com fade
             */
            fadeIn() {
                return new Promise(resolve => {
                    this.container.classList.remove('section-container--hidden');
                    this.container.classList.add('section-container--visible');
                    setTimeout(resolve, 200);
                });
            }

            /**
             * Define texto gerado (vem da API)
             */
            setGeneratedText(text) {
                this.generatedText = text;
                if (this.state === 'completed') {
                    this.render();
                }
            }

            /**
             * Retorna estado atual
             */
            getState() {
                return {
                    sectionId: this.sectionId,
                    state: this.state,
                    answers: this.answers,
                    messages: this.messages,
                    currentQuestionIndex: this.currentQuestionIndex,
                    generatedText: this.generatedText
                };
            }
        }

        // ============================================
        // FIM CLASSE SECTIONCONTAINER
        // ============================================

        // ============================================
        // CLASSE TEXTINPUT - INPUT DE TEXTO
        // ============================================

        class TextInput {
            /**
             * Componente de input de texto com valida√ß√£o
             */
            constructor(options = {}) {
                this.placeholder = options.placeholder || 'Digite sua resposta...';
                this.hint = options.hint || null;
                this.validation = options.validation || {};
                this.onSubmit = options.onSubmit || (() => {});

                this.element = null;
                this.inputField = null;
                this.errorEl = null;
                this.isValid = true;
            }

            /**
             * Renderiza o componente e retorna o elemento
             */
            render() {
                this.element = document.createElement('div');
                this.element.className = 'input-component';

                this.element.innerHTML = `
                    <div class="text-input">
                        <input
                            type="text"
                            class="text-input__field"
                            placeholder="${this.placeholder}"
                        >
                        <button type="button" class="text-input__button">
                            Enviar
                        </button>
                    </div>
                    <div class="text-input__error" style="display: none;"></div>
                `;

                this.inputField = this.element.querySelector('.text-input__field');
                this.errorEl = this.element.querySelector('.text-input__error');
                const button = this.element.querySelector('.text-input__button');

                // Eventos
                button.addEventListener('click', () => this._handleSubmit());
                this.inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this._handleSubmit();
                });
                this.inputField.addEventListener('input', () => this._clearError());

                return this.element;
            }

            /**
             * Foca no input
             */
            focus() {
                if (this.inputField) {
                    setTimeout(() => this.inputField.focus(), 100);
                }
            }

            /**
             * Limpa o input
             */
            clear() {
                if (this.inputField) {
                    this.inputField.value = '';
                }
                this._clearError();
            }

            /**
             * Valida o valor
             */
            validate(value) {
                const trimmed = value.trim();

                // Required
                if (this.validation.required && !trimmed) {
                    return { valid: false, error: 'Este campo √© obrigat√≥rio.' };
                }

                // Min length
                if (this.validation.minLength && trimmed.length < this.validation.minLength) {
                    return {
                        valid: false,
                        error: `M√≠nimo de ${this.validation.minLength} caracteres.`
                    };
                }

                // Pattern (datetime)
                if (this.validation.pattern === 'datetime') {
                    const hasDate = /\d{1,2}\/\d{1,2}/.test(trimmed) ||
                                   /(janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro)/i.test(trimmed);
                    const hasTime = /\d{1,2}[h:]\d{0,2}/.test(trimmed);

                    if (!hasDate || !hasTime) {
                        return {
                            valid: false,
                            error: 'Informe data e hora. Ex: 22/03/2025, √†s 19h03'
                        };
                    }
                }

                return { valid: true };
            }

            /**
             * Trata o envio
             */
            _handleSubmit() {
                if (!this.inputField) return;

                const value = this.inputField.value;
                const validation = this.validate(value);

                if (!validation.valid) {
                    this._showError(validation.error);
                    return;
                }

                this._clearError();
                this.onSubmit(value.trim());
            }

            /**
             * Mostra erro
             */
            _showError(message) {
                if (this.errorEl) {
                    this.errorEl.textContent = message;
                    this.errorEl.style.display = 'flex';
                }
                if (this.inputField) {
                    this.inputField.classList.add('text-input__field--error');
                }
                this.isValid = false;
            }

            /**
             * Limpa erro
             */
            _clearError() {
                if (this.errorEl) {
                    this.errorEl.style.display = 'none';
                }
                if (this.inputField) {
                    this.inputField.classList.remove('text-input__field--error');
                }
                this.isValid = true;
            }

            /**
             * Desabilita o input
             */
            disable() {
                if (this.inputField) {
                    this.inputField.disabled = true;
                }
                const button = this.element?.querySelector('.text-input__button');
                if (button) {
                    button.disabled = true;
                }
            }

            /**
             * Habilita o input
             */
            enable() {
                if (this.inputField) {
                    this.inputField.disabled = false;
                }
                const button = this.element?.querySelector('.text-input__button');
                if (button) {
                    button.disabled = false;
                }
            }
        }

        // ============================================
        // FIM CLASSE TEXTINPUT
        // ============================================

        // ============================================
        // CLASSE SINGLECHOICE - SELE√á√ÉO √öNICA
        // ============================================

        class SingleChoice {
            /**
             * Componente de sele√ß√£o √∫nica com bot√µes
             */
            constructor(options = {}) {
                this.options = options.options || [
                    { value: 'sim', label: 'SIM' },
                    { value: 'nao', label: 'N√ÉO' }
                ];
                this.onSelect = options.onSelect || (() => {});

                this.element = null;
                this.selectedValue = null;
            }

            /**
             * Renderiza o componente e retorna o elemento
             */
            render() {
                this.element = document.createElement('div');
                this.element.className = 'input-component';

                const optionsHtml = this.options.map(opt => {
                    // Determinar classe especial
                    let specialClass = '';
                    const labelUpper = opt.label.toUpperCase();

                    if (labelUpper === 'SIM' || labelUpper === 'YES') {
                        specialClass = 'single-choice__option--yes';
                    } else if (labelUpper === 'N√ÉO' || labelUpper === 'NAO' || labelUpper === 'NO') {
                        specialClass = 'single-choice__option--no';
                    }

                    // Determinar √≠cone
                    let icon = '';
                    if (labelUpper === 'SIM' || labelUpper === 'YES') {
                        icon = '<span class="single-choice__icon">‚úÖ</span>';
                    } else if (labelUpper === 'N√ÉO' || labelUpper === 'NAO' || labelUpper === 'NO') {
                        icon = '<span class="single-choice__icon">‚ùå</span>';
                    }

                    return `
                        <button
                            type="button"
                            class="single-choice__option ${specialClass}"
                            data-value="${opt.value}"
                        >
                            ${icon}
                            <span>${opt.label}</span>
                        </button>
                    `;
                }).join('');

                this.element.innerHTML = `
                    <div class="single-choice">
                        ${optionsHtml}
                    </div>
                `;

                // Eventos
                const buttons = this.element.querySelectorAll('.single-choice__option');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const value = btn.dataset.value;
                        this._handleSelect(value, btn);
                    });
                });

                return this.element;
            }

            /**
             * Trata a sele√ß√£o
             */
            _handleSelect(value, buttonEl) {
                // Remover sele√ß√£o anterior
                const allButtons = this.element.querySelectorAll('.single-choice__option');
                allButtons.forEach(btn => btn.classList.remove('single-choice__option--selected'));

                // Marcar como selecionado
                buttonEl.classList.add('single-choice__option--selected');
                this.selectedValue = value;

                // Encontrar o label correspondente
                const option = this.options.find(o => o.value === value);
                const label = option ? option.label : value;

                // Callback ap√≥s pequeno delay (para ver a anima√ß√£o)
                setTimeout(() => {
                    this.onSelect(value, label, option);
                }, 150);
            }

            /**
             * Retorna valor selecionado
             */
            getValue() {
                return this.selectedValue;
            }

            /**
             * Desabilita todas as op√ß√µes
             */
            disable() {
                const buttons = this.element?.querySelectorAll('.single-choice__option');
                buttons?.forEach(btn => {
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.6';
                });
            }
        }

        // ============================================
        // FIM CLASSE SINGLECHOICE
        // ============================================

        // ============================================
        // CLASSE MULTIPLECHOICE - SELE√á√ÉO M√öLTIPLA
        // ============================================

        class MultipleChoice {
            /**
             * Componente de sele√ß√£o m√∫ltipla com checkboxes
             */
            constructor(options = {}) {
                this.options = options.options || [];
                this.minSelections = options.minSelections || 1;
                this.maxSelections = options.maxSelections || null;
                this.onConfirm = options.onConfirm || (() => {});

                this.element = null;
                this.selectedValues = new Set();
            }

            /**
             * Renderiza o componente e retorna o elemento
             */
            render() {
                this.element = document.createElement('div');
                this.element.className = 'input-component';

                const optionsHtml = this.options.map(opt => `
                    <div class="multiple-choice__option" data-value="${opt.value}">
                        <div class="multiple-choice__checkbox">
                            <span class="multiple-choice__checkmark">‚úì</span>
                        </div>
                        <span class="multiple-choice__label">${opt.label}</span>
                    </div>
                `).join('');

                this.element.innerHTML = `
                    <div class="multiple-choice">
                        <div class="multiple-choice__options">
                            ${optionsHtml}
                        </div>
                        <button
                            type="button"
                            class="multiple-choice__confirm"
                            disabled
                        >
                            ‚úì Confirmar sele√ß√£o
                        </button>
                        <div class="multiple-choice__hint">
                            Selecione ${this.minSelections === 1 ? 'pelo menos 1 op√ß√£o' : `pelo menos ${this.minSelections} op√ß√µes`}
                        </div>
                    </div>
                `;

                // Eventos - op√ß√µes
                const optionEls = this.element.querySelectorAll('.multiple-choice__option');
                optionEls.forEach(opt => {
                    opt.addEventListener('click', () => {
                        const value = opt.dataset.value;
                        this._toggleOption(value, opt);
                    });
                });

                // Evento - confirmar
                const confirmBtn = this.element.querySelector('.multiple-choice__confirm');
                confirmBtn.addEventListener('click', () => this._handleConfirm());

                return this.element;
            }

            /**
             * Toggle de op√ß√£o
             */
            _toggleOption(value, optionEl) {
                if (this.selectedValues.has(value)) {
                    // Desmarcar
                    this.selectedValues.delete(value);
                    optionEl.classList.remove('multiple-choice__option--selected');
                } else {
                    // Verificar limite m√°ximo
                    if (this.maxSelections && this.selectedValues.size >= this.maxSelections) {
                        return;
                    }

                    // Marcar
                    this.selectedValues.add(value);
                    optionEl.classList.add('multiple-choice__option--selected');
                }

                this._updateConfirmButton();
            }

            /**
             * Atualiza estado do bot√£o confirmar
             */
            _updateConfirmButton() {
                const confirmBtn = this.element?.querySelector('.multiple-choice__confirm');
                if (confirmBtn) {
                    const isValid = this.selectedValues.size >= this.minSelections;
                    confirmBtn.disabled = !isValid;

                    // Atualizar texto
                    const count = this.selectedValues.size;
                    if (count === 0) {
                        confirmBtn.textContent = '‚úì Confirmar sele√ß√£o';
                    } else {
                        confirmBtn.textContent = `‚úì Confirmar (${count} selecionado${count > 1 ? 's' : ''})`;
                    }
                }
            }

            /**
             * Trata confirma√ß√£o
             */
            _handleConfirm() {
                if (this.selectedValues.size < this.minSelections) return;

                // Converter Set para Array
                const values = Array.from(this.selectedValues);

                // Encontrar labels
                const labels = values.map(v => {
                    const opt = this.options.find(o => o.value === v);
                    return opt ? opt.label : v;
                });

                // Callback
                this.onConfirm(values, labels);
            }

            /**
             * Retorna valores selecionados
             */
            getValues() {
                return Array.from(this.selectedValues);
            }

            /**
             * Desabilita o componente
             */
            disable() {
                const options = this.element?.querySelectorAll('.multiple-choice__option');
                options?.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.style.opacity = '0.6';
                });

                const confirmBtn = this.element?.querySelector('.multiple-choice__confirm');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                }
            }
        }

        // ============================================
        // FIM CLASSE MULTIPLECHOICE
        // ============================================

        // Configura√ß√£o da API
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8000'
            : 'https://bo-assistant-backend.onrender.com';
        
        // Chave do localStorage
        const DRAFT_STORAGE_KEY = 'bo_inteligente_draft';
        
        // Perguntas da Se√ß√£o 1
        const SECTION1_QUESTIONS = {
            '1.1': 'Dia, data e hora do acionamento.',
            '1.2': 'Composi√ß√£o da guarni√ß√£o e prefixo da viatura.',
            '1.3': 'Como foi acionado? (190, DDU, mandado de pris√£o/busca, patrulhamento preventivo, outro)',
            '1.4': 'Descreva as informa√ß√µes recebidas no acionamento (ordem de servi√ßo, despacho COPOM, den√∫ncia).',
            '1.5': 'Houve deslocamento entre o ponto de acionamento e o local da ocorr√™ncia?',
            '1.5.1': 'Local de onde a guarni√ß√£o partiu.',
            '1.5.2': 'Houve alguma altera√ß√£o durante o percurso? (radar, sinal fechado, acidente)',
            '1.6': 'Local exato da ocorr√™ncia (logradouro, n√∫mero, bairro, ponto de refer√™ncia).',
            '1.7': 'O local √© conhecido como ponto de tr√°fico? Descreva hist√≥rico de ocorr√™ncias ou den√∫ncias.',
            '1.8': 'O local √© dominado por fac√ß√£o criminosa? Qual? Descreva evid√™ncias.',
            '1.9': 'O local √© ou fica pr√≥ximo de espa√ßo de interesse p√∫blico qualificado? (escola, hospital, transporte p√∫blico, unidade prisional/militar)',
            '1.9.1': 'Nome do estabelecimento.',
            '1.9.2': 'Dist√¢ncia aproximada (ex: dois quarteir√µes, 300 metros).'
        };

        // Perguntas da Se√ß√£o 2 (Abordagem a Ve√≠culo)
        const SECTION2_QUESTIONS = {
            '2.1': 'Havia ve√≠culo envolvido na ocorr√™ncia?',
            '2.2': 'Onde e em que contexto o ve√≠culo foi visualizado?',
            '2.3': 'Qual a marca, modelo, cor e placa do ve√≠culo?',
            '2.4': 'Quem da equipe viu o ve√≠culo? (nome do policial + o que chamou aten√ß√£o)',
            '2.5': 'Descreva se houve rea√ß√£o do motorista ou ocupantes (manobra brusca, tentativa de fuga, descarte de objeto).',
            '2.6': 'Quem deu a ordem de parada e como? (sirene, apito, gesto, farol)',
            '2.7': 'O ve√≠culo parou imediatamente ou houve persegui√ß√£o?',
            '2.8': 'Se houve persegui√ß√£o, por qual motivo o ve√≠culo parou? (desistiu, cercado, bateu, capotou)',
            '2.9': 'Descreva como foi a abordagem (quem mandou descer, posicionamento)',
            '2.10': 'Quem realizou a busca veicular e em quais partes do ve√≠culo?',
            '2.11': 'Quem realizou a busca pessoal nos ocupantes?',
            '2.12': 'O que foi localizado, com quem ou em qual parte do ve√≠culo/corpo estava cada material?',
            '2.13': 'O ve√≠culo apresentava irregularidade? (furto, roubo, clonagem, adultera√ß√£o)'
        };

        // Perguntas da Se√ß√£o 3 (Campana - Vigil√¢ncia Velada)
        const SECTION3_QUESTIONS = {
            '3.1': 'A equipe realizou campana (vigil√¢ncia velada)?',
            '3.2': 'Local exato da campana, ponto de observa√ß√£o e dist√¢ncia aproximada at√© o alvo.',
            '3.3': 'Quem tinha vis√£o direta e o que cada um conseguia ver? (gradua√ß√£o + nome)',
            '3.4': 'O que motivou a campana? (den√∫ncia, intelig√™ncia, hist√≥rico do local)',
            '3.5': 'Qual foi a dura√ß√£o da campana? (tempo aproximado e se foi cont√≠nua ou alternada)',
            '3.6': 'O que foi visto durante a campana? (entregas, usu√°rios, esconderijos)',
            '3.7': 'Houve abordagem de usu√°rio? O que portava? O que disse?',
            '3.8': 'Houve fuga? Como ocorreu?'
        };

        // Perguntas da Se√ß√£o 4 (Entrada em Domic√≠lio)
        const SECTION4_QUESTIONS = {
            '4.1': 'Houve entrada em domic√≠lio?',
            '4.2': 'O que foi visto/ouvido ANTES do ingresso?',
            '4.3': 'Quem viu e o qu√™? (gradua√ß√£o + nome)',
            '4.4': 'Como ocorreu o ingresso? (autoriza√ß√£o, persegui√ß√£o, droga √† vista)',
            '4.5': 'Quais policiais entraram? Quem fez o qu√™?'
        };

        const SECTION5_QUESTIONS = {
            '5.1': 'O que a equipe viu ao chegar no local?',
            '5.2': 'Quem viu, de onde, e o que exatamente?',
            '5.3': 'Descrever apar√™ncia e a√ß√µes dos abordados.'
        };

        const SECTION6_QUESTIONS = {
            '6.1': 'Houve amea√ßa ou uso de arma? Contra quem e como?',
            '6.2': 'Houve resist√™ncia durante a abordagem?',
            '6.3': 'Descreva a resist√™ncia com fatos concretos (ex.: empurr√£o, fuga, soco)',
            '6.4': 'Qual t√©cnica foi aplicada e qual foi o resultado?',
            '6.5': 'Por que foi necess√°rio algemar? (risco de fuga, agressividade)',
            '6.6': 'Houve ferimentos? Descreva: quem, tipo, local de atendimento.'
        };

        const SECTION7_QUESTIONS = {
            '7.1': 'Houve apreens√£o de drogas?',
            '7.2': 'Descreva as subst√¢ncias apreendidas: tipo, quantidade exata, embalagem, local onde foi encontrado e quem encontrou (gradua√ß√£o + nome)',
            '7.3': 'Quais objetos ligados ao tr√°fico foram apreendidos? (dinheiro, celulares, balan√ßa, armas, cadernos)',
            '7.4': 'Como foi o acondicionamento e guarda? (como lacrou, quem ficou respons√°vel e destino do material)'
        };

        const SECTION8_QUESTIONS = {
            '8.1': 'Quem deu voz de pris√£o e por qual crime? (gradua√ß√£o + nome + artigo)',
            '8.2': 'Onde e como o preso foi transportado at√© a delegacia?',
            '8.3': 'O preso declarou algo? (transcri√ß√£o literal ou "permaneceu em sil√™ncio")',
            '8.4': 'Qual era a fun√ß√£o do preso no tr√°fico? (vapor, gerente, olheiro, etc.)',
            '8.5': 'O preso possui passagens anteriores? (informar REDS se houver)',
            '8.6': 'H√° sinais de dedica√ß√£o ao crime? O que mostra isso?',
            '8.7': 'O preso tem papel relevante na fac√ß√£o? Atua√ß√£o ocasional ou cont√≠nua?',
            '8.8': 'Houve tentativa de destruir ou ocultar provas, ou intimidar algu√©m?',
            '8.9': 'Havia menor de idade envolvido na ocorr√™ncia? Se sim, idade e participa√ß√£o?',
            '8.10': 'Quem informou as garantias constitucionais ao preso? (gradua√ß√£o + nome)',
            '8.11': 'Qual o destino dos presos e dos materiais apreendidos? (delegacia, CEFLAN, etc.)'
        };

        // Manter compatibilidade com c√≥digo existente (Se√ß√£o 1)
        const QUESTIONS = SECTION1_QUESTIONS;

        // Estado da aplica√ß√£o
        let sessionId = null;
        let currentBoId = null;
        let isWaitingResponse = false;
        let currentQuestionStep = '1.1';
        let currentSection = 1; // Nova vari√°vel para controlar se√ß√£o atual
        let answersState = {}; // Para armazenar respostas localmente
        let boCompleted = false; // Flag para indicar se BO foi completado

        // Elementos DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const generatedSectionsContainer = document.getElementById('generated-sections-container');
        
        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const questionsList = document.getElementById('questions-list');
        const sidebarProgressBar = document.getElementById('sidebar-progress-bar');
        const sidebarProgressText = document.getElementById('sidebar-progress-text');
        const autosaveIndicator = document.getElementById('autosave-indicator');
        
        // Draft modal elements
        const draftModal = document.getElementById('draft-modal');
        const draftPreview = document.getElementById('draft-preview');
        const draftContinueBtn = document.getElementById('draft-continue');
        const draftDiscardBtn = document.getElementById('draft-discard');

        // ================================================================
        // FUN√á√ïES DE RASCUNHO (localStorage)
        // ================================================================

        function migrateOldDraftIDs(answers) {
            /**
             * Migra IDs antigos (2.0-2.11) para novos (2.1-2.13)
             * Garante compatibilidade com rascunhos v0.12.8
             * v0.12.9: Se√ß√£o 2 expandida de 11 para 13 perguntas
             */
            const migrated = {};
            const migrationMap = {
                '2.0': '2.1',
                // v0.12.9: Reordena√ß√£o - contexto antes de placa
                // Antiga 2.2 (placa) ‚Üí Nova 2.3
                // Antiga 2.3 (contexto) ‚Üí Nova 2.2
                '2.1': '2.3',  // marca/placa era 2.2, agora √© 2.3
                '2.2': '2.2',  // contexto era 2.3, agora √© 2.2 (swap)
                '2.3': '2.4',  // policial que viu
                '2.4': '2.6',  // ordem de parada (pula nova 2.5)
                '2.5': '2.7',  // persegui√ß√£o (pula nova 2.5, agora 2.7)
                '2.6': '2.9',  // abordagem (pula 2.7 e 2.8)
                '2.7': '2.11', // busca pessoal (era 2.8, agora 2.11)
                '2.8': '2.10', // busca veicular (era 2.9, agora 2.10)
                '2.9': '2.12', // material encontrado (era 2.10, agora 2.12)
                '2.10': '2.13' // irregularidades (era 2.11, agora 2.13)
            };

            for (const [step, answer] of Object.entries(answers)) {
                const newStep = migrationMap[step] || step;
                migrated[newStep] = answer;
            }

            return migrated;
        }

        function saveDraft() {
            /**
             * Salva o estado atual no localStorage
             * v0.9.0: Agora salva chatHistory + generatedTexts + sectionStatuses + suporte a 5 se√ß√µes
             */
            // Capturar chatHistory completo
            const chatMessages = [];
            const messageContainers = chatContainer.querySelectorAll('.message-container');

            messageContainers.forEach(msgDiv => {
                const isBot = msgDiv.classList.contains('justify-start');
                const step = msgDiv.dataset.step || null;
                const eventId = msgDiv.dataset.eventId || null;
                const text = msgDiv.dataset.currentText || msgDiv.querySelector('span')?.textContent || '';

                chatMessages.push({
                    text: text,
                    isBot: isBot,
                    step: step,
                    eventId: eventId,
                    timestamp: new Date().toISOString()
                });
            });

            // Capturar textos gerados
            const generatedTexts = {};
            if (document.getElementById('section1-text')?.textContent) {
                generatedTexts['section1'] = document.getElementById('section1-text').textContent;
            }
            if (document.getElementById('section2-text')?.textContent) {
                generatedTexts['section2'] = document.getElementById('section2-text').textContent;
            }
            if (document.getElementById('section3-text')?.textContent) {
                generatedTexts['section3'] = document.getElementById('section3-text').textContent;
            }
            if (document.getElementById('section4-text')?.textContent) {
                generatedTexts['section4'] = document.getElementById('section4-text').textContent;
            }
            if (document.getElementById('section5-text')?.textContent) {
                generatedTexts['section5'] = document.getElementById('section5-text').textContent;
            }
            if (document.getElementById('section6-text')?.textContent) {
                generatedTexts['section6'] = document.getElementById('section6-text').textContent;
            }
            if (document.getElementById('section7-text')?.textContent) {
                generatedTexts['section7'] = document.getElementById('section7-text').textContent;
            }
            if (document.getElementById('section8-text')?.textContent) {
                generatedTexts['section8'] = document.getElementById('section8-text').textContent;
            }

            // Capturar status das se√ß√µes
            const sectionStatuses = {
                1: currentSection > 1 ? 'COMPLETED' : 'IN_PROGRESS',
                2: currentSection > 2 ? 'COMPLETED' : (currentSection === 2 ? 'IN_PROGRESS' : 'PENDING'),
                3: currentSection > 3 ? 'COMPLETED' : (currentSection === 3 ? 'IN_PROGRESS' : 'PENDING'),
                4: currentSection === 4 ? 'IN_PROGRESS' : 'PENDING'
            };

            const draft = {
                sessionId: sessionId,
                boId: currentBoId,
                currentStep: currentQuestionStep,
                currentSection: currentSection,
                answers: answersState,
                chatHistory: chatMessages,
                generatedTexts: generatedTexts,
                sectionStatuses: sectionStatuses,
                savedAt: new Date().toISOString(),
                version: '0.9.0'
            };

            try {
                localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draft));
                showAutosaveIndicator();
                console.log('[Draft] Rascunho salvo:', draft);
            } catch (e) {
                console.error('[Draft] Erro ao salvar:', e);
            }
        }

        function loadDraft() {
            /**
             * Carrega rascunho do localStorage
             * Returns: draft object ou null
             */
            try {
                const draftJson = localStorage.getItem(DRAFT_STORAGE_KEY);
                if (!draftJson) return null;
                
                const draft = JSON.parse(draftJson);
                
                // Verificar se tem dados v√°lidos
                if (!draft.answers || Object.keys(draft.answers).length === 0) {
                    return null;
                }
                
                // Verificar se n√£o √© muito antigo (7 dias)
                const savedAt = new Date(draft.savedAt);
                const now = new Date();
                const diffDays = (now - savedAt) / (1000 * 60 * 60 * 24);
                
                if (diffDays > 7) {
                    console.log('[Draft] Rascunho expirado (> 7 dias)');
                    clearDraft();
                    return null;
                }
                
                return draft;
            } catch (e) {
                console.error('[Draft] Erro ao carregar:', e);
                return null;
            }
        }

        function clearDraft() {
            /**
             * Remove rascunho do localStorage
             */
            try {
                localStorage.removeItem(DRAFT_STORAGE_KEY);
                console.log('[Draft] Rascunho removido');
            } catch (e) {
                console.error('[Draft] Erro ao remover:', e);
            }
        }

        function showAutosaveIndicator() {
            /**
             * Mostra indicador de salvamento por 2 segundos
             */
            autosaveIndicator.classList.remove('hidden');
            autosaveIndicator.textContent = 'üíæ Rascunho salvo!';
            
            setTimeout(() => {
                autosaveIndicator.textContent = 'üíæ Rascunho salvo automaticamente';
            }, 1500);
        }

        function formatDraftPreview(draft) {
            /**
             * Formata preview do rascunho para o modal
             * Formato: Status por se√ß√£o + timestamp + lista de respostas
             */
            const savedDate = new Date(draft.savedAt);
            const formattedDate = savedDate.toLocaleDateString('pt-BR') + ' √†s ' +
                                  savedDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            // Contar respostas por se√ß√£o
            const section1Answers = Object.keys(draft.answers).filter(s => s.startsWith('1.')).length;
            const section2Answers = Object.keys(draft.answers).filter(s => s.startsWith('2.')).length;
            const section3Answers = Object.keys(draft.answers).filter(s => s.startsWith('3.')).length;

            let preview = '';

            // Status da Se√ß√£o 1
            if (section1Answers === 11) {
                preview += `<div class="mb-1 text-sm">Se√ß√£o 1: ‚úÖ Completa</div>`;
            } else if (section1Answers > 0) {
                preview += `<div class="mb-1 text-sm">Se√ß√£o 1: ${section1Answers}/11 perguntas respondidas</div>`;
            }

            // Status da Se√ß√£o 2 (se iniciada)
            if (section2Answers > 0) {
                if (section2Answers === 13) {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 2: ‚úÖ Completa</div>`;
                } else {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 2: ${section2Answers}/13 perguntas respondidas</div>`;
                }
            }

            // Status da Se√ß√£o 3 (se iniciada)
            if (section3Answers > 0) {
                if (section3Answers === 8) {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 3: ‚úÖ Completa</div>`;
                } else {
                    preview += `<div class="mb-1 text-sm">Se√ß√£o 3: ${section3Answers}/8 perguntas respondidas</div>`;
                }
            }

            // Linha em branco + timestamp
            preview += `<div class="text-xs text-gray-500 mt-3 mb-2">Salvo em: ${formattedDate}</div>`;

            // Container de respostas
            preview += `<div class="border-t pt-2 mt-2 max-h-32 overflow-y-auto">`;

            // Mostrar respostas salvas (truncadas), ordenadas
            const sortedEntries = Object.entries(draft.answers).sort((a, b) => {
                const [sectionA, stepA] = a[0].split('.').map(Number);
                const [sectionB, stepB] = b[0].split('.').map(Number);
                if (sectionA !== sectionB) return sectionA - sectionB;
                return stepA - stepB;
            });

            for (const [step, answer] of sortedEntries) {
                const truncated = answer.length > 50 ? answer.substring(0, 50) + '...' : answer;
                let sectionLabel = 'üìù';
                if (step.startsWith('2.')) sectionLabel = 'üöó';
                if (step.startsWith('3.')) sectionLabel = 'üëÅÔ∏è';
                preview += `<div class="text-xs mb-1"><span class="text-gray-500">${sectionLabel} ${step}:</span> ${truncated}</div>`;
            }

            preview += `</div>`;
            return preview;
        }

        function showDraftModal(draft) {
            /**
             * Exibe modal perguntando se quer continuar rascunho
             */
            draftPreview.innerHTML = formatDraftPreview(draft);
            draftModal.classList.remove('hidden');
        }

        function hideDraftModal() {
            draftModal.classList.add('hidden');
        }

        async function restoreFromDraft(draft) {
            /**
             * Restaura sess√£o a partir do rascunho
             * v0.9.0: Usa sincroniza√ß√£o em bloco via /sync_session + migra√ß√£o de IDs antigos + suporte a 5 se√ß√µes
             */
            console.log('[Draft] Restaurando rascunho...');

            try {
                // Migrar IDs antigos se necess√°rio (v0.6.3 ‚Üí v0.9.0)
                if (draft.version === '0.6.3' || !draft.version) {
                    console.log('[Draft] Detectado rascunho v0.6.3. Migrando IDs...');
                    answersState = migrateOldDraftIDs(draft.answers);
                } else {
                    answersState = draft.answers;
                }

                currentSection = draft.currentSection || 1;

                // 1. Iniciar nova sess√£o no backend
                const response = await fetch(`${API_URL}/new_session`, { method: 'POST' });
                if (!response.ok) throw new Error('Erro ao iniciar sess√£o');

                const data = await response.json();
                sessionId = data.session_id;
                currentBoId = data.bo_id;

                // 2. Mensagem inicial
                addMessage('Ol√°! Restaurei seu rascunho. Vou continuar de onde voc√™ parou.', true, false, null, 'welcome_restored');

                // 3. Restaurar chatHistory (ou reconstruir se n√£o existir)
                if (draft.chatHistory && draft.chatHistory.length > 0) {
                    // Restaurar mensagens salvas
                    draft.chatHistory.forEach(msg => {
                        addMessage(msg.text, msg.isBot, false, msg.step, msg.eventId);
                    });
                } else {
                    // Fallback: reconstruir a partir de answers (compatibilidade v0.6.3)
                    const sortedSteps = Object.keys(answersState).sort((a, b) => {
                        const [sectionA, stepA] = a.split('.').map(Number);
                        const [sectionB, stepB] = b.split('.').map(Number);
                        if (sectionA !== sectionB) return sectionA - sectionB;
                        return stepA - stepB;
                    });

                    for (const step of sortedSteps) {
                        const answer = answersState[step];
                        let question;
                        if (step.startsWith('1.')) {
                            question = SECTION1_QUESTIONS[step];
                        } else if (step.startsWith('2.')) {
                            question = SECTION2_QUESTIONS[step];
                        } else if (step.startsWith('3.')) {
                            question = SECTION3_QUESTIONS[step];
                        } else if (step.startsWith('4.')) {
                            question = SECTION4_QUESTIONS[step];
                        } else if (step.startsWith('5.')) {
                            question = SECTION5_QUESTIONS[step];
                        } else if (step.startsWith('6.')) {
                            question = SECTION6_QUESTIONS[step];
                        } else if (step.startsWith('7.')) {
                            question = SECTION7_QUESTIONS[step];
                        } else if (step.startsWith('8.')) {
                            question = SECTION8_QUESTIONS[step];
                        }

                        if (question) {
                            addMessage(question, true, false, step, `evt_restored_q_${step}`);
                            addMessage(answer, false, false, step);
                        }
                    }
                }

                // 4. Restaurar textos gerados
                if (draft.generatedTexts) {
                    if (draft.generatedTexts.section1) {
                        addGeneratedSectionText(1, draft.generatedTexts.section1);
                    }
                    if (draft.generatedTexts.section2) {
                        addGeneratedSectionText(2, draft.generatedTexts.section2);
                    }
                    if (draft.generatedTexts.section3) {
                        addGeneratedSectionText(3, draft.generatedTexts.section3);
                    }
                    if (draft.generatedTexts.section4) {
                        addGeneratedSectionText(4, draft.generatedTexts.section4);
                    }
                    if (draft.generatedTexts.section5) {
                        addGeneratedSectionText(5, draft.generatedTexts.section5);
                    }
                    if (draft.generatedTexts.section6) {
                        addGeneratedSectionText(6, draft.generatedTexts.section6);
                    }
                    if (draft.generatedTexts.section7) {
                        addGeneratedSectionText(7, draft.generatedTexts.section7);
                    }
                    if (draft.generatedTexts.section8) {
                        addGeneratedSectionText(8, draft.generatedTexts.section8);
                    }
                }

                // 5. Atualizar sidebar se estiver na Se√ß√£o 2, 3, 4, 5, 6, 7 ou 8
                if (currentSection === 2) {
                    updateSidebarForSection2();
                } else if (currentSection === 3) {
                    updateSidebarForSection3();
                } else if (currentSection === 4) {
                    updateSidebarForSection4();
                } else if (currentSection === 5) {
                    updateSidebarForSection5();
                } else if (currentSection === 6) {
                    updateSidebarForSection6();
                } else if (currentSection === 7) {
                    updateSidebarForSection7();
                } else if (currentSection === 8) {
                    updateSidebarForSection8();
                }

                // 6. SINCRONIZA√á√ÉO EM BLOCO (1 requisi√ß√£o √∫nica)
                console.log('[Draft] Sincronizando respostas em bloco...');

                const syncResponse = await fetch(`${API_URL}/sync_session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answers: answersState,
                        llm_provider: 'groq'
                    })
                });

                if (!syncResponse.ok) {
                    throw new Error('Erro na sincroniza√ß√£o em bloco');
                }

                const syncData = await syncResponse.json();

                // CR√çTICO: Atualizar estado com resposta do backend
                currentQuestionStep = syncData.current_step;
                currentSection = syncData.current_section;

                console.log(`[Draft] Sincroniza√ß√£o completa. Pr√≥ximo: ${currentQuestionStep}`);

                // 7. Atualizar sidebar (apenas uma vez, no final)
                const section1Count = Object.keys(answersState).filter(s => s.startsWith('1.')).length;
                const section2Count = Object.keys(answersState).filter(s => s.startsWith('2.')).length;
                const section3Count = Object.keys(answersState).filter(s => s.startsWith('3.')).length;
                const section4Count = Object.keys(answersState).filter(s => s.startsWith('4.')).length;
                const section5Count = Object.keys(answersState).filter(s => s.startsWith('5.')).length;
                const section6Count = Object.keys(answersState).filter(s => s.startsWith('6.')).length;
                const section7Count = Object.keys(answersState).filter(s => s.startsWith('7.')).length;
                const section8Count = Object.keys(answersState).filter(s => s.startsWith('8.')).length;

                Object.keys(answersState).forEach(step => {
                    updateSidebarAnswer(step, answersState[step]);
                    updateSidebarStatus(step, 'answered');
                });

                // ‚úÖ ADICIONAR PERGUNTAS CONDICIONAIS AO RESTAURAR RASCUNHO (Se√ß√£o 1)
                if (currentSection === 1) {
                    // Verificar se 1.5 foi respondida com SIM e adicionar 1.5.1, 1.5.2
                    if (answersState['1.5'] && ['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(answersState['1.5'].toUpperCase().trim())) {
                        const question_1_6 = document.getElementById('question-item-1.6');
                        if (question_1_6) {
                            addQuestionToSidebar('1.5.1', SECTION1_QUESTIONS['1.5.1'], question_1_6);
                            addQuestionToSidebar('1.5.2', SECTION1_QUESTIONS['1.5.2'], question_1_6);
                        }
                    }
                    // Verificar se 1.9 foi respondida com SIM e adicionar 1.9.1, 1.9.2
                    if (answersState['1.9'] && ['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(answersState['1.9'].toUpperCase().trim())) {
                        const section2Preview = document.getElementById('section-preview-2');
                        if (section2Preview) {
                            addQuestionToSidebar('1.9.1', SECTION1_QUESTIONS['1.9.1'], section2Preview);
                            addQuestionToSidebar('1.9.2', SECTION1_QUESTIONS['1.9.2'], section2Preview);
                        }
                    }
                }

                // Atualizar progresso
                if (currentSection === 8) {
                    updateSidebarProgress(section8Count, 6);
                } else if (currentSection === 7) {
                    updateSidebarProgress(section7Count, 4);
                } else if (currentSection === 6) {
                    updateSidebarProgress(section6Count, 5);
                } else if (currentSection === 5) {
                    updateSidebarProgress(section5Count, 4);
                } else if (currentSection === 4) {
                    updateSidebarProgress(section4Count, 5);
                } else if (currentSection === 3) {
                    updateSidebarProgress(section3Count, 8);
                } else if (currentSection === 2) {
                    updateSidebarProgress(section2Count, 13);
                } else {
                    // Se√ß√£o 1: Calcular total dinamicamente baseado em condicionais
                    let section1Total = 9;  // Base: 9 perguntas obrigat√≥rias
                    if (answersState['1.5'] && ['SIM', 'S', 'AFIRMATIVO'].includes(answersState['1.5'].toUpperCase().trim())) {
                        section1Total += 2;  // Adiciona 1.5.1, 1.5.2
                    }
                    if (answersState['1.9'] && ['SIM', 'S', 'AFIRMATIVO'].includes(answersState['1.9'].toUpperCase().trim())) {
                        section1Total += 2;  // Adiciona 1.9.1, 1.9.2
                    }
                    updateSidebarProgress(section1Count, section1Total);
                }

                // 8. Mostrar pr√≥xima pergunta OU desabilitar se completo
                if (!currentQuestionStep.includes('complete')) {
                    let nextQuestion;
                    if (currentSection === 1) {
                        nextQuestion = SECTION1_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 2) {
                        nextQuestion = SECTION2_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 3) {
                        nextQuestion = SECTION3_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 4) {
                        nextQuestion = SECTION4_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 5) {
                        nextQuestion = SECTION5_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 6) {
                        nextQuestion = SECTION6_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 7) {
                        nextQuestion = SECTION7_QUESTIONS[currentQuestionStep];
                    } else if (currentSection === 8) {
                        nextQuestion = SECTION8_QUESTIONS[currentQuestionStep];
                    }

                    if (nextQuestion) {
                        updateSidebarStatus(currentQuestionStep, 'current');

                        // ‚ö†Ô∏è Verificar se pergunta j√° est√° no chat (evitar duplica√ß√£o)
                        const lastBotMessage = Array.from(chatContainer.querySelectorAll('.message-container.justify-start'))
                            .pop()?.dataset.step;

                        if (lastBotMessage !== currentQuestionStep) {
                            // Pergunta ainda n√£o foi mostrada, adicionar agora
                            setTimeout(() => {
                                addMessage(nextQuestion, true, false, currentQuestionStep, `evt_next_${currentQuestionStep}`);
                                enableInput();
                            }, 500);
                        } else {
                            // Pergunta j√° est√° no chat, apenas habilitar input
                            enableInput();
                        }
                    }
                } else {
                    // Se√ß√£o completa

                    // ‚ö†Ô∏è Se Se√ß√£o 1 completa e ainda n√£o iniciou Se√ß√£o 2, mostrar bot√£o
                    if (currentSection === 1 && !document.getElementById('btn-start-section2')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 2
                        const section2ButtonDiv = document.createElement('div');
                        section2ButtonDiv.id = 'section2-button-container';
                        section2ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl text-center';
                        section2ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-blue-900 mb-2">üöó Se√ß√£o 2: Abordagem a Ve√≠culo</h3>
                            <p class="text-gray-700 mb-4">
                                Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section2"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o havia ve√≠culo
                                </button>
                                <button
                                    id="btn-start-section2"
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, havia ve√≠culo
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section2ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section2').addEventListener('click', startSection2);
                        document.getElementById('btn-skip-section2').addEventListener('click', () => skipSection(2));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 1 completa.');
                    } else if (currentSection === 2 && !document.getElementById('btn-start-section3')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 3
                        const section3ButtonDiv = document.createElement('div');
                        section3ButtonDiv.id = 'section3-button-container';
                        section3ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl text-center';
                        section3ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-purple-900 mb-2">üëÅÔ∏è Se√ß√£o 3: Campana</h3>
                            <p class="text-gray-700 mb-4">
                                A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section3"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve campana
                                </button>
                                <button
                                    id="btn-start-section3"
                                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve campana
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section3ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section3').addEventListener('click', startSection3);
                        document.getElementById('btn-skip-section3').addEventListener('click', () => skipSection(3));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 2 completa.');
                    } else if (currentSection === 3 && !document.getElementById('btn-start-section4')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 4
                        const section4ButtonDiv = document.createElement('div');
                        section4ButtonDiv.id = 'section4-button-container';
                        section4ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl text-center';
                        section4ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-orange-900 mb-2">üè† Se√ß√£o 4: Entrada em Domic√≠lio</h3>
                            <p class="text-gray-700 mb-4">
                                Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section4"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve entrada em domic√≠lio
                                </button>
                                <button
                                    id="btn-start-section4"
                                    class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve entrada em domic√≠lio
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section4ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section4').addEventListener('click', startSection4);
                        document.getElementById('btn-skip-section4').addEventListener('click', () => skipSection(4));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 3 completa.');
                    } else if (currentSection === 4 && !document.getElementById('btn-start-section5')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 5
                        const section5ButtonDiv = document.createElement('div');
                        section5ButtonDiv.id = 'section5-button-container';
                        section5ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-pink-50 to-pink-100 border-2 border-pink-200 rounded-xl text-center';
                        section5ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-pink-900 mb-2">üéØ Se√ß√£o 5: Fundada Suspeita</h3>
                            <p class="text-gray-700 mb-4">
                                Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section5"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve fundada suspeita
                                </button>
                                <button
                                    id="btn-start-section5"
                                    class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve fundada suspeita
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section5ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section5').addEventListener('click', startSection5);
                        document.getElementById('btn-skip-section5').addEventListener('click', () => skipSection(5));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 4 completa.');
                    } else if (currentSection === 5 && !document.getElementById('btn-start-section6')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 6
                        const section6ButtonDiv = document.createElement('div');
                        section6ButtonDiv.id = 'section6-button-container';
                        section6ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-200 rounded-xl text-center';
                        section6ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-teal-900 mb-2">üí™ Se√ß√£o 6: Rea√ß√£o e Uso da For√ßa</h3>
                            <p class="text-gray-700 mb-4">
                                Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section6"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve resist√™ncia
                                </button>
                                <button
                                    id="btn-start-section6"
                                    class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve resist√™ncia
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section6ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section6').addEventListener('click', startSection6);
                        document.getElementById('btn-skip-section6').addEventListener('click', () => skipSection(6));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 5 completa.');
                    } else if (currentSection === 6 && !document.getElementById('btn-start-section7')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 7
                        const section7ButtonDiv = document.createElement('div');
                        section7ButtonDiv.id = 'section7-button-container';
                        section7ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-amber-50 to-amber-100 border-2 border-amber-200 rounded-xl text-center';
                        section7ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-amber-900 mb-2">üì¶ Se√ß√£o 7: Apreens√µes e Cadeia de Cust√≥dia</h3>
                            <p class="text-gray-700 mb-4">
                                Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    id="btn-skip-section7"
                                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚è≠Ô∏è N√£o houve apreens√£o
                                </button>
                                <button
                                    id="btn-start-section7"
                                    class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚úÖ Sim, houve apreens√£o
                                </button>
                            </div>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section7ButtonDiv);

                        // Event listeners para os bot√µes
                        document.getElementById('btn-start-section7').addEventListener('click', startSection7);
                        document.getElementById('btn-skip-section7').addEventListener('click', () => skipSection(7));

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 6 completa.');
                    } else if (currentSection === 7 && !document.getElementById('btn-start-section8')) {
                        disableInput();

                        // Criar bot√£o para iniciar Se√ß√£o 8
                        const section8ButtonDiv = document.createElement('div');
                        section8ButtonDiv.id = 'section8-button-container';
                        section8ButtonDiv.className = 'mt-6 p-6 bg-gradient-to-r from-indigo-50 to-indigo-100 border-2 border-indigo-200 rounded-xl text-center';
                        section8ButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-indigo-900 mb-2">‚öñÔ∏è Se√ß√£o 8: Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL)</h3>
                            <p class="text-gray-700 mb-4">
                                √öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.
                            </p>
                            <button
                                id="btn-start-section8"
                                class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar Se√ß√£o 8 (FINAL)
                            </button>
                        `;

                        // Inserir ap√≥s o container de textos gerados
                        generatedSectionsContainer.parentElement.appendChild(section8ButtonDiv);

                        // Event listener para o bot√£o
                        document.getElementById('btn-start-section8').addEventListener('click', startSection8);

                        showToast('‚úÖ Rascunho restaurado! Se√ß√£o 7 completa.');
                    } else if (currentSection === 8) {
                        disableInput();
                        // Se√ß√£o 8 √© a √öLTIMA - BO completo
                        showToast('‚úÖ Rascunho restaurado! BO completo.');
                        boCompleted = true;
                        console.log('[BO] BO marcado como completo (restaurado)');
                    } else {
                        // Outras se√ß√µes completas
                        disableInput();
                        showToast('‚úÖ Rascunho restaurado! Esta se√ß√£o j√° est√° completa.');
                    }
                }

                showToast('‚úÖ Rascunho restaurado com sucesso!');

            } catch (error) {
                console.error('[Draft] Erro ao restaurar:', error);
                showToast('‚ùå Erro ao restaurar rascunho. Iniciando novo BO.');
                clearDraft();
                startSession();
            }
        }

        // ================================================================
        // FUN√á√ïES DE GERENCIAMENTO DE TEXTOS GERADOS (M√öLTIPLAS SE√á√ïES)
        // ================================================================

        function addSkippedSectionText(sectionNumber, skipReason) {
            /**
             * Adiciona texto de se√ß√£o pulada (n√£o aplic√°vel) no card correto
             * @param {number} sectionNumber - N√∫mero da se√ß√£o (1, 2, 3...)
             * @param {string} skipReason - Motivo do skip (fornecido pelo backend)
             */
            try {
                const textElement = document.getElementById(`section${sectionNumber}-text`);
                const cardElement = document.getElementById(`section${sectionNumber}-card`);
                const containerElement = document.getElementById('generated-sections-container');
                const copyAllButton = document.getElementById('copy-all-button');

                console.log(`[Skip] Tentando adicionar se√ß√£o ${sectionNumber} - textElement:`, !!textElement, 'cardElement:', !!cardElement);

                if (!textElement || !cardElement) {
                    console.error(`[Skip] Elementos n√£o encontrados para se√ß√£o ${sectionNumber}`);
                    return;
                }

                // Criar HTML especial para se√ß√£o pulada com estilo bonito (sem bot√£o de copiar)
                const section = ALL_SECTIONS[sectionNumber];

                // Apenas mostrar o motivo da se√ß√£o pulada, sem t√≠tulo extras
                textElement.textContent = skipReason;
                textElement.classList.add('italic', 'text-gray-500'); // Cinza mais claro para parecer "desconsiderado"
                textElement.style.fontSize = '0.95rem'; // Ligeiramente menor

                // Atualizar summary com badge ao lado do t√≠tulo e apar√™ncia de "p√°lido"
                const summary = cardElement.querySelector('summary');
                if (summary) {
                    // Modificar o HTML do summary para ter badge inline
                    summary.innerHTML = `${section.emoji} <span class="text-gray-500">Se√ß√£o ${sectionNumber} - ${section.name}</span> <span class="inline-block bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs font-semibold ml-2">Pulada</span>`;
                    summary.classList.add('opacity-80'); // Reduzir opacidade
                }

                // Adicionar fundo cinza claro ao card (summary) para indicar que foi pulada
                if (summary) {
                    summary.classList.add('bg-gray-100');
                }

                // Adicionar fundo cinza mais forte ao conte√∫do
                const cardDiv = cardElement.querySelector('.bg-white');
                if (cardDiv) {
                    cardDiv.classList.remove('bg-white');
                    cardDiv.classList.add('bg-gray-100'); // Fundo cinza mais destacado
                }

                // Esconder bot√£o de copiar para se√ß√µes puladas
                const copyButton = cardElement.querySelector('button');
                if (copyButton) {
                    copyButton.classList.add('hidden');
                    copyButton.style.display = 'none';
                }

                // Remover classe hidden tanto do classList quanto com estilo inline para garantir visibilidade
                cardElement.classList.remove('hidden');
                cardElement.style.display = '';
                containerElement.classList.remove('hidden');
                containerElement.style.display = '';

                // Mostrar bot√£o "Copiar BO Completo" se houver 2+ se√ß√µes
                const visibleSections = document.querySelectorAll('#generated-sections-container details:not(.hidden)');
                if (visibleSections.length >= 2) {
                    copyAllButton.classList.remove('hidden');
                    copyAllButton.style.display = '';
                }

                console.log(`[Skip] Se√ß√£o ${sectionNumber} pulada (adicionada ao container). Se√ß√µes vis√≠veis: ${visibleSections.length}`);
            } catch (error) {
                console.error(`[Skip] Erro ao adicionar se√ß√£o ${sectionNumber}:`, error);
            }
        }

        function addGeneratedSectionText(sectionNumber, text) {
            /**
             * Adiciona ou atualiza texto de uma se√ß√£o no container persistente
             * @param {number} sectionNumber - N√∫mero da se√ß√£o (1, 2, 3...)
             * @param {string} text - Texto gerado pelo LLM
             */
            if (!text || !text.trim()) return;

            const textElement = document.getElementById(`section${sectionNumber}-text`);
            const cardElement = document.getElementById(`section${sectionNumber}-card`);
            const containerElement = document.getElementById('generated-sections-container');
            const copyAllButton = document.getElementById('copy-all-button');

            if (textElement && cardElement) {
                textElement.textContent = text;
                textElement.classList.remove('italic', 'text-gray-500'); // Remover estilos de skip se houver

                // Remover classe hidden tanto do classList quanto com estilo inline para garantir visibilidade
                cardElement.classList.remove('hidden');
                cardElement.style.display = '';
                containerElement.classList.remove('hidden');
                containerElement.style.display = '';

                // Mostrar bot√£o "Copiar BO Completo" se houver 2+ se√ß√µes
                const visibleSections = document.querySelectorAll('#generated-sections-container details:not(.hidden)');
                if (visibleSections.length >= 2) {
                    copyAllButton.classList.remove('hidden');
                    copyAllButton.style.display = '';
                }

                console.log(`[Texto] Se√ß√£o ${sectionNumber} adicionada ao container persistente`);
            }
        }

        function copySection(sectionNumber) {
            /**
             * Copia texto de uma se√ß√£o espec√≠fica para a √°rea de transfer√™ncia
             * @param {number} sectionNumber - N√∫mero da se√ß√£o a copiar
             */
            const textElement = document.getElementById(`section${sectionNumber}-text`);

            if (!textElement || !textElement.textContent) {
                showToast('‚ùå Texto da se√ß√£o n√£o encontrado');
                return;
            }

            const text = textElement.textContent;

            navigator.clipboard.writeText(text)
                .then(() => {
                    showToast(`‚úÖ Se√ß√£o ${sectionNumber} copiada!`);
                })
                .catch(err => {
                    console.error('[Copy] Erro ao copiar:', err);
                    showToast('‚ùå Erro ao copiar texto');
                });
        }

        function copyAllSections() {
            /**
             * Copia TODAS as se√ß√µes geradas em um √∫nico texto formatado
             */
            let fullBO = "";

            // Se√ß√£o 1
            const section1Text = document.getElementById('section1-text');
            if (section1Text && section1Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 1 - CONTEXTO DA OCORR√äNCIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section1Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 2
            const section2Text = document.getElementById('section2-text');
            if (section2Text && section2Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 2 - ABORDAGEM A VE√çCULO\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section2Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 3
            const section3Text = document.getElementById('section3-text');
            if (section3Text && section3Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 3 - CAMPANA (VIGIL√ÇNCIA VELADA)\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section3Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 4
            const section4Text = document.getElementById('section4-text');
            if (section4Text && section4Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 4 - ENTRADA EM DOMIC√çLIO\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section4Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 5
            const section5Text = document.getElementById('section5-text');
            if (section5Text && section5Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 5 - FUNDADA SUSPEITA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section5Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 6
            const section6Text = document.getElementById('section6-text');
            if (section6Text && section6Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 6 - REA√á√ÉO E USO DA FOR√áA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section6Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 7
            const section7Text = document.getElementById('section7-text');
            if (section7Text && section7Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 7 - APREENS√ïES E CADEIA DE CUST√ìDIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section7Text.textContent.trim() + "\n\n\n";
            }

            // Se√ß√£o 8
            const section8Text = document.getElementById('section8-text');
            if (section8Text && section8Text.textContent.trim()) {
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
                fullBO += "SE√á√ÉO 8 - CONDU√á√ÉO E P√ìS-OCORR√äNCIA\n";
                fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
                fullBO += section8Text.textContent.trim() + "\n\n\n";
            }

            if (!fullBO) {
                showToast('‚ùå Nenhum texto gerado para copiar');
                return;
            }

            // Adicionar footer
            fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            fullBO += "Gerado por: BO Inteligente v0.12.12\n";
            fullBO += "Data: " + new Date().toLocaleDateString('pt-BR') + "\n";
            fullBO += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

            navigator.clipboard.writeText(fullBO)
                .then(() => {
                    showToast('üìë BO completo copiado! (Todas se√ß√µes)');
                })
                .catch(err => {
                    console.error('[Copy] Erro ao copiar BO completo:', err);
                    showToast('‚ùå Erro ao copiar BO completo');
                });
        }

        // ================================================================
        // FUN√á√ïES DA SIDEBAR
        // ================================================================

        // Mapa de todas as se√ß√µes futuras (2-8)
        const ALL_SECTIONS = {
            1: { emoji: 'üìù', name: 'Contexto da Ocorr√™ncia', questions: QUESTIONS },
            2: { emoji: 'üöó', name: 'Abordagem a Ve√≠culo', questions: SECTION2_QUESTIONS },
            3: { emoji: 'üëÅÔ∏è', name: 'Campana', questions: SECTION3_QUESTIONS },
            4: { emoji: 'üè†', name: 'Entrada em Domic√≠lio', questions: SECTION4_QUESTIONS },
            5: { emoji: 'üéØ', name: 'Fundada Suspeita', questions: SECTION5_QUESTIONS },
            6: { emoji: 'üí™', name: 'Rea√ß√£o e Uso da For√ßa', questions: SECTION6_QUESTIONS },
            7: { emoji: 'üì¶', name: 'Apreens√µes e Cadeia de Cust√≥dia', questions: SECTION7_QUESTIONS },
            8: { emoji: '‚öñÔ∏è', name: 'Condu√ß√£o e P√≥s-Ocorr√™ncia', questions: SECTION8_QUESTIONS }
        };

        // Adicionar uma pergunta √† sidebar (usado tanto na inicializa√ß√£o quanto dinamicamente)
        function addQuestionToSidebar(step, question, insertBefore = null) {
            // Verificar se j√° existe
            if (document.getElementById(`question-item-${step}`)) {
                return;
            }

            const questionItem = document.createElement('div');
            questionItem.id = `question-item-${step}`;
            questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
            questionItem.dataset.step = step;

            questionItem.innerHTML = `
                <div class="flex items-start gap-2">
                    <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                        ${step}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                        <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                            <span class="italic">Aguardando...</span>
                        </p>
                    </div>
                </div>
            `;

            questionItem.addEventListener('click', () => toggleQuestionExpand(step));

            if (insertBefore) {
                questionsList.insertBefore(questionItem, insertBefore);
            } else {
                questionsList.appendChild(questionItem);
            }
        }

        // Inicializar sidebar
        function initializeSidebar() {
            questionsList.innerHTML = ''; // Limpar

            // Perguntas obrigat√≥rias da Se√ß√£o 1 (excluir condicionais 1.5.1, 1.5.2, 1.9.1, 1.9.2)
            const mandatorySteps = ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7', '1.8', '1.9'];

            mandatorySteps.forEach(step => {
                if (QUESTIONS[step]) {
                    addQuestionToSidebar(step, QUESTIONS[step]);
                }
            });

            // Se√ß√µes futuras (2-8) - Apenas preview
            for (let i = 2; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            updateSidebarStatus('1.1', 'current');
        }

        // Atualizar status visual na sidebar
        function updateSidebarStatus(step, status) {
            const questionItem = document.getElementById(`question-item-${step}`);
            const icon = document.getElementById(`icon-${step}`);

            if (!questionItem || !icon) return;

            questionItem.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-gray-200');
            icon.classList.remove('bg-blue-500', 'text-white', 'bg-green-500', 'bg-gray-200', 'text-gray-600');

            if (status === 'current') {
                questionItem.classList.add('border-blue-500', 'bg-blue-50');
                icon.classList.add('bg-blue-500', 'text-white');
                icon.textContent = step; // Manter ID do step
            } else if (status === 'answered') {
                questionItem.classList.add('border-green-500', 'bg-green-50');
                icon.classList.add('bg-green-500', 'text-white');
                icon.textContent = '‚úì';
            } else {
                questionItem.classList.add('border-gray-200');
                icon.classList.add('bg-gray-200', 'text-gray-600');
                icon.textContent = step; // Manter ID do step
            }
        }

        // Atualizar resposta na sidebar
        function updateSidebarAnswer(step, answer) {
            const answerElement = document.getElementById(`answer-${step}`);
            if (answerElement && answer) {
                const truncated = answer.length > 60 ? answer.substring(0, 60) + '...' : answer;
                answerElement.innerHTML = `<span class="text-gray-700">${truncated}</span>`;
                answersState[step] = answer;
            }
        }

        // Expandir/colapsar pergunta
        function toggleQuestionExpand(step) {
            const answerElement = document.getElementById(`answer-${step}`);
            const answer = answersState[step];
            
            if (!answer || !answerElement) return;
            
            const isExpanded = answerElement.dataset.expanded === 'true';
            
            if (isExpanded) {
                const truncated = answer.length > 60 ? answer.substring(0, 60) + '...' : answer;
                answerElement.innerHTML = `<span class="text-gray-700">${truncated}</span>`;
                answerElement.dataset.expanded = 'false';
            } else {
                answerElement.innerHTML = `<span class="text-gray-700">${answer}</span>`;
                answerElement.dataset.expanded = 'true';
            }
        }

        // Obter resposta da sidebar por step
        function getSidebarAnswer(step) {
            return answersState[step] || '';
        }

        // Contar quantas perguntas foram respondidas na sidebar (Se√ß√£o 1)
        function getAnsweredStepsFromSidebar() {
            const section1Steps = ['1.1', '1.2', '1.3', '1.4', '1.5', '1.5.1', '1.5.2', '1.6', '1.7', '1.8', '1.9', '1.9.1', '1.9.2'];
            let count = 0;
            section1Steps.forEach(step => {
                if (answersState[step]) {
                    count++;
                }
            });
            return count;
        }

        // Atualizar progresso na sidebar
        function updateSidebarProgress(answered, total) {
            const percentage = (answered / total) * 100;
            sidebarProgressBar.style.width = `${percentage}%`;
            sidebarProgressText.textContent = `${answered}/${total}`;
        }

        // Atualizar sidebar para Se√ß√£o 2
        function updateSidebarForSection2() {
            // Inserir card de Se√ß√£o 1 completada ANTES do header
            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Verificar se j√° existe card de se√ß√£o completada
            const existingCompletedCard = sidebar.querySelector('.section-completed-card');
            if (!existingCompletedCard && sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-4';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-3">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto da Ocorr√™ncia</span>
                    </div>
                `;
                // Inserir ANTES do header com t√≠tulo e barra de progresso
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 2
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üöó Se√ß√£o 2 - Abordagem a Ve√≠culo';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 2 (sem header duplicado)
            Object.entries(SECTION2_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (3-8) - Apenas preview
            for (let i = 3; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 2 (13 perguntas: 2.1 a 2.13)
            updateSidebarProgress(0, 13);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('2.1', 'answered');
            updateSidebarAnswer('2.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('2.2', 'current');
        }

        // Atualizar sidebar para Se√ß√£o 3
        function updateSidebarForSection3() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1 e 2 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-4';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1 primeiro, depois 2)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 3
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üëÅÔ∏è Se√ß√£o 3 - Campana';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 3
            Object.entries(SECTION3_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (4-8) - Apenas preview
            for (let i = 4; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 3 (8 perguntas: 3.1 a 3.8)
            updateSidebarProgress(0, 8);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('3.1', 'answered');
            updateSidebarAnswer('3.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('3.2', 'current');
        }

        function updateSidebarForSection4() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2 e 3 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-4';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 4
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üè† Se√ß√£o 4 - Entrada em Domic√≠lio';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 4
            Object.entries(SECTION4_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (5-8) - Apenas preview
            for (let i = 5; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 4 (5 perguntas: 4.1 a 4.5)
            updateSidebarProgress(0, 5);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('4.1', 'answered');
            updateSidebarAnswer('4.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('4.2', 'current');
        }

        function updateSidebarForSection5() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2, 3 e 4 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-4';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3, 4)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 5
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üéØ Se√ß√£o 5 - Fundada Suspeita';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 5
            Object.entries(SECTION5_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-gray-100 text-gray-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (6-8) - Apenas preview
            for (let i = 6; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 5 (4 perguntas: 5.1 a 5.4)
            updateSidebarProgress(0, 4);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('5.1', 'answered');
            updateSidebarAnswer('5.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('5.2', 'current');
        }

        function updateSidebarForSection6() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√£o 1, 2, 3, 4 e 5 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-4';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem: se√ß√£o 1, 2, 3, 4, 5)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 6
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üí™ Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 6
            Object.entries(SECTION6_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-teal-100 text-teal-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√µes futuras (7-8) - Apenas preview
            for (let i = 7; i <= 8; i++) {
                const section = ALL_SECTIONS[i];
                const sectionPreview = document.createElement('div');
                sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
                sectionPreview.id = `section-preview-${i}`;
                sectionPreview.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span>${section.emoji}</span>
                        <span class="font-medium">Se√ß√£o ${i} - ${section.name}</span>
                        <span class="ml-auto text-xs">üîí</span>
                    </div>
                `;
                questionsList.appendChild(sectionPreview);
            }

            // Resetar progresso para Se√ß√£o 6 (5 perguntas: 6.1 a 6.5)
            updateSidebarProgress(0, 5);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('6.1', 'answered');
            updateSidebarAnswer('6.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('6.2', 'current');
        }

        function updateSidebarForSection7() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√µes 1 a 6 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-2';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                const section6Completed = document.createElement('div');
                section6Completed.className = 'section-completed-card mb-4';
                section6Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-teal-50 border border-teal-200 rounded-lg p-2">
                        <span class="text-teal-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-teal-800">üí™ Se√ß√£o 6 - Rea√ß√£o</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem correta: 1,2,3,4,5,6)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section6Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 7
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'üì¶ Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 7
            Object.entries(SECTION7_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-amber-100 text-amber-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Se√ß√£o futura (8) - Apenas preview
            const section = ALL_SECTIONS[8];
            const sectionPreview = document.createElement('div');
            sectionPreview.className = 'mt-4 pt-3 border-t border-gray-200';
            sectionPreview.id = 'section-preview-8';
            sectionPreview.innerHTML = `
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <span>${section.emoji}</span>
                    <span class="font-medium">Se√ß√£o 8 - ${section.name}</span>
                    <span class="ml-auto text-xs">üîí</span>
                </div>
            `;
            questionsList.appendChild(sectionPreview);

            // Resetar progresso para Se√ß√£o 7 (4 perguntas: 7.1 a 7.4)
            updateSidebarProgress(0, 4);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('7.1', 'answered');
            updateSidebarAnswer('7.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('7.2', 'current');
        }

        function updateSidebarForSection8() {
            // Remover cards anteriores de se√ß√µes completadas
            const existingCompletedCards = sidebar.querySelectorAll('.section-completed-card');
            existingCompletedCards.forEach(card => card.remove());

            const sidebarHeaderDiv = sidebar.querySelector('.mb-4.pb-4.border-b');

            // Adicionar cards de Se√ß√µes 1 a 7 completadas
            if (sidebarHeaderDiv) {
                const section1Completed = document.createElement('div');
                section1Completed.className = 'section-completed-card mb-2';
                section1Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                        <span class="text-green-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-green-800">üìù Se√ß√£o 1 - Contexto</span>
                    </div>
                `;

                const section2Completed = document.createElement('div');
                section2Completed.className = 'section-completed-card mb-2';
                section2Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <span class="text-blue-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-blue-800">üöó Se√ß√£o 2 - Abordagem</span>
                    </div>
                `;

                const section3Completed = document.createElement('div');
                section3Completed.className = 'section-completed-card mb-2';
                section3Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-purple-50 border border-purple-200 rounded-lg p-2">
                        <span class="text-purple-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-purple-800">üëÅÔ∏è Se√ß√£o 3 - Campana</span>
                    </div>
                `;

                const section4Completed = document.createElement('div');
                section4Completed.className = 'section-completed-card mb-2';
                section4Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-orange-50 border border-orange-200 rounded-lg p-2">
                        <span class="text-orange-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-orange-800">üè† Se√ß√£o 4 - Entrada</span>
                    </div>
                `;

                const section5Completed = document.createElement('div');
                section5Completed.className = 'section-completed-card mb-2';
                section5Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-pink-50 border border-pink-200 rounded-lg p-2">
                        <span class="text-pink-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-pink-800">üéØ Se√ß√£o 5 - Fundada Suspeita</span>
                    </div>
                `;

                const section6Completed = document.createElement('div');
                section6Completed.className = 'section-completed-card mb-2';
                section6Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-teal-50 border border-teal-200 rounded-lg p-2">
                        <span class="text-teal-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-teal-800">üí™ Se√ß√£o 6 - Rea√ß√£o</span>
                    </div>
                `;

                const section7Completed = document.createElement('div');
                section7Completed.className = 'section-completed-card mb-4';
                section7Completed.innerHTML = `
                    <div class="flex items-center gap-2 text-sm bg-amber-50 border border-amber-200 rounded-lg p-2">
                        <span class="text-amber-600 font-bold text-lg">‚úì</span>
                        <span class="font-semibold text-amber-800">üì¶ Se√ß√£o 7 - Apreens√µes</span>
                    </div>
                `;

                // Inserir ANTES do header (em ordem correta: 1,2,3,4,5,6,7)
                sidebarHeaderDiv.parentNode.insertBefore(section1Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section2Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section3Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section4Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section5Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section6Completed, sidebarHeaderDiv);
                sidebarHeaderDiv.parentNode.insertBefore(section7Completed, sidebarHeaderDiv);
            }

            // Atualizar t√≠tulo do header para Se√ß√£o 8
            const sidebarTitle = sidebar.querySelector('h2');
            if (sidebarTitle) {
                sidebarTitle.textContent = '‚öñÔ∏è Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia';
            }

            // Limpar perguntas antigas
            questionsList.innerHTML = '';

            // Adicionar perguntas da Se√ß√£o 8
            Object.entries(SECTION8_QUESTIONS).forEach(([step, question]) => {
                const questionItem = document.createElement('div');
                questionItem.id = `question-item-${step}`;
                questionItem.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors mb-2';
                questionItem.dataset.step = step;

                questionItem.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-8 h-6 rounded flex items-center justify-center text-xs font-bold bg-indigo-100 text-indigo-600 mt-0.5" id="icon-${step}">
                            ${step}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 mb-1">${question}</p>
                            <p class="text-xs text-gray-500 truncate" id="answer-${step}">
                                <span class="italic">Aguardando...</span>
                            </p>
                        </div>
                    </div>
                `;

                questionItem.addEventListener('click', () => toggleQuestionExpand(step));
                questionsList.appendChild(questionItem);
            });

            // Resetar progresso para Se√ß√£o 8 (6 perguntas: 8.1 a 8.6)
            updateSidebarProgress(0, 6);

            // Marcar primeira pergunta como respondida (auto-resposta "SIM")
            updateSidebarStatus('8.1', 'answered');
            updateSidebarAnswer('8.1', 'Sim');

            // Marcar segunda pergunta como current
            updateSidebarStatus('8.2', 'current');
        }

        // Toggle sidebar mobile
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('open');
        });

        sidebarClose.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        // ================================================================
        // FUN√á√ïES DE FEEDBACK
        // ================================================================

        function sendFeedback(eventId, feedbackType, buttonElement) {
            const boId = currentBoId || 'BO-TEMP-' + sessionId;
			
			// ‚úÖ BLOQUEAR DUPLO CLIQUE
			if (buttonElement.disabled) {
				return; // J√° est√° processando
			}
			
			// ‚úÖ CAPTURAR TEXTO DA MENSAGEM
			const messageDiv = buttonElement.closest('.message-container');
			const messageText = messageDiv ? messageDiv.dataset.currentText : '';
			const step = messageDiv ? messageDiv.dataset.step : null;
			
            if (!boId) {
                console.error('BO ID n√£o dispon√≠vel');
                showToast('‚ùå Aguarde inicializa√ß√£o...');
                return;
            }
            
            if (buttonElement) {
                buttonElement.classList.add('clicked');
                buttonElement.disabled = true;
            }
            
            fetch(`${API_URL}/feedback`, {
                    method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						bo_id: boId,
						event_id: eventId,
						feedback_type: feedbackType,
						context: {  // ‚úÖ ADICIONAR CONTEXT
							step: step,
							message: messageText
						},
                    metadata: {
                        screen_resolution: `${screen.width}x${screen.height}`,
                        viewport: `${window.innerWidth}x${window.innerHeight}`,
                        platform: navigator.platform,
                        language: navigator.language,
                        user_agent: navigator.userAgent
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    showToast(feedbackType === 'positive' ? '‚úÖ Obrigado pelo feedback!' : 'üëç Feedback enviado!');
                } else {
                    throw new Error('Erro ao enviar feedback');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('‚ùå Erro ao enviar feedback');
                if (buttonElement) {
                    buttonElement.classList.remove('clicked');
                    buttonElement.disabled = false;
                }
            });
        }

        function openFeedbackModal(eventId, messageText, step, buttonElement) {
            const messageDiv = buttonElement.closest('.message-container');
            const currentText = messageDiv ? (messageDiv.dataset.currentText || messageText) : messageText;
            
            const message = prompt(`üí¨ Feedback sobre: "${currentText}"\n\nO que aconteceu? (Descreva o problema ou sugest√£o)`);
            
            if (message && message.trim()) {
                sendDetailedFeedback(eventId, message, step, currentText, buttonElement);
            }
        }

        function sendDetailedFeedback(eventId, userMessage, step, contextMessage, buttonElement) {
            const boId = currentBoId || 'BO-TEMP-' + sessionId;
            
            if (!boId) {
                showToast('‚ùå BO ID n√£o dispon√≠vel');
                return;
            }
            
            if (buttonElement) {
                buttonElement.classList.add('clicked');
                buttonElement.disabled = true;
            }
            
            fetch(`${API_URL}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bo_id: boId,
                    event_id: eventId,
                    feedback_type: 'negative',
                    category: 'bug',
                    user_message: userMessage,
                    context: {
                        step: step,
                        message: contextMessage
                    },
                    metadata: {
                        screen_resolution: `${screen.width}x${screen.height}`,
                        viewport: `${window.innerWidth}x${window.innerHeight}`,
                        platform: navigator.platform,
                        language: navigator.language,
                        user_agent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    showToast('‚úÖ Feedback detalhado enviado! Obrigado!');
                } else {
                    throw new Error('Erro ao enviar feedback');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('‚ùå Erro ao enviar feedback');
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            toast.style.opacity = '0';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.opacity = '1', 10);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ================================================================
        // FUN√á√ïES DO CHAT
        // ================================================================

        function addMessage(text, isBot = true, isError = false, step = null, eventId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'} message-container fade-in`;
            messageDiv.dataset.step = step;
            messageDiv.dataset.currentText = text;
            if (eventId) messageDiv.dataset.eventId = eventId;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `max-w-[80%] p-3 rounded-lg ${
                isError
                    ? 'bg-red-100 text-red-800 border border-red-300'
                    : isBot 
                        ? 'bg-blue-100 text-gray-800' 
                        : 'bg-blue-600 text-white'
            }`;
            
            if (isError) {
                bubbleDiv.style.whiteSpace = 'pre-wrap';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-start gap-2';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            textSpan.className = 'flex-1';
            contentDiv.appendChild(textSpan);
            
            // Bot√£o editar
            if (!isBot && !isError && step) {
                const editButton = document.createElement('button');
                editButton.innerHTML = '‚úèÔ∏è Editar';
                editButton.className = 'text-xs bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded transition-colors whitespace-nowrap';
                editButton.onclick = () => editAnswer(step, textSpan.textContent, messageDiv, bubbleDiv);
                contentDiv.appendChild(editButton);
            }
            
            bubbleDiv.appendChild(contentDiv);
            
            // Bot√µes de feedback
            if (eventId) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons flex gap-2 mt-2 justify-end';
                
                const thumbsUp = document.createElement('button');
                thumbsUp.innerHTML = 'üëç';
                thumbsUp.className = 'feedback-btn';
                thumbsUp.title = 'Feedback positivo';
                thumbsUp.onclick = function() {
                    sendFeedback(eventId, 'positive', this);
                };
                
                const thumbsDown = document.createElement('button');
                thumbsDown.innerHTML = 'üëé';
                thumbsDown.className = 'feedback-btn';
                thumbsDown.title = 'Reportar problema';
                thumbsDown.onclick = function() {
                    openFeedbackModal(eventId, text, step, this);
                };
                
                feedbackDiv.appendChild(thumbsUp);
                feedbackDiv.appendChild(thumbsDown);
                bubbleDiv.appendChild(feedbackDiv);
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function editAnswer(step, currentText, messageDiv, bubbleDiv) {
            const contentDiv = bubbleDiv.querySelector('div');
            const textSpan = contentDiv.querySelector('span');
            const editButton = contentDiv.querySelector('button');
            
            editButton.style.display = 'none';
            
            const inputContainer = document.createElement('div');
            inputContainer.className = 'flex-1 flex flex-col gap-1';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'px-2 py-1 bg-white bg-opacity-90 text-gray-900 rounded';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-sm text-red-200 hidden';
            errorDiv.style.whiteSpace = 'pre-wrap';
            
            inputContainer.appendChild(input);
            inputContainer.appendChild(errorDiv);
            
            const saveButton = document.createElement('button');
            saveButton.innerHTML = 'üíæ Salvar';
            saveButton.className = 'text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition-colors';
            
            const cancelButton = document.createElement('button');
            cancelButton.innerHTML = '‚ùå Cancelar';
            cancelButton.className = 'text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors ml-1';
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(inputContainer);
            contentDiv.appendChild(saveButton);
            contentDiv.appendChild(cancelButton);
            
            input.focus();
            
            const cancel = () => {
                contentDiv.innerHTML = '';
                contentDiv.appendChild(textSpan);
                contentDiv.appendChild(editButton);
                editButton.style.display = 'block';
            };
            
            const save = async () => {
                const newText = input.value.trim();
                
                if (!newText) {
                    errorDiv.textContent = '‚ö†Ô∏è Resposta n√£o pode estar vazia';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                saveButton.disabled = true;
                cancelButton.disabled = true;
                saveButton.textContent = '‚è≥ Salvando...';
                
                try {
                    const response = await fetch(`${API_URL}/chat/${sessionId}/answer/${step}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: newText, llm_provider: 'groq' })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        errorDiv.textContent = '‚ö†Ô∏è ' + (data.detail || 'Erro ao atualizar resposta');
                        errorDiv.classList.remove('hidden');
                        saveButton.disabled = false;
                        cancelButton.disabled = false;
                        saveButton.textContent = 'üíæ Salvar';
                        input.focus();
                        return;
                    }
                    
                    errorDiv.classList.add('hidden');
                    textSpan.textContent = newText;
                    messageDiv.dataset.currentText = newText;
                    
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(textSpan);
                    contentDiv.appendChild(editButton);
                    editButton.style.display = 'block';
                    
                    // Atualizar sidebar com nova resposta E marcar como answered
                    updateSidebarAnswer(step, newText);
                    updateSidebarStatus(step, 'answered');
                    
                    // ‚úÖ SALVAR RASCUNHO ap√≥s edi√ß√£o
                    saveDraft();
                    
                    const successDiv = document.createElement('div');
                    successDiv.className = 'text-sm text-green-300 mt-1';
                    successDiv.textContent = '‚úÖ Salvo!';
                    bubbleDiv.appendChild(successDiv);
                    
                    setTimeout(() => successDiv.remove(), 2000);
                    
                    // Bug #2 fix: Remover erro e mostrar pr√≥xima pergunta
                    let nextElement = messageDiv.nextElementSibling;
                    let hadError = false;
                    
                    while (nextElement) {
                        const errorDiv = nextElement.querySelector('.bg-red-100');
                        if (errorDiv) {
                            nextElement.remove();
                            hadError = true;
                            break;
                        }
                        nextElement = nextElement.nextElementSibling;
                    }
                    
                    if (hadError) {
                        const stepNum = parseInt(step.split('.')[1]);
                        
                        if (stepNum < 6) {
                            const nextStep = `1.${stepNum + 1}`;
                            const nextQuestion = QUESTIONS[nextStep];
                            
                            if (nextQuestion) {
                                // CR√çTICO: Atualizar currentQuestionStep ANTES de mostrar pergunta
                                currentQuestionStep = nextStep;
                                
                                // Atualizar sidebar
                                updateSidebarStatus(nextStep, 'current');
                                updateSidebarProgress(stepNum, 6);
                                
                                // Mostrar pr√≥xima pergunta
                                addMessage(nextQuestion, true, false, nextStep, `evt_${nextStep}_after_edit`);
                                
                                // Habilitar input
                                enableInput();
                            }
                        }
                    }
                    
                } catch (error) {
                    errorDiv.textContent = '‚ö†Ô∏è Erro: ' + error.message;
                    errorDiv.classList.remove('hidden');
                    saveButton.disabled = false;
                    cancelButton.disabled = false;
                    saveButton.textContent = 'üíæ Salvar';
                }
            };
            
            cancelButton.onclick = cancel;
            saveButton.onclick = save;
            input.onkeypress = (e) => {
                if (e.key === 'Enter') save();
                if (e.key === 'Escape') cancel();
            };
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="bg-gray-200 text-gray-600 p-3 rounded-lg"><span class="animate-pulse">Processando...</span></div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        function disableInput() {
            userInput.disabled = true;
            sendButton.disabled = true;
            isWaitingResponse = true;
        }

        function enableInput() {
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            isWaitingResponse = false;
            
            // Sugerir data/hora atual para pergunta 1.1
            if (currentQuestionStep === '1.1' && userInput.value === '') {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                
                userInput.value = `${day}/${month}/${year}, ${hour}h${minute}`;
                userInput.select(); // Seleciona o texto para facilitar edi√ß√£o
            }
        }

        async function startSession() {
            try {
                const response = await fetch(`${API_URL}/new_session`, { method: 'POST' });
                if (!response.ok) throw new Error('Erro ao iniciar sess√£o');

                const data = await response.json();
                sessionId = data.session_id;
                currentBoId = data.bo_id;
                currentQuestionStep = '1.1';
                currentSection = 1;
                answersState = {}; // Resetar respostas
                boCompleted = false; // Resetar flag de BO completo

                console.log('Sess√£o iniciada:', { sessionId, currentBoId });

                addMessage('Ol√°! Vou te ajudar a fazer o BO de tr√°fico de drogas, simples, t√©cnico e dentro da lei. Vou perguntar uma coisa por vez. Responda com o que voc√™ viu, sem arredondar. Se algo n√£o se aplicar, escreva "N√ÉO".', true, false, null, 'welcome');

                setTimeout(() => {
                    addMessage(data.first_question, true, false, '1.1', 'evt_first_question');
                    enableInput();
                    updateSidebarProgress(0, 9);  // Base: 9 perguntas obrigat√≥rias
                }, 500);

            } catch (error) {
                addMessage('‚ùå Erro ao conectar com o servidor. Verifique se o backend est√° rodando.');
                console.error(error);
            }
        }

        function updateHeaderSection() {
            const headerSubtitle = document.querySelector('header p');
            if (headerSubtitle) {
                if (currentSection === 1) {
                    headerSubtitle.textContent = 'Se√ß√£o 1 - Contexto da Ocorr√™ncia';
                } else if (currentSection === 2) {
                    headerSubtitle.textContent = 'Se√ß√£o 2 - Abordagem a Ve√≠culo';
                } else if (currentSection === 3) {
                    headerSubtitle.textContent = 'Se√ß√£o 3 - Campana';
                } else if (currentSection === 4) {
                    headerSubtitle.textContent = 'Se√ß√£o 4 - Entrada em Domic√≠lio';
                } else if (currentSection === 5) {
                    headerSubtitle.textContent = 'Se√ß√£o 5 - Fundada Suspeita';
                } else if (currentSection === 6) {
                    headerSubtitle.textContent = 'Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa';
                } else if (currentSection === 7) {
                    headerSubtitle.textContent = 'Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia';
                } else if (currentSection === 8) {
                    headerSubtitle.textContent = 'Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (FINAL)';
                }
            }
        }

        async function startSection2() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section2');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 2');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 2;
                currentQuestionStep = data.current_step;
                // N√ÉO resetar answersState! Ele deve manter todas as respostas (Se√ß√£o 1 + 2)

                console.log('Se√ß√£o 2 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 2 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section2-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section2-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 2
                addMessage('üìã Iniciando Se√ß√£o 2 - Abordagem a Ve√≠culo', true, false, null, 'evt_section2_start');

                // Adicionar primeira pergunta da Se√ß√£o 2
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section2_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 2
                    updateSidebarForSection2();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 2:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 2. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section2');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, havia ve√≠culo';
                }
            }
        }

        async function startSection3() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section3');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/3`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 3');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 3;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 3 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 3 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section3-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section3-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 3
                addMessage('üìã Iniciando Se√ß√£o 3 - Campana (Vigil√¢ncia Velada)', true, false, null, 'evt_section3_start');

                // Adicionar primeira pergunta da Se√ß√£o 3
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section3_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 3
                    updateSidebarForSection3();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 3:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 3. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section3');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve campana';
                }
            }
        }

        async function startSection4() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section4');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/4`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 4');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 4;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 4 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 4 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section4-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section4-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 4
                addMessage('üè† Iniciando Se√ß√£o 4 - Entrada em Domic√≠lio', true, false, null, 'evt_section4_start');

                // Adicionar primeira pergunta da Se√ß√£o 4
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section4_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 4
                    updateSidebarForSection4();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 4:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 4. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section4');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve entrada em domic√≠lio';
                }
            }
        }

        async function startSection5() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section5');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/5`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 5');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 5;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 5 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 5 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section5-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section5-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 5
                addMessage('üéØ Iniciando Se√ß√£o 5 - Fundada Suspeita', true, false, null, 'evt_section5_start');

                // Adicionar primeira pergunta da Se√ß√£o 5
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section5_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 5
                    updateSidebarForSection5();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 5:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 5. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section5');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve fundada suspeita';
                }
            }
        }

        async function startSection6() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section6');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/6`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 6');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 6;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 6 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 6 (pode ter dois IDs poss√≠veis)
                const transitionCard = document.getElementById('section6-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section6-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 6
                addMessage('üí™ Iniciando Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa', true, false, null, 'evt_section6_start');

                // Adicionar primeira pergunta da Se√ß√£o 6
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section6_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 6
                    updateSidebarForSection6();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 6:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 6. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section6');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve resist√™ncia';
                }
            }
        }

        async function startSection7() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section7');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/7`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 7');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 7;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 7 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 7
                const transitionCard = document.getElementById('section7-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section7-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 7
                addMessage('üì¶ Iniciando Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia', true, false, null, 'evt_section7_start');

                // Adicionar primeira pergunta da Se√ß√£o 7
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section7_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 7
                    updateSidebarForSection7();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 7:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 7. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section7');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚úÖ Sim, houve apreens√£o';
                }
            }
        }

        async function startSection8() {
            try {
                // Desabilitar bot√£o para evitar cliques duplicados
                const button = document.getElementById('btn-start-section8');
                if (button) {
                    button.disabled = true;
                    button.textContent = '‚è≥ Iniciando...';
                }

                const response = await fetch(`${API_URL}/start_section/8`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error('Erro ao iniciar Se√ß√£o 8');
                }

                const data = await response.json();

                // Atualizar estado da aplica√ß√£o
                currentSection = 8;
                currentQuestionStep = data.current_step;

                console.log('Se√ß√£o 8 iniciada:', data);

                // Atualizar header
                updateHeaderSection();

                // Limpar card/bot√£o de transi√ß√£o para Se√ß√£o 8
                const transitionCard = document.getElementById('section8-transition-card');
                if (transitionCard) transitionCard.remove();
                const buttonContainer = document.getElementById('section8-button-container');
                if (buttonContainer) buttonContainer.remove();

                // Mensagem de in√≠cio da Se√ß√£o 8
                addMessage('‚öñÔ∏è Iniciando Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (√öLTIMA SE√á√ÉO)', true, false, null, 'evt_section8_start');

                // Adicionar primeira pergunta da Se√ß√£o 8
                setTimeout(() => {
                    addMessage(data.question, true, false, data.current_step, 'evt_section8_first_q');
                    enableInput();

                    // üìç Scroll at√© o TOPO da p√°gina para ver a pergunta
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    // üéØ Focar no input do chat
                    userInput.focus();

                    // Atualizar sidebar para Se√ß√£o 8
                    updateSidebarForSection8();
                }, 500);

            } catch (error) {
                console.error('Erro ao iniciar Se√ß√£o 8:', error);
                addMessage('‚ùå Erro ao iniciar Se√ß√£o 8. Tente novamente.', true, true);

                // Reabilitar bot√£o em caso de erro
                const button = document.getElementById('btn-start-section8');
                if (button) {
                    button.disabled = false;
                    button.textContent = '‚ñ∂Ô∏è Iniciar Se√ß√£o 8';
                }
            }
        }

        async function skipSection(sectionNumber) {
            if (!sessionId) {
                showToast('‚ùå Nenhuma sess√£o ativa');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/skip_section/${sectionNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) throw new Error('Erro ao pular se√ß√£o');

                const data = await response.json();

                // Atualizar se√ß√£o atual
                currentSection = sectionNumber;

                // Mostrar mensagem no chat
                addMessage(`‚úÖ Se√ß√£o ${sectionNumber} n√£o se aplica.`, true);

                // Atualizar card da se√ß√£o como "Pulada"
                addSkippedSectionText(sectionNumber, data.generated_text);

                // Remover AMBOS os poss√≠veis containers do bot√£o atual
                const buttonContainer = document.getElementById(`section${sectionNumber}-button-container`);
                if (buttonContainer) buttonContainer.remove();
                const transitionCard = document.getElementById(`section${sectionNumber}-transition-card`);
                if (transitionCard) transitionCard.remove();

                // Desabilitar input
                disableInput();

                // üìç Scroll at√© o final para ver o card de se√ß√£o pulada
                setTimeout(() => {
                    window.scrollTo({
                        top: document.documentElement.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 300);

                // Mostrar mensagem de orienta√ß√£o
                if (sectionNumber < 8) {
                    addMessage('‚¨áÔ∏è Role para baixo para ver o bot√£o da pr√≥xima se√ß√£o.', true, false, null, 'evt_scroll_guidance');

                    // Criar bot√£o da pr√≥xima se√ß√£o
                    setTimeout(() => {
                        const nextSectionNum = sectionNumber + 1;
                        const nextSection = ALL_SECTIONS[nextSectionNum];
                        const nextSectionButtonDiv = document.createElement('div');
                        nextSectionButtonDiv.id = `section${nextSectionNum}-button-container`;

                        // Definir cores por se√ß√£o
                        const sectionColors = {
                            2: { bg: 'from-blue-50 to-indigo-50', border: 'border-blue-200', text: 'text-blue-900', btn: 'bg-blue-600 hover:bg-blue-700' },
                            3: { bg: 'from-purple-50 to-indigo-50', border: 'border-purple-200', text: 'text-purple-900', btn: 'bg-purple-600 hover:bg-purple-700' },
                            4: { bg: 'from-orange-50 to-orange-100', border: 'border-orange-200', text: 'text-orange-900', btn: 'bg-orange-600 hover:bg-orange-700' },
                            5: { bg: 'from-pink-50 to-pink-100', border: 'border-pink-200', text: 'text-pink-900', btn: 'bg-pink-600 hover:bg-pink-700' },
                            6: { bg: 'from-teal-50 to-cyan-50', border: 'border-teal-200', text: 'text-teal-900', btn: 'bg-teal-600 hover:bg-teal-700' },
                            7: { bg: 'from-amber-50 to-amber-100', border: 'border-amber-200', text: 'text-amber-900', btn: 'bg-amber-600 hover:bg-amber-700' },
                            8: { bg: 'from-indigo-50 to-indigo-100', border: 'border-indigo-200', text: 'text-indigo-900', btn: 'bg-indigo-600 hover:bg-indigo-700' }
                        };

                        const colors = sectionColors[nextSectionNum];
                        nextSectionButtonDiv.className = `mt-6 p-6 bg-gradient-to-r ${colors.bg} border-2 ${colors.border} rounded-xl text-center`;

                        // Textos contextuais
                        const sectionTexts = {
                            2: 'Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.',
                            3: 'A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.',
                            4: 'Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.',
                            5: 'Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.',
                            6: 'Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.',
                            7: 'Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.',
                            8: '√öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.'
                        };

                        const startTexts = {
                            2: 'Sim, havia ve√≠culo',
                            3: 'Sim, houve campana',
                            4: 'Sim, houve entrada em domic√≠lio',
                            5: 'Sim, houve fundada suspeita',
                            6: 'Sim, houve resist√™ncia',
                            7: 'Sim, houve apreens√£o'
                        };

                        const skipTexts = {
                            2: 'N√£o havia ve√≠culo',
                            3: 'N√£o houve campana',
                            4: 'N√£o houve entrada em domic√≠lio',
                            5: 'N√£o houve fundada suspeita',
                            6: 'N√£o houve resist√™ncia',
                            7: 'N√£o houve apreens√£o'
                        };

                        let buttonsHTML = '';
                        if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                            buttonsHTML = `
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button id="btn-skip-section${nextSectionNum}" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è ${skipTexts[nextSectionNum]}
                                    </button>
                                    <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 ${colors.btn} text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ ${startTexts[nextSectionNum]}
                                    </button>
                                </div>
                            `;
                        } else {
                            buttonsHTML = `
                                <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 ${colors.btn} text-white font-semibold rounded-lg transition-colors">
                                    ‚ñ∂Ô∏è Iniciar Se√ß√£o ${nextSectionNum}${nextSectionNum === 8 ? ' (FINAL)' : ''}
                                </button>
                            `;
                        }

                        nextSectionButtonDiv.innerHTML = `
                            <h3 class="text-xl font-bold ${colors.text} mb-2">${nextSection.emoji} Se√ß√£o ${nextSectionNum}: ${nextSection.name}</h3>
                            <p class="text-gray-700 mb-4">
                                ${sectionTexts[nextSectionNum]}
                            </p>
                            ${buttonsHTML}
                        `;

                        generatedSectionsContainer.parentElement.appendChild(nextSectionButtonDiv);

                        // Event listeners
                        const startFunctionName = `startSection${nextSectionNum}`;
                        if (window[startFunctionName]) {
                            document.getElementById(`btn-start-section${nextSectionNum}`).addEventListener('click', window[startFunctionName]);
                        }
                        if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                            document.getElementById(`btn-skip-section${nextSectionNum}`).addEventListener('click', () => skipSection(nextSectionNum));
                        }
                    }, 500);
                }

                // Salvar rascunho
                saveDraft();

            } catch (error) {
                console.error('[Skip] Erro:', error);
                showToast('‚ùå Erro ao pular se√ß√£o');
            }
        }

        async function sendMessage() {
			const message = userInput.value.trim();
			if (!message || isWaitingResponse) return;

			// Capturar step ANTES de enviar
			const displayStep = currentQuestionStep;

			// ‚úÖ ADICIONAR AQUI (depois da linha 774, antes do addMessage):
			// Auto-completar ano se faltando (step 1.1)
			let finalMessage = message;
			if (displayStep === '1.1' && !/20\d{2}/.test(message)) {
				finalMessage = message + ` de ${new Date().getFullYear()}`;
			}

			addMessage(finalMessage, false, false, displayStep);  // ‚Üê USAR finalMessage
			userInput.value = '';

			disableInput();
			showLoading();

			try {
				const response = await fetch(`${API_URL}/chat`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						session_id: sessionId,
						message: finalMessage,  // ‚Üê USAR finalMessage AQUI TAMB√âM
						current_section: currentSection,  // ‚úÖ NOVO: Enviar se√ß√£o atual
						llm_provider: 'groq'
					})
				});
                
                if (!response.ok) throw new Error('Erro ao processar resposta');
                
                const data = await response.json();
                removeLoading();
                
                if (data.bo_id) {
                    currentBoId = data.bo_id;
                }
                
                // CR√çTICO: Usar step do BACKEND, n√£o da vari√°vel local
                // Isso garante que ap√≥s edi√ß√£o, usamos o step correto
                const actualStep = data.validation_error ? displayStep : (data.current_step || displayStep);
                
                // Atualizar sidebar com resposta (usar displayStep que foi enviado)
                updateSidebarAnswer(displayStep, message);
                
                // Anexar event_id
                if (data.event_id) {
                    const lastUserMessage = chatContainer.querySelector('.message-container:last-of-type');
                    if (lastUserMessage) {
                        lastUserMessage.dataset.eventId = data.event_id;
                        
                        const bubbleDiv = lastUserMessage.querySelector('.bg-blue-600');
                        if (bubbleDiv && !bubbleDiv.querySelector('.feedback-buttons')) {
                            const feedbackDiv = document.createElement('div');
                            feedbackDiv.className = 'feedback-buttons flex gap-2 mt-2 justify-end';
                            
                            const thumbsUp = document.createElement('button');
                            thumbsUp.innerHTML = 'üëç';
                            thumbsUp.className = 'feedback-btn';
                            thumbsUp.onclick = function() {
                                sendFeedback(data.event_id, 'positive', this);
                            };
                            
                            const thumbsDown = document.createElement('button');
                            thumbsDown.innerHTML = 'üëé';
                            thumbsDown.className = 'feedback-btn';
                            thumbsDown.onclick = function() {
                                openFeedbackModal(data.event_id, message, displayStep, this);
                            };
                            
                            feedbackDiv.appendChild(thumbsUp);
                            feedbackDiv.appendChild(thumbsDown);
                            bubbleDiv.appendChild(feedbackDiv);
                        }
                    }
                }
                
                // Atualizar currentQuestionStep com valor do backend
                if (!data.is_section_complete && data.current_step) {
                    currentQuestionStep = data.current_step;
                }
                
                if (data.validation_error) {
                    addMessage('‚ö†Ô∏è ' + data.validation_error, true, true, null, data.event_id || 'evt_validation_error');
                    enableInput();
                    return;
                }

                // Calcular progresso baseado na se√ß√£o atual
                let progress, totalQuestions;
                if (currentSection === 1) {
                    // Se√ß√£o 1: Calcular progresso localmente baseado no step
                    // updateSidebarAnswer j√° foi chamado acima, ent√£o answersState j√° inclui a resposta atual
                    const answeredSteps = getAnsweredStepsFromSidebar();
                    progress = answeredSteps; // J√° inclui a resposta atual (n√£o precisa +1)

                    // Calcular total din√¢mico baseado nas respostas anteriores
                    totalQuestions = 9; // Base: 9 perguntas obrigat√≥rias

                    // Verificar se 1.5 foi respondido como SIM (verifica sidebar ou resposta atual)
                    const answer_1_5_sidebar = getSidebarAnswer('1.5');
                    const justAnswered_1_5 = displayStep === '1.5' ? finalMessage : null;
                    const answer_1_5 = justAnswered_1_5 || answer_1_5_sidebar || '';
                    if (['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(answer_1_5.toUpperCase().trim())) {
                        totalQuestions += 2; // Adiciona 1.5.1 e 1.5.2
                    }

                    // Verificar se 1.9 foi respondido como SIM
                    const answer_1_9_sidebar = getSidebarAnswer('1.9');
                    const justAnswered_1_9 = displayStep === '1.9' ? finalMessage : null;
                    const answer_1_9 = justAnswered_1_9 || answer_1_9_sidebar || '';
                    if (['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(answer_1_9.toUpperCase().trim())) {
                        totalQuestions += 2; // Adiciona 1.9.1 e 1.9.2
                    }
                } else if (currentSection === 2) {
                    progress = data.current_step === 'complete' ? 13 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 13;
                } else if (currentSection === 3) {
                    progress = data.current_step === 'complete' ? 8 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 8;
                } else if (currentSection === 4) {
                    progress = data.current_step === 'complete' ? 5 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 5;
                } else if (currentSection === 5) {
                    progress = data.current_step === 'complete' ? 4 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 4;
                } else if (currentSection === 6) {
                    progress = data.current_step === 'complete' ? 5 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 5;
                } else if (currentSection === 7) {
                    progress = data.current_step === 'complete' ? 4 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 4;
                } else if (currentSection === 8) {
                    progress = data.current_step === 'complete' ? 6 : parseInt(data.current_step.split('.')[1]);
                    totalQuestions = 6;
                }

                // Atualizar sidebar com step que FOI VALIDADO (displayStep)
                updateSidebarStatus(displayStep, 'answered');
                updateSidebarProgress(progress, totalQuestions);

                // ‚úÖ ADICIONAR PERGUNTAS CONDICIONAIS DINAMICAMENTE (Se√ß√£o 1)
                // Usar finalMessage (resposta local) em vez de data.submitted_answer (n√£o existe no backend)
                if (currentSection === 1 && displayStep === '1.5') {
                    // Se resposta em 1.5 foi SIM, adicionar 1.5.1 e 1.5.2 ap√≥s 1.5
                    if (['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(finalMessage.toUpperCase().trim())) {
                        const question_1_6 = document.getElementById('question-item-1.6');
                        addQuestionToSidebar('1.5.1', SECTION1_QUESTIONS['1.5.1'], question_1_6);
                        addQuestionToSidebar('1.5.2', SECTION1_QUESTIONS['1.5.2'], question_1_6);
                    }
                } else if (currentSection === 1 && displayStep === '1.9') {
                    // Se resposta em 1.9 foi SIM, adicionar 1.9.1 e 1.9.2 ap√≥s 1.9
                    if (['SIM', 'S', 'AFIRMATIVO', 'S√ÉO'].includes(finalMessage.toUpperCase().trim())) {
                        const section2Preview = document.getElementById('section-preview-2');
                        addQuestionToSidebar('1.9.1', SECTION1_QUESTIONS['1.9.1'], section2Preview);
                        addQuestionToSidebar('1.9.2', SECTION1_QUESTIONS['1.9.2'], section2Preview);
                    }
                }

                if (data.is_section_complete) {
                    // ‚úÖ LIMPAR RASCUNHO ao completar (ANTES de qualquer outra a√ß√£o)
                    clearDraft();

                    // ‚ö†Ô∏è VERIFICAR SE SE√á√ÉO FOI PULADA (v0.9.0)
                    if (data.section_skipped) {
                        const section = ALL_SECTIONS[currentSection];
                        addMessage(`‚úÖ Se√ß√£o ${currentSection} n√£o se aplica.`, true, false, null, 'evt_section_skipped');

                        // Adicionar texto de se√ß√£o pulada no card correto (mantendo ordem)
                        addSkippedSectionText(currentSection, data.generated_text);

                        // Desabilitar inputs e preparar para pr√≥xima se√ß√£o
                        disableInput();

                        // Mostrar mensagem de orienta√ß√£o ou conclus√£o
                        if (currentSection < 8) {
                            addMessage('‚¨áÔ∏è Role para baixo para ver o texto gerado e clique no bot√£o para continuar para a pr√≥xima se√ß√£o.', true, false, null, 'evt_scroll_guidance');
                        } else {
                            addMessage('üéâ Parab√©ns! Voc√™ chegou ao final do BO! Todas as se√ß√µes foram processadas.', true, false, null, 'evt_completion');
                        }

                        // Mostrar bot√£o para pr√≥xima se√ß√£o (se n√£o for a √∫ltima)
                        if (currentSection < 8) {
                            setTimeout(() => {
                                const nextSectionNum = currentSection + 1;
                                const nextSection = ALL_SECTIONS[nextSectionNum];
                                const nextSectionButtonDiv = document.createElement('div');
                                nextSectionButtonDiv.id = `section${nextSectionNum}-transition-card`;
                                nextSectionButtonDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center fade-in';

                                // Criar o HTML com base na pr√≥xima se√ß√£o (reusando a l√≥gica existente)
                                let buttonHTML = `
                                    <h3 class="font-bold text-blue-900 mb-2">${nextSection.emoji} Se√ß√£o ${nextSectionNum} - ${nextSection.name}</h3>
                                    <p class="text-sm text-blue-700 mb-3">`;

                                // Adicionar textos contextuais para cada se√ß√£o
                                switch(nextSectionNum) {
                                    case 3:
                                        buttonHTML += 'A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 4:
                                        buttonHTML += 'Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 5:
                                        buttonHTML += 'Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 6:
                                        buttonHTML += 'Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 7:
                                        buttonHTML += 'Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.';
                                        break;
                                    case 8:
                                        buttonHTML += '√öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.';
                                        break;
                                }

                                buttonHTML += `
                                    </p>`;

                                // Adicionar bot√µes (com skip apenas para se√ß√µes 2-7)
                                if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                                    const startTexts = {
                                        2: 'Sim, havia ve√≠culo',
                                        3: 'Sim, houve campana',
                                        4: 'Sim, houve entrada em domic√≠lio',
                                        5: 'Sim, houve fundada suspeita',
                                        6: 'Sim, houve resist√™ncia',
                                        7: 'Sim, houve apreens√£o'
                                    };
                                    const skipTexts = {
                                        2: 'N√£o havia ve√≠culo',
                                        3: 'N√£o houve campana',
                                        4: 'N√£o houve entrada em domic√≠lio',
                                        5: 'N√£o houve fundada suspeita',
                                        6: 'N√£o houve resist√™ncia',
                                        7: 'N√£o houve apreens√£o'
                                    };
                                    buttonHTML += `
                                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                            <button id="btn-skip-section${nextSectionNum}" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                                ‚è≠Ô∏è ${skipTexts[nextSectionNum]}
                                            </button>
                                            <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                                ‚úÖ ${startTexts[nextSectionNum]}
                                            </button>
                                        </div>
                                    `;
                                } else {
                                    buttonHTML += `
                                        <button id="btn-start-section${nextSectionNum}" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                            ‚ñ∂Ô∏è Iniciar Se√ß√£o ${nextSectionNum}
                                        </button>
                                    `;
                                }

                                nextSectionButtonDiv.innerHTML = buttonHTML;
                                generatedSectionsContainer.parentElement.appendChild(nextSectionButtonDiv);

                                // Adicionar event listeners din√¢micos
                                const startFunctionName = `startSection${nextSectionNum}`;
                                if (window[startFunctionName]) {
                                    document.getElementById(`btn-start-section${nextSectionNum}`).addEventListener('click', window[startFunctionName]);
                                }
                                if (nextSectionNum >= 2 && nextSectionNum <= 7) {
                                    document.getElementById(`btn-skip-section${nextSectionNum}`).addEventListener('click', () => skipSection(nextSectionNum));
                                }
                            }, 500);
                        }

                        return;
                    }

                    let completionMessage;
                    if (currentSection === 1) {
                        completionMessage = '‚úÖ Se√ß√£o 1 completa! Gerando texto...';
                    } else if (currentSection === 2) {
                        completionMessage = '‚úÖ Se√ß√£o 2 completa! Gerando texto...';
                    } else if (currentSection === 3) {
                        completionMessage = '‚úÖ Se√ß√£o 3 completa! Gerando texto...';
                    } else if (currentSection === 4) {
                        completionMessage = '‚úÖ Se√ß√£o 4 completa! Gerando texto...';
                    } else if (currentSection === 5) {
                        completionMessage = '‚úÖ Se√ß√£o 5 completa! Gerando texto...';
                    } else if (currentSection === 6) {
                        completionMessage = '‚úÖ Se√ß√£o 6 completa! Gerando texto...';
                    } else if (currentSection === 7) {
                        completionMessage = '‚úÖ Se√ß√£o 7 completa! Gerando texto...';
                        // N√ÉO marcar boCompleted aqui - Se√ß√£o 8 ainda vir√°
                    } else if (currentSection === 8) {
                        completionMessage = '‚úÖ Se√ß√£o 8 completa! Gerando texto final...';
                        // CR√çTICO: Se√ß√£o 8 √© a √öLTIMA - marcar BO como completo
                        boCompleted = true;
                        console.log('[BO] BO marcado como COMPLETO!');
                    }

                    addMessage(completionMessage, true, false, null, 'evt_generating');
                    setTimeout(() => {
                        // ‚úÖ NOVO: Adicionar texto ao container persistente
                        addGeneratedSectionText(currentSection, data.generated_text);

                        // ‚úÖ Adicionar mensagem de confirma√ß√£o que o texto foi gerado
                        if (currentSection === 8 && boCompleted) {
                            addMessage('üìã Texto da Se√ß√£o 8 foi gerado abaixo! Todas as se√ß√µes foram finalizadas. Copie o BO completo usando o bot√£o abaixo.', true, false, null, 'evt_text_generated');
                        } else {
                            addMessage(`üìù Texto da Se√ß√£o ${currentSection} foi gerado abaixo. Voc√™ pode copiar o texto e clicar no bot√£o para continuar para a pr√≥xima se√ß√£o.`, true, false, null, 'evt_text_generated');
                        }

                        // ‚úÖ Bot√µes para iniciar pr√≥xima se√ß√£o (SOMENTE se BO n√£o est√° completo)
                        if (currentSection === 1 && !boCompleted) {
                            const section2ButtonDiv = document.createElement('div');
                            section2ButtonDiv.id = 'section2-transition-card';
                            section2ButtonDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center fade-in';
                            section2ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-blue-900 mb-2">üöó Se√ß√£o 2 - Abordagem a Ve√≠culo</h3>
                                <p class="text-sm text-blue-700 mb-3">
                                    Havia ve√≠culo envolvido na ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section2"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o havia ve√≠culo
                                    </button>
                                    <button
                                        id="btn-start-section2"
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, havia ve√≠culo
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section2ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section2').addEventListener('click', startSection2);
                            document.getElementById('btn-skip-section2').addEventListener('click', () => skipSection(2));
                        } else if (currentSection === 2 && !boCompleted) {
                            const section3ButtonDiv = document.createElement('div');
                            section3ButtonDiv.id = 'section3-transition-card';
                            section3ButtonDiv.className = 'mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg text-center fade-in';
                            section3ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-purple-900 mb-2">üëÅÔ∏è Se√ß√£o 3 - Campana</h3>
                                <p class="text-sm text-purple-700 mb-3">
                                    A equipe realizou campana antes da abordagem? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section3"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve campana
                                    </button>
                                    <button
                                        id="btn-start-section3"
                                        class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve campana
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section3ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section3').addEventListener('click', startSection3);
                            document.getElementById('btn-skip-section3').addEventListener('click', () => skipSection(3));
                        } else if (currentSection === 3 && !boCompleted) {
                            const section4ButtonDiv = document.createElement('div');
                            section4ButtonDiv.id = 'section4-transition-card';
                            section4ButtonDiv.className = 'mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-center fade-in';
                            section4ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-orange-900 mb-2">üè† Se√ß√£o 4 - Entrada em Domic√≠lio</h3>
                                <p class="text-sm text-orange-700 mb-3">
                                    Houve entrada em domic√≠lio durante a ocorr√™ncia? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section4"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve entrada em domic√≠lio
                                    </button>
                                    <button
                                        id="btn-start-section4"
                                        class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve entrada em domic√≠lio
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section4ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section4').addEventListener('click', startSection4);
                            document.getElementById('btn-skip-section4').addEventListener('click', () => skipSection(4));
                        } else if (currentSection === 4 && !boCompleted) {
                            const section5ButtonDiv = document.createElement('div');
                            section5ButtonDiv.id = 'section5-transition-card';
                            section5ButtonDiv.className = 'mt-4 p-4 bg-pink-50 border border-pink-200 rounded-lg text-center fade-in';
                            section5ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-pink-900 mb-2">üéØ Se√ß√£o 5 - Fundada Suspeita</h3>
                                <p class="text-sm text-pink-700 mb-3">
                                    Houve abordagem por fundada suspeita (sem ve√≠culo, campana ou entrada em domic√≠lio)? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section5"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve fundada suspeita
                                    </button>
                                    <button
                                        id="btn-start-section5"
                                        class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve fundada suspeita
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section5ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section5').addEventListener('click', startSection5);
                            document.getElementById('btn-skip-section5').addEventListener('click', () => skipSection(5));
                        } else if (currentSection === 5 && !boCompleted) {
                            const section6ButtonDiv = document.createElement('div');
                            section6ButtonDiv.id = 'section6-transition-card';
                            section6ButtonDiv.className = 'mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg text-center fade-in';
                            section6ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-teal-900 mb-2">üí™ Se√ß√£o 6 - Rea√ß√£o e Uso da For√ßa</h3>
                                <p class="text-sm text-teal-700 mb-3">
                                    Houve resist√™ncia ou uso de for√ßa durante a abordagem? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section6"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve resist√™ncia
                                    </button>
                                    <button
                                        id="btn-start-section6"
                                        class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve resist√™ncia
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section6ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section6').addEventListener('click', startSection6);
                            document.getElementById('btn-skip-section6').addEventListener('click', () => skipSection(6));
                        } else if (currentSection === 6 && !boCompleted) {
                            const section7ButtonDiv = document.createElement('div');
                            section7ButtonDiv.id = 'section7-transition-card';
                            section7ButtonDiv.className = 'mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-center fade-in';
                            section7ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-amber-900 mb-2">üì¶ Se√ß√£o 7 - Apreens√µes e Cadeia de Cust√≥dia</h3>
                                <p class="text-sm text-amber-700 mb-3">
                                    Houve apreens√£o de drogas ou objetos ligados ao tr√°fico? Continue para a pr√≥xima se√ß√£o.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button
                                        id="btn-skip-section7"
                                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚è≠Ô∏è N√£o houve apreens√£o
                                    </button>
                                    <button
                                        id="btn-start-section7"
                                        class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚úÖ Sim, houve apreens√£o
                                    </button>
                                </div>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section7ButtonDiv);

                            // Event listeners para os bot√µes
                            document.getElementById('btn-start-section7').addEventListener('click', startSection7);
                            document.getElementById('btn-skip-section7').addEventListener('click', () => skipSection(7));
                        } else if (currentSection === 7 && !boCompleted) {
                            const section8ButtonDiv = document.createElement('div');
                            section8ButtonDiv.id = 'section8-transition-card';
                            section8ButtonDiv.className = 'mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-center fade-in';
                            section8ButtonDiv.innerHTML = `
                                <h3 class="font-bold text-indigo-900 mb-2">‚öñÔ∏è Se√ß√£o 8 - Condu√ß√£o e P√≥s-Ocorr√™ncia (√öLTIMA SE√á√ÉO)</h3>
                                <p class="text-sm text-indigo-700 mb-3">
                                    √öltima etapa: voz de pris√£o, direitos do preso, destino dos materiais. Finalize seu BO.
                                </p>
                                <div class="bg-amber-50 border border-amber-300 rounded-md p-3 mb-3">
                                    <p class="text-sm font-semibold text-amber-800">üì∑ ATEN√á√ÉO: Fotografar itens apreendidos e anexar no BO</p>
                                </div>
                                <button
                                    id="btn-start-section8"
                                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">
                                    ‚ñ∂Ô∏è Iniciar Se√ß√£o 8 (FINAL)
                                </button>
                            `;

                            // Inserir ap√≥s o container de textos gerados
                            generatedSectionsContainer.parentElement.appendChild(section8ButtonDiv);

                            // Event listener para o bot√£o
                            document.getElementById('btn-start-section8').addEventListener('click', startSection8);
                        } else if (currentSection === 8 && boCompleted) {
                            // CR√çTICO: Se√ß√£o 8 completa - Exibir card de conclus√£o final
                            const completionCard = document.createElement('div');
                            completionCard.id = 'bo-completion-card';
                            completionCard.className = 'mt-6 p-6 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-xl text-center fade-in';
                            completionCard.innerHTML = `
                                <div class="text-5xl mb-3">‚úÖ</div>
                                <h3 class="text-2xl font-bold text-green-900 mb-3">BO COMPLETO!</h3>
                                <p class="text-green-700 mb-4">Todas as 8 se√ß√µes foram preenchidas com sucesso.</p>
                                <div class="flex flex-col sm:flex-row justify-center gap-3">
                                    <button id="btn-copy-final" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                                        üìã Copiar BO Completo
                                    </button>
                                    <button id="btn-new-bo" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                        ‚ûï Iniciar Novo BO
                                    </button>
                                </div>
                            `;
                            generatedSectionsContainer.parentElement.appendChild(completionCard);

                            // Event listeners
                            document.getElementById('btn-copy-final').addEventListener('click', copyAllSections);
                            document.getElementById('btn-new-bo').addEventListener('click', () => {
                                clearDraft();
                                window.location.reload();
                            });
                        }

                        // üìç Scroll suave para o final da p√°gina (para ver texto gerado + bot√£o pr√≥xima se√ß√£o)
                        window.scrollTo({
                            top: document.documentElement.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 1000);
                } else {
                    // ‚úÖ SALVAR RASCUNHO ap√≥s resposta v√°lida (apenas se se√ß√£o N√ÉO est√° completa)
                    saveDraft();

                    updateSidebarStatus(currentQuestionStep, 'current');
                    addMessage(data.question, true, false, currentQuestionStep, data.event_id);
                    enableInput();
                }

            } catch (error) {
                removeLoading();
                addMessage('‚ùå Erro ao processar sua resposta. Tente novamente.');
                console.error(error);
                enableInput();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Draft modal event listeners
        draftContinueBtn.addEventListener('click', async () => {
            hideDraftModal();
            const draft = loadDraft();
            if (draft) {
                await restoreFromDraft(draft);
            } else {
                startSession();
            }
        });

        draftDiscardBtn.addEventListener('click', () => {
            hideDraftModal();
            clearDraft();
            startSession();
        });

        // ================================================================
        // INICIALIZA√á√ÉO
        // ================================================================
        
        // ============================================
        // INICIALIZA√á√ÉO - TESTE DOS COMPONENTES
        // ============================================

        // Vari√°veis globais para os novos componentes
        let progressBar = null;
        let sectionContainer = null;
        let currentSectionIndex = 0;

        window.addEventListener('load', () => {
            console.log('[App] Inicializando componentes...');

            // Verificar se sections.js carregou
            if (!window.SECTIONS_DATA) {
                console.error('[App] ERRO: SECTIONS_DATA n√£o encontrado. Verifique se sections.js est√° carregando.');
                return;
            }

            console.log(`[App] ${SECTIONS_DATA.length} se√ß√µes carregadas`);

            // ============================================
            // INICIALIZAR BARRA DE PROGRESSO
            // ============================================
            progressBar = new ProgressBar('progress-bar', {
                onSectionClick: (sectionId) => {
                    console.log('[App] Clicou na se√ß√£o:', sectionId);
                    navigateToSection(sectionId);
                }
            });

            // Expor para debug
            window.progressBar = progressBar;

            // ============================================
            // INICIALIZAR CONTAINER DE SE√á√ÉO
            // ============================================
            sectionContainer = new SectionContainer('section-container', {
                onAnswer: (questionId, answer) => {
                    console.log('[App] Resposta:', questionId, '=', answer);
                    // Atualizar progresso na barra
                    const section = SECTIONS_DATA[currentSectionIndex];
                    const answeredCount = Object.keys(sectionContainer.answers).length;
                    progressBar.updateProgress(section.id, answeredCount, section.questions.length);
                },
                onComplete: (sectionId, answers) => {
                    console.log('[App] Se√ß√£o completa:', sectionId, answers);
                    progressBar.markCompleted(sectionId);
                },
                onSkip: (sectionId) => {
                    console.log('[App] Se√ß√£o pulada:', sectionId);
                    progressBar.markSkipped(sectionId);
                    // Avan√ßar para pr√≥xima
                    navigateToSection(sectionId + 1);
                },
                onNavigateNext: (nextSectionId) => {
                    console.log('[App] Navegar para pr√≥xima se√ß√£o:', nextSectionId);
                    navigateToSection(nextSectionId);
                },
                onNavigateBack: () => {
                    console.log('[App] Voltar para se√ß√£o atual');
                    navigateToSection(currentSectionIndex + 1);
                }
            });

            // Expor para debug
            window.sectionContainer = sectionContainer;

            // ============================================
            // CARREGAR PRIMEIRA SE√á√ÉO
            // ============================================
            navigateToSection(1);

            console.log('[App] Inicializa√ß√£o completa!');
            console.log('[App] Use window.progressBar e window.sectionContainer para debug.');
        });

        /**
         * Navega para uma se√ß√£o espec√≠fica
         */
        async function navigateToSection(sectionId) {
            const sectionIndex = sectionId - 1;

            if (sectionIndex < 0 || sectionIndex >= SECTIONS_DATA.length) {
                console.warn('[App] Se√ß√£o inv√°lida:', sectionId);
                return;
            }

            const sectionData = SECTIONS_DATA[sectionIndex];

            console.log(`[App] Navegando para Se√ß√£o ${sectionId}: ${sectionData.name}`);

            // Fade out
            await sectionContainer.fadeOut();

            // Atualizar √≠ndice atual
            currentSectionIndex = sectionIndex;

            // Determinar se √© read-only (se√ß√£o anterior j√° completada)
            const isReadOnly = false; // Por enquanto, sempre edit√°vel

            // Carregar se√ß√£o
            sectionContainer.loadSection(sectionData, {
                state: 'in_progress',
                isReadOnly: isReadOnly
            });

            // Atualizar barra de progresso
            progressBar.setCurrentSection(sectionId);

            // Fade in
            await sectionContainer.fadeIn();
        }

        // ============================================
        // C√ìDIGO ANTIGO DESABILITADO
        // ============================================
        // As fun√ß√µes abaixo s√£o do sistema antigo e ser√£o removidas na Fase 4
        // Por enquanto, est√£o comentadas para evitar erros

        /*

        // Salvar rascunho antes de fechar p√°gina
        window.addEventListener('beforeunload', () => {
            // Apenas salvar rascunho se:
            // 1. Sess√£o existe
            // 2. H√° respostas salvas
            // 3. BO N√ÉO foi marcado como completo
            if (sessionId && Object.keys(answersState).length > 0 && !boCompleted) {
                console.log('[Draft] Salvando rascunho antes de fechar...');
                saveDraft();
            } else if (boCompleted) {
                console.log('[Draft] BO completo, n√£o salvando rascunho');
            }
        });
        */
    </script>
</body>
</html>
