<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BO Inteligente - Dashboard de Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">üìä Dashboard de Logs</h1>
                <p class="text-blue-200 text-sm">BO Inteligente v0.6.1</p>
            </div>
            <a href="index.html" class="text-blue-200 hover:text-white text-sm">
                ‚Üê Voltar ao Sistema
            </a>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4">
        <!-- Cards de Estat√≠sticas -->
        <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold text-blue-600" id="stat-total">-</div>
                <div class="text-gray-600 text-sm">Total de BOs</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold text-green-600" id="stat-completed">-</div>
                <div class="text-gray-600 text-sm">Conclu√≠dos</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold text-green-500" id="stat-positive">-</div>
                <div class="text-gray-600 text-sm">üëç Positivos</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold text-red-500" id="stat-negative">-</div>
                <div class="text-gray-600 text-sm">üëé Negativos</div>
            </div>
        </div>

        <!-- Lista de Sess√µes -->
        <div id="sessions-list" class="bg-white rounded-lg shadow">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">üìã Sess√µes de BO</h2>
            </div>
            <div id="sessions-content" class="p-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="animate-pulse">Carregando...</div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
            <div class="min-h-screen flex items-start justify-center p-4 pt-10">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full fade-in">
                    <div id="detail-content">
                        <!-- Conte√∫do carregado dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-200 border-t border-gray-300 p-4 text-center text-sm text-gray-600 mt-8">
        <p>Dashboard exclusivo para valida√ß√£o | Dados em tempo real da API</p>
    </footer>

    <script>
        // Configura√ß√£o da API
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8000'
            : 'https://bo-assistant-backend.onrender.com';

        // Elementos DOM
        const sessionsContent = document.getElementById('sessions-content');
        const detailModal = document.getElementById('detail-modal');
        const detailContent = document.getElementById('detail-content');

        // ============================================
        // FUN√á√ïES DE FORMATA√á√ÉO
        // ============================================

        function formatDate(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR') + ' √†s ' + 
                   date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDuration(startIso, endIso) {
            if (!startIso || !endIso) return '-';
            const start = new Date(startIso);
            const end = new Date(endIso);
            const diffMs = end - start;
            const diffSec = Math.floor(diffMs / 1000);
            const min = Math.floor(diffSec / 60);
            const sec = diffSec % 60;
            if (min > 0) {
                return `${min} min ${sec} seg`;
            }
            return `${sec} seg`;
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'completed':
                    return '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">‚úÖ Conclu√≠do</span>';
                case 'active':
                    return '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">‚è≥ Em andamento</span>';
                case 'abandoned':
                    return '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">‚ùå Abandonado</span>';
                default:
                    return '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-sm">' + status + '</span>';
            }
        }

        // ============================================
        // CARREGAR ESTAT√çSTICAS
        // ============================================

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-total').textContent = stats.total_bos || 0;
                document.getElementById('stat-completed').textContent = stats.completed_bos || 0;
                document.getElementById('stat-positive').textContent = stats.positive_feedbacks || 0;
                document.getElementById('stat-negative').textContent = stats.negative_feedbacks || 0;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // ============================================
        // CARREGAR LISTA DE SESS√ïES
        // ============================================

        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/api/logs?limit=50`);
                const data = await response.json();
                
                if (data.sessions.length === 0) {
                    sessionsContent.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <p class="text-4xl mb-2">üì≠</p>
                            <p>Nenhum BO registrado ainda</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="space-y-3">';
                
                for (const session of data.sessions) {
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                             onclick="openDetail('${session.bo_id}')">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                                <div>
                                    <div class="font-mono text-sm text-gray-600">${session.bo_id}</div>
                                    <div class="text-gray-500 text-sm">${formatDate(session.created_at)}</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    ${getStatusBadge(session.status)}
                                    <span class="text-green-600" title="Feedbacks positivos">üëç ${session.positive_count || 0}</span>
                                    <span class="text-red-600" title="Feedbacks negativos">üëé ${session.negative_count || 0}</span>
                                    <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        Ver detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                sessionsContent.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar sess√µes:', error);
                sessionsContent.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <p class="text-4xl mb-2">‚ö†Ô∏è</p>
                        <p>Erro ao carregar dados</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // ABRIR DETALHES DE UMA SESS√ÉO
        // ============================================

        async function openDetail(boId) {
            detailModal.classList.remove('hidden');
            detailContent.innerHTML = `
                <div class="p-8 text-center">
                    <div class="animate-pulse text-gray-500">Carregando detalhes...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/logs/${boId}`);
                const data = await response.json();
                
                renderDetail(data);
                
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                detailContent.innerHTML = `
                    <div class="p-8 text-center text-red-500">
                        <p>Erro ao carregar detalhes</p>
                        <button onclick="closeDetail()" class="mt-4 text-blue-600 hover:underline">Fechar</button>
                    </div>
                `;
            }
        }

        function closeDetail() {
            detailModal.classList.add('hidden');
        }

        // Fechar modal ao clicar fora
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                closeDetail();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetail();
            }
        });

        // ============================================
        // RENDERIZAR DETALHES (FORMATO TIMELINE)
        // ============================================

        function renderDetail(data) {
            const { session, events, feedbacks } = data;
            
            // Labels das perguntas - Se√ß√£o 1 e Se√ß√£o 2
            const questionLabels = {
                // Se√ß√£o 1: Contexto da Ocorr√™ncia
                '1.1': 'Data e hora do acionamento',
                '1.2': 'Composi√ß√£o da guarni√ß√£o e prefixo',
                '1.3': 'Natureza do empenho',
                '1.4': 'Ordem de servi√ßo / COPOM / DDU',
                '1.5': 'Local exato da ocorr√™ncia',
                '1.6': 'Hist√≥rico do local / fac√ß√£o',
                // Se√ß√£o 2: Abordagem a Ve√≠culo
                '2.0': 'Havia ve√≠culo?',
                '2.1': 'Marca e modelo do ve√≠culo',
                '2.2': 'Placa do ve√≠culo',
                '2.3': 'Ocupantes (gradua√ß√£o, nome, fun√ß√£o)',
                '2.4': 'Posi√ß√£o do ve√≠culo',
                '2.5': 'Atitude do condutor',
                '2.6': 'Descri√ß√£o da abordagem',
                '2.7': 'Motivo da suspei√ß√£o'
            };
            
            // Organizar feedbacks por event_id e por step
            const feedbacksByEventId = {};
            const feedbacksByStep = {};
            for (const fb of feedbacks) {
                // Por event_id
                if (fb.event_id) {
                    if (!feedbacksByEventId[fb.event_id]) {
                        feedbacksByEventId[fb.event_id] = [];
                    }
                    feedbacksByEventId[fb.event_id].push(fb);
                }
                // Por step (do contexto)
                if (fb.context?.step) {
                    if (!feedbacksByStep[fb.context.step]) {
                        feedbacksByStep[fb.context.step] = [];
                    }
                    feedbacksByStep[fb.context.step].push(fb);
                }
            }
            
            // Construir estrutura de perguntas com tentativas
            const questions = {};
            const generatedTexts = {}; // M√∫ltiplos textos (um por se√ß√£o)

            // Ordenar eventos por timestamp
            const sortedEvents = events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Processar eventos
            for (const event of sortedEvents) {
                if (event.event_type === 'answer_submitted') {
                    const step = event.data.step;
                    if (!questions[step]) {
                        questions[step] = { attempts: [], finalAnswer: null };
                    }
                    questions[step].attempts.push({
                        answer: event.data.answer,
                        isValid: event.data.is_valid,
                        eventId: event.event_id,
                        wasEdited: false,
                        errorMessage: null
                    });
                    if (event.data.is_valid) {
                        questions[step].finalAnswer = event.data.answer;
                    }
                }
                else if (event.event_type === 'validation_error') {
                    const step = event.data.step;
                    if (questions[step] && questions[step].attempts.length > 0) {
                        // Encontrar a tentativa correspondente
                        const attempt = questions[step].attempts.find(a => a.answer === event.data.answer);
                        if (attempt) {
                            attempt.errorMessage = event.data.error_message;
                        }
                    }
                }
                else if (event.event_type === 'answer_edited') {
                    const step = event.data.step;
                    if (!questions[step]) {
                        questions[step] = { attempts: [], finalAnswer: null };
                    }
                    questions[step].attempts.push({
                        answer: event.data.new_answer,
                        isValid: true,
                        eventId: event.event_id,
                        wasEdited: true,
                        errorMessage: null
                    });
                    questions[step].finalAnswer = event.data.new_answer;
                }
                else if (event.event_type === 'text_generated') {
                    // Determinar qual se√ß√£o baseado no contexto ou timestamp
                    const section = event.data.section || (Object.keys(generatedTexts).length === 0 ? 1 : 2);
                    generatedTexts[section] = {
                        text: event.data.generated_text,
                        time: event.data.generation_time_ms,
                        eventId: event.event_id
                    };
                }
            }
            
            // Renderizar HTML
            let html = `
                <!-- Header do Modal -->
                <div class="bg-blue-900 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold">üìã ${session.bo_id}</h2>
                            <div class="flex flex-wrap items-center gap-3 mt-2 text-sm text-blue-200">
                                ${getStatusBadge(session.status)}
                                <span>${formatDate(session.created_at)}</span>
                                ${session.completed_at ? `<span>‚Ä¢ Dura√ß√£o: ${formatDuration(session.created_at, session.completed_at)}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="closeDetail()" class="text-blue-200 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                </div>
                
                <!-- Timeline de Conversa -->
                <div class="p-4 space-y-4">
            `;
            
            // Mensagem de boas-vindas
            const welcomeFeedbacks = feedbacksByEventId['welcome'] || [];
            html += `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r">
                    <div class="text-gray-700">
                        Ol√°! Vou te ajudar a fazer o BO de tr√°fico de drogas, simples, t√©cnico e dentro da lei. 
                        Vou perguntar uma coisa por vez. Responda com o que voc√™ viu, sem arredondar. 
                        Se algo n√£o se aplicar, escreva "N√ÉO".
                        ${renderFeedbackBadges(welcomeFeedbacks)}
                    </div>
                </div>
            `;
            
            // Determinar quais se√ß√µes existem
            const hasSection1 = Object.keys(questions).some(step => step.startsWith('1.'));
            const hasSection2 = Object.keys(questions).some(step => step.startsWith('2.'));

            // Se√ß√£o 1: Contexto da Ocorr√™ncia
            if (hasSection1) {
                html += `
                    <div class="mt-4">
                        <h3 class="text-lg font-bold text-blue-800 mb-3 pb-2 border-b-2 border-blue-200">
                            üìã SE√á√ÉO 1 - Contexto da Ocorr√™ncia
                        </h3>
                    </div>
                `;

                const section1Steps = ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6'];
                for (const step of section1Steps) {
                    html += renderQuestion(step, questions, questionLabels, feedbacksByStep, feedbacksByEventId);
                }

                // Texto gerado da Se√ß√£o 1
                if (generatedTexts[1]) {
                    html += renderGeneratedText(1, generatedTexts[1], feedbacksByStep, feedbacksByEventId);
                }
            }

            // Se√ß√£o 2: Abordagem a Ve√≠culo
            if (hasSection2) {
                html += `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-green-800 mb-3 pb-2 border-b-2 border-green-200">
                            üöó SE√á√ÉO 2 - Abordagem a Ve√≠culo
                        </h3>
                    </div>
                `;

                const section2Steps = ['2.0', '2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7'];
                for (const step of section2Steps) {
                    html += renderQuestion(step, questions, questionLabels, feedbacksByStep, feedbacksByEventId);
                }

                // Texto gerado da Se√ß√£o 2
                if (generatedTexts[2]) {
                    html += renderGeneratedText(2, generatedTexts[2], feedbacksByStep, feedbacksByEventId);
                }
            }

            html += `
                </div>
            `;

            detailContent.innerHTML = html;
        }

        // Fun√ß√£o auxiliar para renderizar uma pergunta
        function renderQuestion(step, questions, questionLabels, feedbacksByStep, feedbacksByEventId) {
            const stepNum = step;
            const label = questionLabels[step];
            const question = questions[step];

            if (!label) return ''; // Pergunta n√£o existe no mapeamento

            let html = ''; // Inicializar vari√°vel html

            // Feedbacks da pergunta (t√≠tulo)
            const questionFeedbacks = [];
            // Buscar por step no context
            if (feedbacksByStep[step]) {
                questionFeedbacks.push(...feedbacksByStep[step].filter(f => !f.context?.message || f.context?.message === label));
            }
            // Buscar feedback da primeira pergunta
            if (step === '1.1') {
                const firstQFb = feedbacksByEventId['evt_first_question'] || [];
                questionFeedbacks.push(...firstQFb);
            }

            html += `
                <div class="border-l-4 border-gray-300 pl-4 py-2">
                    <div class="font-semibold text-gray-700 mb-2">
                        ${stepNum}. ${label}
                        ${renderFeedbackBadges(questionFeedbacks)}
                    </div>
            `;

            if (question && question.attempts.length > 0) {
                // Renderizar cada tentativa
                for (const attempt of question.attempts) {
                    // Feedbacks desta tentativa espec√≠fica
                    const attemptFeedbacks = feedbacksByEventId[attempt.eventId] || [];

                    if (attempt.isValid) {
                        html += `
                            <div class="ml-4 mb-2">
                                <span class="text-gray-800">"${attempt.answer}"</span>
                                <span class="text-green-600 ml-2">‚úÖ</span>
                                ${attempt.wasEdited ? '<span class="text-blue-500 ml-1" title="Resposta editada">‚úèÔ∏è</span>' : ''}
                                ${renderFeedbackBadges(attemptFeedbacks)}
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="ml-4 mb-2">
                                <div>
                                    <span class="text-gray-400">"${attempt.answer}"</span>
                                    <span class="text-red-500 ml-2">‚ùå</span>
                                    ${renderFeedbackBadges(attemptFeedbacks)}
                                </div>
                                ${attempt.errorMessage ? `
                                    <div class="text-red-600 text-sm mt-1 italic">
                                        ${attempt.errorMessage}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }
            } else {
                html += `
                    <div class="ml-4 text-gray-400 italic">N√£o respondida</div>
                `;
            }

            html += `</div>`;
            return html;
        }

        // Fun√ß√£o auxiliar para renderizar texto gerado
        function renderGeneratedText(sectionNum, generatedData, feedbacksByStep, feedbacksByEventId) {
            // Buscar feedbacks do texto gerado
            const textFeedbacks = feedbacksByStep['final'] || [];
            // Tamb√©m buscar por event_ids que contenham "text_generated"
            for (const [eventId, fbs] of Object.entries(feedbacksByEventId)) {
                if (eventId.includes('text_generated') || eventId === generatedData.eventId) {
                    textFeedbacks.push(...fbs);
                }
            }

            const sectionName = sectionNum === 1 ? 'SE√á√ÉO 1' : 'SE√á√ÉO 2';
            const bgColor = sectionNum === 1 ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200';

            return `
                <div class="mt-6 border-t pt-4">
                    <div class="font-semibold text-gray-800 mb-2">
                        üìÑ TEXTO GERADO - ${sectionName}
                        ${renderFeedbackBadges(textFeedbacks)}
                    </div>
                    <div class="text-gray-500 text-sm mb-2">
                        ‚è±Ô∏è Gerado em ${generatedData.time ? (generatedData.time / 1000).toFixed(1) + 's' : '-'}
                    </div>
                    <div class="${bgColor} border rounded-lg p-4">
                        <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${generatedData.text}</p>
                    </div>
                </div>
            `;
        }
        
        // Renderizar badges de feedback inline
        function renderFeedbackBadges(feedbacks) {
            if (!feedbacks || feedbacks.length === 0) return '';
            
            let html = '';
            for (const fb of feedbacks) {
                const icon = fb.feedback_type === 'positive' ? 'üëç' : 'üëé';
                const bgColor = fb.feedback_type === 'positive' ? 'bg-green-100' : 'bg-red-100';
                
                if (fb.user_message) {
                    html += `
                        <span class="${bgColor} px-2 py-0.5 rounded text-sm ml-2" title="${fb.user_message}">
                            ${icon} "${fb.user_message}"
                        </span>
                    `;
                } else {
                    html += `
                        <span class="${bgColor} px-1.5 py-0.5 rounded text-sm ml-1">
                            ${icon}
                        </span>
                    `;
                }
            }
            return html;
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================

        window.addEventListener('load', () => {
            loadStats();
            loadSessions();
        });

        // Auto-refresh a cada 30 segundos
        setInterval(() => {
            loadStats();
            loadSessions();
        }, 30000);
    </script>
</body>
</html>
